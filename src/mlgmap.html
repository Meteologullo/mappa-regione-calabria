<!DOCTYPE html>

<html lang="it">
<head>
<!-- Performance hints: preconnect -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://api.open-meteo.com" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org">
<style id="hideMarkerOpacity">.leaflet-marker-icon,.leaflet-marker-shadow{opacity:0;transition:opacity 0.15s linear;}</style>
<meta charset="utf-8"/>
<title>Mappa Meteo Calabria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" rel="stylesheet"/>
<script type="module">
async function caricaDatiOpenMeteo() {
  const richieste = stazioni
    .filter(s => s.openMeteo)
    .map(stazione => fetch(`https://api.open-meteo.com/v1/forecast?latitude=${stazione.lat}&longitude=${stazione.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`)
      .then(res => res.json())
      .then(data => ({
        stationId: stazione.stationId,
        temp: data.current.temperature_2m,
        tempVal: data.current.temperature_2m,
        pioggia: data.current.precipitation,
        umidita: data.current.relativehumidity_2m,
        raffica: data.current.wind_gusts_10m,
        percepita: (() => {
          const v = calcolaPercepita(data.current.temperature_2m, data.current.relativehumidity_2m, data.current.wind_speed_10m);
          return v != null ? v.toFixed(1) : "--";
        })(),
        percepitaVal: calcolaPercepita(data.current.temperature_2m, data.current.relativehumidity_2m, data.current.wind_speed_10m),
      }))
      .catch(e => {
        console.error("Errore nel fetch OpenMeteo per", stazione.stationId, e);
        return null;
      })
    );

  const risultati = await Promise.all(richieste);
  datiTabella.push(...risultati.filter(r => r !== null));
}

// === PATCH ESTREMI DA FIREBASE ===
firebase.database().ref('/estremi').once('value').then(snapshot => {
  window.extremiGiornalieri = snapshot.val() || {};
  // Puoi scegliere quale mostrare di default:
  visualizzaEstremi('max');
  visualizzaEstremi('min');
});

</script>
<script>
window.extremiGiornalieri = {}; // rimosso statico

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const colore = tipo === 'max' ? '#ff4444' : '#4466ff';
    const marker = markersById[d.stationId];
    if (valore && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        const textColor = getTextColorForBackground(colore);
        el.innerHTML = `<span style='color:${textColor};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = '#0099cc';
      }
    }
  });
}


function visualizzaPercepita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.percepitaVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.percepitaVal);
        const textColor = getTextColorForBackground(colore);
        el.innerHTML = `<span style='color:${textColor};'>${d.percepita}</span></div>`;
        el.style.backgroundColor = colore;
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:white;'>${d.raffica}</span>`;
        el.style.backgroundColor = '#666';
      }
    }
  });
}


function getColorUmidita(val) {
  const r = Math.round(255 - (val * 2.0));
  const g = Math.round(140 - (val * 0.8));
  const b = Math.round(50 + (val * 2.0));
  return `rgb(${r < 0 ? 0 : r},${g < 0 ? 0 : g},${b > 255 ? 255 : b})</div>`;
}

function getColorVento(val) {
  const r = Math.min(255, Math.round(val * 5));
  const g = Math.max(0, 255 - Math.round(val * 3));
  return `rgb(${r},${g},60)</div>`;
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const colore = getColor(valore);
    const marker = markersById[d.stationId];
    if (valore && marker) {
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorUmidita(d.umidita);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorVento(d.raffica);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.raffica}</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
      }
    }
  });
}


function getColorUmidita(val) {
  if (val <= 20) return "#ff5500";       // Secco intenso (arancio)
  if (val <= 40) return "#ffaa00";       // Secco moderato (giallo-arancio)
  if (val <= 60) return "#88cc44";       // Umido normale (verde chiaro)
  if (val <= 80) return "#44aaff";       // Umido (azzurro)
  return "#0055ff";                      // Molto umido (blu intenso)
}

function visualizzaEstremi(tipo) {
  datiTabella.forEach((d) => {
    const valore = getEstremoGiornaliero(d.stationId, tipo);
    const marker = markersById[d.stationId];
    if (typeof valore !== 'undefined' && marker) {
      const colore = getColor(valore);
      const el = marker.getElement();
      if (el) {
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${valore.toFixed(1)}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaAttuali() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!isNaN(d.tempVal) && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColor(d.tempVal);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.temp}°</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaUmidita() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.umidita !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorUmidita(d.umidita);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.umidita}%</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '40px';
        el.style.height = '40px';
      }
    }
  });
}

function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.raffica !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const colore = getColorVento(d.raffica);
        el.innerHTML = `<span style='color:${getTextColorForBackground(colore)};'>${d.raffica}</span></div>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
      }
    }
  });
}

</script>
<style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; background: #f4f4f4; }

#banner {
  background-color: #1a3a9b; /* Colore blu */
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 24px;
  font-weight: bold;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
}

#map {
  height: calc(100vh - 60px);
  width: 100%;
  border-bottom: 2px solid #ccc;
}

#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  padding: 20px;
}

.temperature-label {
  width: 26px !important;
  height: 26px !important;
  font-size: 13px !important;

  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-weight: bold;
  font-size: 15px;
  border: 2px solid #fff;
  color: #000;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.popup-title { font-size: 16px; font-weight: bold; }
.popup-sub { font-size: 13px; color: #666; margin-bottom: 6px; }
.popup-data { margin: 2px 0; font-size: 15px; }
.bold { font-weight: bold; }
.webcam-preview { width: 100%; max-height: 100px; object-fit: cover; margin-top: 5px; border-radius: 5px; }
.webcam-missing { font-size: 13px; color: #777; margin-top: 5px; text-align: center; }
.btn {
  display: inline-block;
  padding: 6px 10px;
  margin: 5px 5px 0 0;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  text-decoration: none;
  font-size: 13px;
}
.btn:hover { background-color: #0056b3; }
#popup-grafico {
  position: fixed;
  top: 10%;
  left: 5%;
  width: 90%;
  height: 80%;
  background: white;
  border: 2px solid #007bff;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  z-index: 10000;
}
#popup-grafico iframe { flex: 1; width: 100%; border: none; }
#popup-grafico .close-btn {
  background: red;
  color: white;
  padding: 5px;
  border: none;
  width: 100%;
  font-weight: bold;
  cursor: pointer;
}
a.btn { color: white !important; }
  
body {
  overflow-x: hidden;
}

#sidebar {
  pointer-events: auto;
  -ms-touch-action: none;
  touch-action: none;
}
#sidebar.sidebar-nascosta {
  transform: translateX(-50px);
  transition: transform 0.3s ease;
}

</style><style>
   .card.compact-extreme {
  font-size: 16px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fdfdfd;
  margin: 5px 0;
}
.card.compact-extreme span {
  font-size: 17px;
}
.card.compact-extreme .valore {
  font-size: 20px;
  color: #c00;
}
  </style><style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

html, body {
  scroll-padding-top: 60px; /* Compensa altezza banner fisso */
}
  </style><style>
   /* Sidebar compatta */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 36px;
  background-color: #fff;
  border-right: 1px solid #ccc;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 6px 0;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}
.sidebar-btn {
  background: none;
  border: none;
  padding: 4px 0;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #333;
  width: 100%;
  text-align: center;
  transition: background-color 0.2s;
}
.sidebar-btn:hover {
  background-color: #eef;
}

#slide-banner.show {
  right: 0 !important;
}
  </style><style>
   .sidebar-btn.attivo {
  box-shadow: inset 0 0 4px #00000099;
  font-weight: bold;
  border-left: 2px solid #000;
}
  </style><style>
   /* Modernizzazione barra laterale */
#sidebar {
  background: linear-gradient(to bottom, #ffffffcc, #f0f0f0cc);
  border-right: 1px solid #bbb;
  box-shadow: 2px 0 6px rgba(0,0,0,0.15);
  backdrop-filter: blur(4px);
}

/* Pulsanti moderni */
.sidebar-btn {
  border-radius: 6px;
  margin: 6px 0;
  font-weight: 600;
  font-size: 11px;
  background-color: #e6e6e6;
  color: #333;
  border: 1px solid #ccc;
  transition: all 0.2s ease;
}

.sidebar-btn:hover {
  background-color: #d0d0d0;
  transform: scale(1.05);
}

.sidebar-btn.attivo {
  background-color: #007bff !important;
  color: white !important;
  border-left: 3px solid #004a99;
  box-shadow: inset 0 0 5px #00000033;
}
  </style><style>
   .highlight-temp {
    font-size: 36px;
    font-weight: bold;
}
  </style><style>
   .filter-button.active {
    background-color: #337ab7;
    color: white;
}
  </style><style>
   .filtro-box {
  background: white;
  padding: 12px;
  border-radius: 10px;
  margin: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.filtro-box label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
}
.filtro-box select, .filtro-box input[type="checkbox"] {
  margin-top: 4px;
}
  </style><style>
   .card.compact-extreme {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #fefefe;
  margin: 6px 0;
  font-size: 15px;
}
.card.compact-extreme span.nome {
  font-weight: 600;
  flex: 1;
}
.card.compact-extreme span.valore {
  font-weight: bold;
  font-size: 16px;
  color: #c00;
  text-align: right;
}
  </style><style>
   #filtro-provincia, #filtro-ordinamento {
  margin-left: 6px;
  padding: 4px 8px;
  border-radius: 6px;
  background: #eef;
  font-weight: bold;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
  </style><style>
   #filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 4px 6px;
  border-radius: 5px;
  background: #eef;
  font-weight: bold;
  font-size: 14px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 6px;
}
.filtro-box label {
  font-size: 14px;
}
#filtro-mlg {
  transform: scale(0.9);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 500;
  color: #333;
  margin-top: 4px;
}
  </style><style>
   /* Rendi tutto molto più compatto */
#filtro-provincia, #filtro-ordinamento {
  margin: 0;
  padding: 2px 5px;
  border-radius: 4px;
  background: #eef;
  font-weight: bold;
  font-size: 13px;
}
.filtro-riga-select {
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  gap: 4px;
  font-size: 13px;
}
.filtro-box label {
  font-size: 13px;
}
#filtro-mlg {
  transform: scale(0.85);
  margin-right: 4px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 12.5px;
  font-weight: 500;
  color: #333;
  margin: 2px 0 0 0;
}
  </style><style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 11px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* MLG star size fix (assuming 'star-mlg' class or similar) */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
}
  </style><style>
   /* Marker circle and label size adjustment */
.temperature-label, .leaflet-marker-icon {
  width: 26px !important;
  height: 26px !important;
  font-size: 10px !important;
  line-height: 26px !important;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  white-space: nowrap;
  border-radius: 50%;
}

/* Visible and appropriately scaled MLG star icon */
.leaflet-marker-icon.star-mlg {
  width: 12px !important;
  height: 12px !important;
  transform: translate(-50%, -50%);
  display: inline-block !important;
  visibility: visible !important;
  z-index: 9999 !important;
}
  </style><style>
   #anteprima-live {
    background: linear-gradient(to bottom, #f8faff, #ffffff);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin: 16px auto;
    padding: 20px;
    max-width: 900px;
  }
  #anteprima-live h2 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 10px;
    color: #003366;
    text-align: center;
  }
  #preview-cards .card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    border: 1px solid #dde3ec;
    border-radius: 10px;
    padding: 12px 18px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    transition: transform 0.2s ease;
  }
  #preview-cards .card:hover {
    transform: scale(1.015);
  }
  #preview-cards .card .nome {
    font-weight: 600;
    font-size: 16px;
    color: #222;
  }
  #preview-cards .card .valore {
    font-size: 18px;
    font-weight: bold;
    color: #0055aa;
  }
  #preview-cards .card .btn {
    margin-left: auto;
    background-color: #007bff;
    border: none;
    padding: 6px 12px;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #preview-cards .card .btn:hover {
    background-color: #0056b3;
  }
  </style><style>
   #anteprima-live {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  background: rgba(255,255,255,0.95);
  border-top: 2px solid #ccc;
  padding: 14px 20px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  backdrop-filter: blur(6px);
}
  </style><style>
#map {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  height: auto;
  min-height: calc(100vh - 60px);
}
#anteprima-live {
  margin-top: auto;
}
</style><style>
/* MIGLIORAMENTO GRAFICO CARDS METEO PER MOBILE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 4px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 4px 6px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 6px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
}
}</style><style>
/* Stile migliorato per sezione anteprima testuale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 160px);
  left: 0;
  width: 100%;
  background: linear-gradient(to bottom, #f9fbff, #ffffff);
  z-index: 9999;
  padding: 24px 18px;
  box-shadow: 0 -2px 14px rgba(0,0,0,0.15);
  border-top: 2px solid #ccd6e0;
  border-radius: 18px 18px 0 0;
  font-family: "Segoe UI", sans-serif;
}

#anteprima-dati-testuali > div:first-child {
  font-weight: 600;
  font-size: 17px;
  color: #003366;
  text-align: center;
  margin-bottom: 16px;
}

.filtro-box {
  background: #f0f4f8;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  display: block;
  color: #222;
}

.filtro-box input[type="checkbox"] {
  margin-right: 8px;
  transform: scale(1.2);
}

.filtro-riga-select {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  font-size: 15px;
  margin-top: 10px;
}

.filtro-riga-select label {
  font-weight: 600;
}

#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 6px 10px;
  border-radius: 8px;
  background: #e6efff;
  border: 1px solid #aac4e6;
  font-size: 14px;
  font-weight: 500;
}

#filtro-prov-extremi-container {
  margin-top: 10px;
  background: #eef3f9;
  padding: 10px 12px;
  border-radius: 10px;
}

.mlg-label-small {
  font-size: 14px;
  color: #003366;
  font-weight: 500;
}

@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 18px 14px;
  }

  .filtro-box {
    padding: 10px;
  }

  .filtro-riga-select {
    flex-direction: column;
    align-items: flex-start;
  }

  #filtro-provincia, #filtro-ordinamento {
    width: 100%;
  }
}
</style><style>
/* SEZIONE ANTEPRIMA COMPLETAMENTE RIDISEGNATA PER MOBILE */

/* Contenitore principale */
#anteprima-dati-testuali {
  position: absolute;
  top: calc(100vh - 180px);
  left: 0;
  width: 100%;
  background: #f9fbff;
  z-index: 9999;
  padding: 26px 16px 20px;
  box-shadow: 0 -3px 14px rgba(0,0,0,0.12);
  border-top: 2px solid #b0c4de;
  border-radius: 20px 20px 0 0;
  font-family: "Segoe UI", sans-serif;
}

/* Titolo iniziale */
#anteprima-dati-testuali > div:first-child {
  font-weight: 700;
  font-size: 17px;
  color: #002b55;
  text-align: center;
  margin-bottom: 20px;
  margin-top: -6px;
}

/* Filtro box modernizzati */
.filtro-box {
  background: #eaf2f8;
  padding: 14px 16px;
  border-radius: 12px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.filtro-box label {
  font-weight: 500;
  font-size: 15px;
  color: #1a1a1a;
  display: flex;
  align-items: center;
}

.filtro-box input[type="checkbox"] {
  margin-right: 10px;
  transform: scale(1.1);
}

/* Riorganizzazione selettori */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 4px;
}

/* Select dropdown */
#filtro-provincia, #filtro-ordinamento, #filtro-provincia-estremi {
  padding: 7px 12px;
  border-radius: 10px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
  width: 100%;
}

/* Riquadro extra per selettore province estremi */
#filtro-prov-extremi-container {
  margin-top: 12px;
  background: #f3f7fc;
  padding: 12px;
  border-radius: 10px;
}

/* Etichetta "Tabella: dati in tempo reale" */
#filtro-mlg {
  display: none;
}
/* Rimosso ::before duplicato per "Tabella: dati in tempo reale" */
/* .mlg-label-small::before { */
/* content: "Tabella: dati in tempo reale";
  font-size: 15px;
  font-weight: 600;
  color: #003366;
  display: block;
  margin-top: 16px;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

/* Card meteo ottimizzate */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}

#tabella .card .intestazione {
  font-size: 17px;
  font-weight: 700;
  color: #003366;
  margin-bottom: 6px;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 8px 16px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  display: inline-block;
  padding: 5px 8px;
  background: #007bff;
  color: white;
  font-size: 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 10px;
}

/* Mobile fix */
@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 20px 12px;
  }

  .filtro-box {
    padding: 12px;
  }

  .filtro-riga-select {
    gap: 8px;
  }

  #tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 14px;
  padding: 20px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 15.5px;
  line-height: 1.7;
  transition: transform 0.2s ease;
}
}</style><style>
/* CORREZIONE POSIZIONE MLG + TESTO STATICO "Dati testuali in tempo reale" */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 4px 0;
}

/* Etichetta sostitutiva sopra i filtri */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}
</style><style>
/* FIX larghezza elementi e spostamento */
.filtro-riga-select {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
  margin-bottom: 14px;
}

.filtro-riga-select label {
  font-weight: 600;
  margin-bottom: 2px;
}

#filtro-provincia,
#filtro-ordinamento,
#filtro-provincia-estremi {
  width: 100%;
  max-width: 280px;
  padding: 7px 12px;
  border-radius: 8px;
  background: #e0edff;
  border: 1px solid #aac6f2;
  font-size: 14px;
  font-weight: 500;
}

/* Etichetta tabella spostata sopra */
#label-dati-realtime {
  font-size: 16px;
  font-weight: 600;
  color: #002b55;
  padding: 10px 14px;
  background: #ddeeff;
  border-radius: 10px;
  margin: 10px 0 18px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  text-align: center;
}

/* Checkbox filtro finale */
#filtro-mlg {
  margin-top: 16px;
  transform: scale(1.05);
  margin-right: 8px;
}
.mlg-label-small {
  display: flex;
  align-items: center;
  font-size: 14px;
  font-weight: 500;
  color: #003366;
  margin: 12px 0 8px;
}
</style><style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #bbcfe6;
  border-radius: 16px;
  padding: 22px 20px;
  margin-bottom: 18px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.05);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 100%;
  max-width: 680px;
  margin-left: auto;
  margin-right: auto;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 19px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 10px;
}
@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15px;
  }
  #tabella .card .intestazione {
    font-size: 17px;
  }
}</style><style>
/* MIGLIORAMENTO GRAFICO CARDS ORIGINALE */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 22px 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 16px;
  line-height: 1.7;
  transition: transform 0.2s ease;
  width: 95%;
  max-width: 840px;
}
#tabella .card:hover {
  transform: scale(1.015);
}
#tabella .card .intestazione {
  font-size: 20px;
  font-weight: 700;
  color: #002a4d;
  margin-bottom: 12px;
}
#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 18px;
  color: #333;
}
#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}
#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}
#tabella .card .badge {
  display: inline-block;
  padding: 5px 10px;
  background: #007bff;
  color: white;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  margin-top: 12px;
}

@media (max-width: 480px) {
  #tabella .card {
    padding: 18px 16px;
    font-size: 15.5px;
  }
  #tabella .card .intestazione {
    font-size: 18px;
  }
}</style><style>
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  margin: 20px auto;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  width: 95%;
  max-width: 100%;
  box-sizing: border-box;
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Responsive fix per schermi piccoli */
@media (max-width: 480px) {
  #tabella .card {
    padding: 16px 14px;
    font-size: 14.5px;
  }

  #tabella .card .intestazione {
    font-size: 16px;
  }

  #tabella .card .dati span {
    font-size: 13.5px;
  }

  #tabella .card .dati .valore {
    font-size: 14px;
  }
}</style><style>
/* Allinea le card a sinistra e sfrutta meglio lo spazio disponibile */
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  width: calc(50% - 16px);
  margin: 0;
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  font-size: 15.5px;
  line-height: 1.6;
  box-sizing: border-box;
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.015);
}

#tabella .card .intestazione {
  font-size: 18px;
  font-weight: bold;
  color: #003366;
  margin-bottom: 12px;
}

#tabella .card .dati {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 10px 14px;
  color: #333;
  width: 100%;
}

#tabella .card .dati span {
  display: flex;
  flex-direction: column;
  font-weight: 500;
  font-size: 14px;
}

#tabella .card .dati .valore {
  font-weight: bold;
  color: #0055aa;
  font-size: 15px;
}

#tabella .card .badge {
  margin-top: 12px;
  background: #007bff;
  color: white;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  font-weight: bold;
  display: inline-block;
}

/* Visualizzazione mobile: una sola colonna */
@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}</style><style>
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 16px;
  padding: 12px;
}

#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px);
  box-sizing: border-box;
}

@media (max-width: 600px) {
  #tabella .card {
    width: 100%;
  }
}
</style><style>
#tabella {
  padding-bottom: 260px; /* Evita sovrapposizione con la sezione fissa */
  display: flex !important;
  flex-wrap: wrap !important;
  justify-content: flex-start !important;
  align-items: flex-start !important;
  padding: 12px !important;
  gap: 16px !important;
}

#tabella .card {
  margin: 0 !important;
  width: calc(50% - 16px) !important;
  box-sizing: border-box !important;
  max-width: none !important;
}

@media (max-width: 600px) {
  #tabella .card {
    width: 100% !important;
  }
}
</style>
<style>
#anteprima-dati-testuali {
  background: #f5f9ff;
  border-top: 2px solid #1a3a9b;
  border-radius: 14px 14px 0 0;
  box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
  font-family: "Segoe UI", sans-serif;
  padding: 16px 12px 10px;
}

#anteprima-dati-testuali > div:first-child {
  font-weight: 700;
  font-size: 15px;
  color: #1a3a9b;
  text-align: center;
  margin-bottom: 12px;
}

#anteprima-dati-testuali label {
  font-size: 13.5px;
  color: #003366;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

#anteprima-dati-testuali input[type="checkbox"] {
  transform: scale(0.95);
}

.filtro-riga-combinata {
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: #e6efff;
  border: 1px solid #bcd0ee;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}

#filtro-provincia, #filtro-ordinamento {
  background: #ffffff;
  border: 1px solid #aac6f2;
  padding: 6px 8px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  width: 100%;
  color: #002a4d;
}

.filtro-riga-combinata label {
  margin: 0;
}

@media (max-width: 480px) {
  #anteprima-dati-testuali {
    padding: 14px 10px 8px;
  }

  #anteprima-dati-testuali label {
    font-size: 13px;
  }

  #filtro-provincia, #filtro-ordinamento {
    font-size: 12.5px;
  }
}

#anteprima-dati-testuali {
  margin-left: 40px;
}
</style>
<style>
@media (min-width: 600px) {
  body {
    padding-left: 60px !important;
  }
}
</style>
<style>
#tabella .card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #ffffff;
  border: 1px solid #dde3ec;
  border-radius: 10px;
  padding: 12px 18px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  transition: transform 0.2s ease;
  font-size: 15.5px;
  line-height: 1.6;
}

#tabella .card:hover {
  transform: scale(1.015);
}

#tabella .card .intestazione {
  font-weight: 600;
  font-size: 16px;
  color: #222;
}

#tabella .card .dati {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  color: #333;
}

#tabella .card .dati span {
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}

#tabella .card .dati .valore {
  font-weight: 600;
  color: #0055aa;
}

#tabella .card .badge {
  margin-left: auto;
  background-color: #007bff;
  border: none;
  padding: 6px 12px;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
</style>
<style>
/* Overlay watermark visibile sopra tutto ma non cliccabile */
.watermark-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  pointer-events: none;
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='180' height='28'><text x='0' y='20' font-size='12' fill='rgba(0,0,0,0.05)' font-family='Arial'>Meteo Lo Gullo Meteo Lo Gullo Meteo Lo Gullo</text></svg>");
  background-repeat: repeat;
  background-size: 180px 28px;
  mix-blend-mode: multiply;
}
</style>
<style>
/* Aspetto coerente con le card sottostanti */
#anteprima-dati-testuali {
  background: #ffffff;
  border-top: 2px solid #ccddee;
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.05);
  padding: 20px 16px;
  font-family: "Segoe UI", sans-serif;
  transition: background 0.3s ease;
}

/* Leggero margine negativo solo per unione visiva */
#tabella {
  margin-top: -6px;
  padding-top: 0;
}

/* Card coerenti come già impostato, mantenute flessibili */
#tabella .card {
  background: #ffffff;
  border: 1px solid #ccddee;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease;
}

#tabella .card:hover {
  transform: scale(1.01);
}
</style>
<!-- Fix: uniforma larghezza di tutte le card nella tabella -->
<style id="fix-card-dimensions">
  /* Forza ogni card ad occupare metà riga (con il gap già presente) */
  #tabella .card{
    flex: 0 0 calc(50% - 16px) !important;   /* base fissa e nessun ridimensionamento */
    width: calc(50% - 16px) !important;       /* stesso valore di fallback */
    max-width: none !important;               /* evita max‑width più piccole */
    margin: 0 !important;                     /* elimina centraggi automatici */
  }
  /* Mobile: una colonna piena */
  @media (max-width: 600px){
    #tabella .card{
      flex: 0 0 100% !important;
      width: 100% !important;
    }
  }
</style>
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet"/><script defer="" src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style id="webcam_amantea_fix">
/* Popup clipping */
.leaflet-popup-content{overflow:hidden;}

/* Webcam zoom via transform: horizontal 3×, recenter */
img.webcam-preview[src*="webcam_spiaggia_pulita"],
iframe.webcam-preview[src*="webcam_spiaggia_pulita"]{
  height:100px !important;
  width:100%  !important;
  transform:translateX(-10%) scaleX(3) !important; /* 3× larghezza, shift 1/3 a sinistra */
  transform-origin:center center !important;
  object-fit:contain !important; /* keep height */
  display:block;
}
</style>
<style id="mobile-popup-shrink">
/* Popup stazioni: versione compatta per telefoni */
@media (max-width: 520px){
  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip{
    max-width: 220px;
    padding: 4px;
  }
  .leaflet-popup-content{
    font-size: 12px !important;
    line-height: 1.3 !important;
    margin: 4px 6px !important;
  }
  .popup-title{ font-size: 14px !important; }
  .popup-sub{ font-size: 12px !important; }
  .popup-data{ font-size: 12px !important; }
}
</style>
<style id="mobile-popup-nowrap">
/* Pop‑up stazioni: no wrap ma dimensione moderata su schermi piccoli */
@media (max-width: 520px){
  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip{
    width: auto !important;       /* si adatta leggermente al testo */
    min-width: 220px !important;  /* non più piccolo del default */
    max-width: 300px !important;  /* resta comunque compatto */
  }
  .leaflet-popup-content{
    overflow-x: auto;             /* se necessario scroll orizzontale */
  }
  .popup-title,
  .popup-sub,
  .popup-data{
    white-space: nowrap !important; /* impedisce l'andata a capo */
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Infocard v8 -->
<style id="infocard-upgrade">
/* identical CSS as v7 */
#tabella{display:flex;flex-wrap:wrap;gap:14px;justify-content:flex-start;align-items:stretch;padding:0;}
#tabella > div:has(#riepilogo-testo){flex:0 0 100%!important;width:100%!important;}
#tabella > div:not(:has(#riepilogo-testo)){flex:0 0 230px;max-width:230px;background:#fff!important;border-radius:14px!important;box-shadow:0 3px 12px rgba(0,0,0,.07)!important;padding:14px 16px!important;display:flex!important;flex-direction:column!important;align-items:center!important;position:relative;transition:transform .25s ease,box-shadow .25s ease;}
#tabella > div:not(:has(#riepilogo-testo)):hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.12);}
#tabella > div:not(:has(#riepilogo-testo)) > div:first-child{font:600 .93rem/1.25 "Segoe UI",sans-serif!important;color:#012860!important;text-align:center;margin-bottom:6px!important;width:100%;}
#tabella > div:not(:has(#riepilogo-testo)) > div:nth-child(n+2){display:flex!important;flex-wrap:wrap!important;justify-content:center;gap:5px 8px!important;width:100%!important;}
#tabella .metric{font:500 .8rem/1.25 "Segoe UI",sans-serif!important;color:#333!important;white-space:nowrap;}
#tabella .main-metric{font:800 1.9rem/1.1 "Segoe UI",sans-serif!important;color:#111!important;width:100%!important;text-align:center;margin-bottom:4px!important;}
#tabella .metric-hidden{display:none!important;}
#tabella > div:not(:has(#riepilogo-testo)) .badge{position:absolute;top:12px;right:12px;font-size:.65rem;padding:3px 7px;background:#ff7b00;color:#fff;border-radius:9999px;box-shadow:0 2px 6px rgba(0,0,0,.14);}
@media(max-width:550px){#tabella{gap:12px;}#tabella > div:not(:has(#riepilogo-testo)){flex:0 0 calc(50% - 12px);max-width:none;min-width:150px;}#tabella .main-metric{font-size:1.5rem!important;}}
body{background:#f4f7fc!important;}
</style>
<!-- ChatGPT patch: ensure two cards per row also on small screens -->
<style id="chatgpt-mobile-2col">
@media (max-width: 600px){
  /* forza due card affiancate */
  #tabella > div:not(:has(#riepilogo-testo)),
  #tabella .card{
     flex: 0 0 50% !important;
     width: 50% !important;
     max-width: 50% !important;
  }
}
</style>
<!-- ChatGPT patch v6: force minimum two cards per row on very small screens -->
<style id="chatgpt-mobile-2col-v6">
@media (max-width: 640px){
  /* Each card container takes half the width minus small gap */
  #tabella > div:not(:has(#riepilogo-testo)){
     flex: 0 0 calc(50% - 8px) !important;
     max-width: calc(50% - 8px) !important;
     width: calc(50% - 8px) !important;
  }
}
</style>
<!-- ChatGPT patch v7: enforce two cards per row on mobile using CSS Grid -->
<style id="chatgpt-mobile-grid-v7">
  @media (max-width: 640px){
    #tabella{
      display: grid !important;
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 8px !important;
      align-items: stretch !important;
    }
    #tabella > div:not(:has(#riepilogo-testo)){
      width: 100% !important;
      margin: 0 !important;
      min-height: 200px !important; /* optional uniformity */
      box-sizing: border-box !important;
    }
  }
</style>
<!-- ChatGPT patch v8: final mobile two-column layout and uniform card sizing -->
<style id="chatgpt-mobile-grid-v8">
@media (max-width: 640px){
  #tabella{
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
  }
  #tabella > div:not(:has(#riepilogo-testo)){
    margin: 0 !important;
    width: auto !important;
    max-width: none !important;
    height: 100% !important;
    min-height: 200px !important;
    display: flex !important;
    flex-direction: column !important;
  }
}
</style>
<!-- ChatGPT patch v9: refine mobile grid and card uniformity -->
<style id="chatgpt-mobile-grid-v9">
@media (max-width: 640px){
  #tabella{
    width:100% !important;
    padding:0 !important;
    margin:0 auto !important;
    display:grid !important;
    grid-template-columns:repeat(2,1fr) !important;
    grid-auto-rows:1fr !important; /* rows equal height */
    gap:4px !important;
  }
  /* generic card */
  #tabella > div:not(:has(#riepilogo-testo)){
    margin:0 !important;
    width:100% !important;
    height:100% !important;
    box-sizing:border-box !important;
    display:flex !important;
    flex-direction:column !important;
    justify-content:space-between !important; /* forces footer at bottom */
    border-radius:12px !important;
    overflow:hidden !important;
  }
  /* ensure title zone always fixed height */
  #tabella > div:not(:has(#riepilogo-testo)) h3{
    margin:0 0 4px 0 !important;
    min-height:48px !important;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
  }
}
</style>
<!-- ChatGPT patch v10: remove header‑content gap, harmonize first card, tighten grid -->
<style id="chatgpt-mobile-grid-v10">
@media (max-width: 640px){
  #tabella{
    gap:2px !important;
  }
  #tabella > div:not(:has(#riepilogo-testo)){
    display:flex !important;
    flex-direction:column !important;
    justify-content:flex-start !important; /* eliminate big gap */
  }
  /* push last element (timestamp) to bottom */
  #tabella > div:not(:has(#riepilogo-testo)) > *:last-child{
    margin-top:auto !important;
  }
  /* tighter title spacing */
  #tabella > div:not(:has(#riepilogo-testo)) h3{
    margin:4px 2px 2px 2px !important;
    min-height:auto !important; /* allow natural height */
  }
}
</style>
<!-- ChatGPT patch v11: fix title‑data gap, uniform card layout, make riepilogo full‑width -->
<style id="chatgpt-mobile-grid-v11">
@media (max-width: 640px){
  /* Grid container */
  #tabella{
    width:100%!important;
    margin:0 auto!important;
    padding:0!important;
    display:grid!important;
    grid-template-columns:repeat(2,1fr)!important;
    gap:4px!important;
  }

  /* Summary box spans full width and keeps block flow */
  #tabella > div:has(#riepilogo-testo){
    grid-column:1 / -1!important;
    display:block!important;
  }

  /* Generic card layout */
  #tabella > div:not(:has(#riepilogo-testo)){
    box-sizing:border-box!important;
    display:flex!important;
    flex-direction:column!important;
    justify-content:flex-start!important;
    padding:8px!important;
    margin:0!important;
  }

  /* Title */
  #tabella > div:not(:has(#riepilogo-testo)) h3{
    margin:0 0 4px 0!important;
    text-align:center!important;
    line-height:1.2!important;
  }

  /* Ensure info rows compact & consistent */
  #tabella > div:not(:has(#riepilogo-testo)) > *:not(h3){
    margin:2px 0!important;
  }

  /* Keep timestamp at bottom */
  #tabella > div:not(:has(#riepilogo-testo)) > *:last-child{
    margin-top:auto!important;
  }
}
</style>
<!-- ChatGPT patch v12: zero title-gap, tighter metric spacing, consistent card style -->
<style id="chatgpt-mobile-grid-v12">
@media (max-width:640px){
  /* zero margin between title and metrics */
  #tabella > div:not(:has(#riepilogo-testo)) h3{
    margin:0 0 2px 0 !important;
    text-align:center!important;
    line-height:1.15!important;
  }

  /* override inline gap inside metrics flex wrapper */
  #tabella > div:not(:has(#riepilogo-testo)) > div:nth-child(2){
    gap:4px !important;
    align-items:flex-start!important;
  }

  /* remove extra left/right padding to maximize width in column */
  #tabella > div:not(:has(#riepilogo-testo)){
    padding:6px!important;
  }
}
</style>
<!-- ChatGPT uniform-card-patch v2 -->
<script id="uniform-card-patch-js">
window.addEventListener('load', () => {
  const css = `
/* === ChatGPT uniform-card-patch v2 === */
#tabella > div:not(:has(#riepilogo-testo)),
#tabella .card{
    flex: 0 0 230px !important;
    width: 230px !important;
    max-width: 230px !important;
    margin: 0 !important;
    background: #ffffff !important;
    border: 1px solid #ccddee !important;
    border-radius: 14px !important;
    box-shadow: 0 3px 12px rgba(0,0,0,.07) !important;
    padding: 14px 16px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    position: relative !important;
    box-sizing: border-box !important;
    transition: transform .25s ease, box-shadow .25s ease;
}
#tabella > div:not(:has(#riepilogo-testo)):hover,
#tabella .card:hover{
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,.12);
}
#tabella > div:not(:has(#riepilogo-testo)) > div:first-child,
#tabella .card > div:first-child{
    font: 600 .93rem/1.25 "Segoe UI", sans-serif !important;
    color: #012860 !important;
    text-align: center !important;
    margin-bottom: 6px !important;
    width: 100%;
}
#tabella > div:not(:has(#riepilogo-testo)) > div:nth-child(n+2),
#tabella .card > div:nth-child(n+2){
    display: flex !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
    gap: 5px 8px !important;
    width: 100% !important;
}
#tabella .metric,
#tabella > div:not(:has(#riepilogo-testo)) .metric{
    font: 500 .8rem/1.25 "Segoe UI", sans-serif !important;
    color: #333 !important;
    white-space: nowrap;
}
#tabella .main-metric,
#tabella > div:not(:has(#riepilogo-testo)) .main-metric{
    font: 800 1.9rem/1.1 "Segoe UI", sans-serif !important;
    color: #111 !important;
    width: 100% !important;
    text-align: center !important;
    margin-bottom: 4px !important;
}
#tabella .metric-hidden,
#tabella > div:not(:has(#riepilogo-testo)) .metric-hidden{
    display: none !important;
}
#tabella > div:not(:has(#riepilogo-testo)) .badge,
#tabella .card .badge{
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: .65rem;
    padding: 3px 7px;
    background: #ff7b00;
    color: #fff;
    border-radius: 9999px;
    box-shadow: 0 2px 6px rgba(0,0,0,.14);
}
@media(max-width:550px){
    #tabella{gap:12px!important;}
    #tabella > div:not(:has(#riepilogo-testo)),
    #tabella .card{
        flex: 0 0 calc(50% - 12px) !important;
        width: calc(50% - 12px) !important;
        max-width: calc(50% - 12px) !important;
    }
    #tabella > div:not(:has(#riepilogo-testo)) .main-metric,
    #tabella .card .main-metric{
        font-size: 1.5rem !important;
    }
}
`;
  const style = document.createElement('style');
  style.id = 'uniform-card-patch';
  style.textContent = css;
  document.head.appendChild(style);
});
</script>

<!-- ChatGPT mobile beautify v10 -->
<style id="top10-overlay-css-v10">
.top10-overlay{
  background:rgba(255,255,255,0.6) !important;
  backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,0.4) !important;
  border-radius:14px !important;
  box-shadow:0 8px 24px rgba(0,0,0,0.15) !important;
  font-family:"Helvetica Neue",Arial,sans-serif !important;
}
.top10-overlay div{
  line-height:1.25em;
}
@media(max-width:600px){
  .top10-overlay{
    width:95vw !important;
    max-height:65vh !important;
    padding:14px 18px !important;
  }
  .top10-overlay div{font-size:15px !important;}
}
</style>


<!-- ChatGPT sidebar order v11 -->
<style id="sidebar-order-v11">
#btnScreenshot{order:99!important;margin-top:auto;}
</style>


<!-- ChatGPT sidebar reorder v12 -->
<style id="sidebar-reorder-v12">
#btnScreenshot{
  order:98 !important;
  margin-top:0 !important;
}
#ordToggle{
  order:99 !important;
}
</style>


<!-- Patch trasparenza radar controls -->
<style id="radar-controls-transparent">
  /* Semi‑trasparenza e look meno invasivo */
  #radar-controls{
    background: rgba(255,255,255,0.45) !important;
    box-shadow: 0 0 6px rgba(0,0,0,0.2) !important;
    backdrop-filter: blur(4px);
  }
  /* Miglioramenti mobile */
  @media (max-width: 600px){
    #radar-controls{
      top: 72px !important;   /* subito sotto il banner */
      right: 6px !important;
      padding: 6px 8px !important;
    }
  }
</style>

<!-- ChatGPT FASTLOAD v2 2025-07-11 -->
<script type="module" id="fastload-20250711-v2">
(() => {
  const OM_MAX = 8;
  const WU_MAX = 4;
  const TIMEOUT = 12000;
  const CACHE_MS = 10 * 60e3;

  /* -------------------------------------------------
   *  Utility
   * ------------------------------------------------- */
  const ready = fn => {
    if (document.readyState === "complete" || document.readyState === "interactive") { fn(); }
    else document.addEventListener("DOMContentLoaded", fn, { once:true });
  };

  /* -------------------------------------------------
   * 1. Open‑Meteo  hook (waits for original function)
   * ------------------------------------------------- */
  ready(() => {
    const waitHook = () => {
      if (typeof window.caricaDatiOpenMeteo !== "function" || !Array.isArray(window.stazioni)) return false;

      const key = s => 'om_' + s.stationId;
      const read = s => {
        try {
          const j = localStorage.getItem(key(s));
          if (!j) return null;
          const { ts, data } = JSON.parse(j);
          return Date.now() - ts < CACHE_MS ? data : null;
        } catch { return null; }
      };
      const save = (s,d) => { try {localStorage.setItem(key(s), JSON.stringify({ts:Date.now(), data:d}));}catch{}; };

      const build = (s,d)=>({
        stationId:s.stationId,
        temp:d.current.temperature_2m,
        tempVal:d.current.temperature_2m,
        pioggia:d.current.precipitation,
        umidita:d.current.relativehumidity_2m,
        raffica:d.current.wind_gusts_10m,
        percepitaVal:(typeof calcolaPercepita==="function")
          ? calcolaPercepita(d.current.temperature_2m,d.current.relativehumidity_2m,d.current.wind_speed_10m)
          : null
      });

      async function fetchOM (s){
        const cached = read(s);
        if (cached) return build(s,cached);

        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), TIMEOUT);
        try{
          const url = \`https://api.open-meteo.com/v1/forecast?latitude=\${s.lat}&longitude=\${s.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=auto\`;
          const r = await fetch(url,{signal:ctrl.signal});
          if(!r.ok) throw new Error(r.status);
          const data = await r.json();
          save(s,data);
          return build(s,data);
        }finally{ clearTimeout(t); }
      }

      const orig = window.caricaDatiOpenMeteo;
      window.caricaDatiOpenMeteo = async () => {
        const list = window.stazioni.filter(st => st.openMeteo);
        const it = list[Symbol.iterator]();
        window.datiTabella = window.datiTabella || [];
        let running = 0;
        return new Promise(res=>{
          const next = () => {
            if (running>=OM_MAX) return;
            const {value:st,done} = it.next();
            if(done){ if(running===0) res(); return; }
            running++;
            fetchOM(st)
              .then(e=>{ if(e) window.datiTabella.push(e); })
              .catch(err=>console.warn("OM err",st?.stationId,err))
              .finally(()=>{ running--; next(); });
            if(running<OM_MAX) next();
          };
          next();
        });
      };
      console.info("Fastload‑v2: caricaDatiOpenMeteo hooked");
      return true;
    };
    if (!waitHook()) {
      const id = setInterval(() => { if (waitHook()) clearInterval(id); }, 50);
    }
  });

  /* -------------------------------------------------
   * 2. Weather Underground fetch queue + cache
   * ------------------------------------------------- */
  (function(){
    const origFetch = window.fetch;
    const q = [];
    let running = 0;
    const key=id=>'wu_'+id;
    const read=id=>{ try{const j=sessionStorage.getItem(key(id));if(!j)return null;const {ts,data}=JSON.parse(j);return Date.now()-ts<CACHE_MS?data:null;}catch{return null;} };
    const save=(id,d)=>{ try{sessionStorage.setItem(key(id),JSON.stringify({ts:Date.now(),data:d}));}catch{} };

    const schedule = req => {
      q.push(req);
      pump();
    };
    const pump = ()=>{
      if(running>=WU_MAX || !q.length) return;
      const {url, opts, resolve, reject, id} = q.shift();
      running++;
      origFetch(url,opts).then(r=>{
        if(id){
          r.clone().json().then(d=>save(id,d)).catch(()=>{});
        }
        resolve(r);
      }).catch(reject).finally(()=>{running--;pump();});
    };

    window.fetch = function(url,opts){
      if(typeof url === "string" && url.includes("/v2/pws/observations/current")){
        const id = /stationId=([A-Z0-9]+)/i.exec(url)?.[1];
        const cached = id && read(id);
        if(cached){
          return Promise.resolve(new Response(JSON.stringify(cached),{status:200,headers:{'Content-Type':'application/json'}}));
        }
        return new Promise((res,rej)=>schedule({url,opts,resolve:res,reject:rej,id}));
      }
      return origFetch(url,opts);
    };
  })();
})();
</script>


<style id="map-loader-style">
  #map.loading {
    filter: blur(2px);
    opacity: 0.4;
    pointer-events: none;
    transition: opacity 0.5s ease, filter 0.5s ease;
  }

  #map-loader-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 16px 24px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
    font-family: sans-serif;
  }

  #map-loader-banner .spinner {
    width: 24px;
    height: 24px;
    border: 4px solid #ccc;
    border-top-color: #1a3a9b;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  #map-loader-banner.hide {
    display: none;
  }
</style>

<style id="prevent-zoom">
  /* Evita lo zoom pinch sulle aree UI (sidebar, pannelli, popup),
     lasciando libero solo la mappa per il pinch‑zoom di Leaflet */
  @media (pointer: coarse) {
    #sidebar,
    #anteprima-dati-testuali,
    .leaflet-popup-content-wrapper {
      touch-action: pan-y;  /* consente lo scroll verticale ma blocca pinch */
    }
  }

/* Aggiornamento: estendo la protezione anche ai popup.
   Blocca il pinch Zoom fuori dalla mappa e fa sì che, con popup aperto,
   il pinch venga gestito solo dal layer Leaflet */
@media (pointer: coarse) {
  .leaflet-popup,
  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip-container {
    touch-action: none;   /* nessun pinch, nessun doppio‑tap zoom di pagina */
  }
}</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

</head>
<body>

<div id="map-loader-banner">
  <div class="spinner"></div>
  <div>Caricamento mappa...</div>
</div>

<div id="radar-controls" style="position: fixed; top: 120px; right: 10px; z-index: 2147483647; background: white; border-radius: 8px; padding: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.4); display: none; font-family: sans-serif;">
<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
<button onclick="playRadar()" title="Avvia animazione">▶️</button>
<button onclick="stopRadar()" title="Ferma animazione">⏹️</button>
<input id="radarSlider" max="0" min="0" oninput="sliderChangeRadar(this.value)" step="1" style="width: 140px;" type="range" value="0"/>
</div>
<div id="radar-time-label" style="font-size: 13px; color: #111; text-align: center;"></div>
</div>
<div id="radar-time-label" style="font-size: 13px; color: #111; text-align: center;"></div>
<!-- Sidebar Meteo -->
<div id="map-indicator" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:6px;font-size:14px;z-index:1003;pointer-events:none;opacity:0;transition:opacity 0.3s;"></div>
<div id="sidebar">
<button class="sidebar-btn" id="btnScreenshot" onclick="generaScreenshot()" title="Cattura e condividi">📸</button>
<button class="sidebar-btn" onclick="visualizzaAttuali()" style="background-color: #cccccc; color: black;" title="Temp attuale">T°C</button>
<button class="sidebar-btn" onclick="visualizzaEstremi('max')" style="background-color: #ff4d4d; color: white;" title="Temp max">MAX</button>
<button class="sidebar-btn" onclick="visualizzaEstremi('min')" style="background-color: #3399ff; color: white;" title="Temp min">MIN</button>
<button class="sidebar-btn" onclick="visualizzaUmidita()" style="background-color: #66ccff; color: white;" title="Umidità">UR%</button>
<button class="sidebar-btn" onclick="visualizzaPercepita()" style="background-color: #ff66aa; color: white;" title="Temp. percepita">PERC</button>
<button class="sidebar-btn" onclick="visualizzaRaffiche()" style="background-color: #ff9933; color: white;" title="Raffiche">RAF</button>
<button class="sidebar-btn" onclick="visualizzaPioggia()" style="background-color: #3399ff; color: white;" title="Pioggia">MM</button>
<button class="sidebar-btn" onclick="filtraSoloMLG()" style="background-color: #222; color: white;" title="Solo MLG">MLG</button>
<button class="sidebar-btn" onclick="toggleRadar()" style="background-color: #444; color: white;" title="Radar/Satellite">RAD</button>
<button class="sidebar-btn" onclick="location.reload();" style="background-color:#009688;color:white;" title="Ricarica pagina">REF</button>
<button class="sidebar-btn" id="btnPlot" onclick="togglePlot()" style="background:#8b00ff;color:#fff" title="Interpolazione">PLOT</button></div>
<!-- Striscia con la scritta Meteo Lo Gullo -->
<div id="banner">
  - Meteo Lo Gullo
</div>
<div id="radar-controls-container">
<div id="radar-time-label" style="margin-top: 4px; font-size: 12px; color: #333; text-align: center;"></div>
</div>
<div id="map" class="loading" style="">
</div>
<button onclick="playRadar()" style="margin-right: 5px;">▶️</button>
<button onclick="stopRadar()" style="margin-right: 5px;">⏹️</button>
<input id="radarSlider" max="0" min="0" oninput="sliderChangeRadar(this.value)" step="1" type="range" value="0"/>
<div id="mlg-label" style="
  position: fixed;
  top: 65px;
  right: 10px;
  background-color: #007bff;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 1002;
  display: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-size: 14px;
">
  FILTRO MLG ATTIVO
</div>
<section id="anteprima-dati-testuali" style="margin: 0; padding: 20px 16px; width: 100%; background: white; z-index: 9999; box-shadow: 0 -2px 8px rgba(0,0,0,0.2); border-radius: 20px 20px 0 0;">
<div style="text-align: center; font-weight: bold; font-size: 16px; color: #003366; margin-bottom: 14px;">
    Scorri per i dati testuali ↓
  </div>
<div style="background: #f0f8ff; padding: 12px; border-radius: 12px; margin-bottom: 12px;">
<label style="display: flex; align-items: center; gap: 10px; font-size: 15px;">
<input id="riepilogo-dettagliato" onchange="aggiornaTabella()" type="checkbox"/>
      Visualizza riepilogo meteo testuale
    </label>
</div>
<div style="background: #f0f8ff; padding: 12px; border-radius: 12px; margin-bottom: 18px;">
<label style="display: flex; align-items: center; gap: 10px; font-size: 15px;">
<input id="toggle-estremi-lista" onchange="toggleEstremiLista()" type="checkbox"/>
      Mostra estremi giornalieri
    </label>
</div>
<div class="filtro-riga-combinata">
<label for="filtro-provincia">Filtra per provincia:</label>
<select id="filtro-provincia" onchange="aggiornaTabella()">
<option value="">Tutte</option>
<option value="CS">Cosenza</option>
<option value="CZ">Catanzaro</option>
<option value="KR">Crotone</option>
<option value="VV">Vibo Valentia</option>
<option value="RC">Reggio Calabria</option>
</select>
<label for="filtro-ordinamento">Ordina per:</label>
<select id="filtro-ordinamento" onchange="aggiornaTabella()">
<option value="caldo">Stazione più calda (live)</option>
<option value="freddo">Stazione più fredda (live)</option>
<option value="raffica">Raffiche</option>
<option value="pioggia">Pioggia</option>
<option value="tmax">T. max più alta</option>
<option value="tmin">T. min più bassa</option>
</select>
<label class="mlg-label-small">
<input id="filtro-mlg" onchange="aggiornaTabella()" type="checkbox"/>
    Mostra solo stazioni MLG
  </label>
</div>
</section>
<div style="height: 260px;"></div>
<div id="tabella"></div>
<div id="popup-grafico">
<button class="close-btn" onclick="chiudiGrafico()">Chiudi</button>
<iframe id="grafico-frame" src=""></iframe>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js">













function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

</script>
<script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js">













function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

</script>
<script>


function calcolaDewPoint(T, RH) {
  if (isNaN(T) || isNaN(RH) || RH <= 0) return null;
  // Magnus formula
  const a = 17.27;
  const b = 237.7;
  const alpha = Math.log(RH/100) + (a * T) / (b + T);
  return (b * alpha) / (a - alpha);
}

function calcolaHumidex(T, RH) {
  if (isNaN(T) || isNaN(RH)) return null;
  const Td = calcolaDewPoint(T, RH);
  if (Td === null) return null;
  const e = 6.11 * Math.exp(5417.7530 * (1/273.15 - 1/(273.15 + Td)));
  return parseFloat((T + 0.5555 * (e - 10)).toFixed(1));
}

function calcolaHeatIndex_C(T, R) {
  if (isNaN(T) || isNaN(R)) return null;
  if (T < 10) return T; // per temperature basse restituiamo la temperatura reale
  const hi = -8.784695 + 1.61139411*T + 2.338549*R - 0.14611605*T*R - 0.012308094*T*T - 0.016424828*R*R + 0.002211732*T*T*R + 0.00072546*T*R*R - 0.000003582*T*T*R*R;
  return parseFloat(hi.toFixed(1));
}



/**
 * Wind‑Chill (°C) – formula NOAA valida per T ≤ 10 °C e vento ≥ 4,8 km/h.
 * T: temperatura in °C, V: velocità del vento in km/h
 */
function calcolaWindChill_C(T, V) {
  if (isNaN(T) || isNaN(V)) return T;
  if (T > 10 || V < 4.8) return parseFloat(T.toFixed(1));
  const wc = 13.12 + 0.6215 * T - 11.37 * Math.pow(V, 0.16) + 0.3965 * T * Math.pow(V, 0.16);
  return parseFloat(wc.toFixed(1));
}


function calcolaPercepita(T, RH, V) {
  if (isNaN(T)) return null;
  V = (typeof V === 'number' && !isNaN(V)) ? V : 0;

  // Temperature inferiori a 18 °C: consideriamo il vento (Wind‑Chill)
  if (T < 18) {
    return calcolaWindChill_C(T, V);
  }

  // Sopra usiamo l’Heat‑Index (afa)
  const hi = calcolaHeatIndex_C(T, RH);
  return hi != null ? hi : T;
}





function calcolaCondizioneTermica (temp, umidita, percepita) {
  if (isNaN(temp) || isNaN(umidita)) return "-";

  /* --------------------
   * 1. Descrizione base (solo temperatura)
   * -------------------- */
  let base;
  if (temp <= -10)       base = "Gelo intenso";
  else if (temp <= -5)   base = "Gelo";
  else if (temp <= 0)    base = "Freddo intenso";
  else if (temp <= 5)    base = "Freddo";
  else if (temp <= 15)   base = "Fresco";
  else if (temp <= 22)   base = "Gradevole";
  else if (temp <= 26)   base = "Molto gradevole";
  else if (temp <= 29)   base = "Tiepido";
  else if (temp <= 33)   base = "Caldo";
  else if (temp <= 37)   base = "Caldo intenso";
  else if (temp <= 42)   base = "Caldo estremo";
  else                   base = "Estremo";

  /* --------------------
   * 2. Modificatore legato a umidità / percezione
   * -------------------- */
  const diff = (!isNaN(percepita) ? percepita - temp : 0);
  let mod = "";

  if (temp >= 26) {  // situazioni calde
    if (umidita >= 70 || diff >= 7)       mod = "molto afoso";
    else if (umidita >= 60 || diff >= 4)  mod = "afoso";
  } else {            // situazioni fresche
    if (umidita < 30)                     mod = "secco";
    else if (umidita >= 60 && umidita <= 89) mod = "umido";
    else if (umidita >= 90)               mod = "molto umido";
  }

  // Se non c'è alcun modificatore (umidità neutra) restituiamo solo la base
  if (!mod) return base;

  /* --------------------
   * 3. Eliminazione ridondanze ("molto" ripetuto)
   * -------------------- */
  if (/^molto\b/i.test(base) && /^molto\b/i.test(mod)) {
    mod = mod.replace(/^molto\s+/i, "");
  }

  /* --------------------
   * 4. Composizione finale
   * -------------------- */
  return `${base} e ${mod}`;
}


const stazioni = [
  { nome: "Bianchi - Palinudo Staglio", mlg: true, lat: 39.11, lon: 16.42, quota: "830 m", provincia: "CS", regione: "Calabria", area: "Valle del Corace", stationId: "IBIANC4", apiKey: "2ccb91c2398a4f778b91c2398a4f772f", webcam: "", linkStazione: "https://esempio.it/stazioni/nuova-stazione-1" },
  { nome: "Cosenza - Vaglio Lise", mlg: true, lat: 39.31, lon: 16.27, quota: "208 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati sud", stationId: "ICOSEN11", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://www.meteologullo.com/stazione-cosenza-vaglio-lise" },
  { nome: "Amantea Spiaggia", mlg: true, lat: 39.13, lon: 16.07, quota: "0 m", provincia: "CS", regione: "Calabria", area: "Basso tirreno cosentino", stationId: "IAMANT7", apiKey: "a3f4ae4f9b6d46a4b4ae4f9b6d06a494", webcam: "https://meteologullo.github.io/mappamlg/webcam_spiaggia_pulita.html", linkStazione: "https://www.meteologullo.com/stazione-amantea-spiaggia" },
  { nome: "Monte Scuro - Celico", mlg: true, lat: 39.33, lon: 16.4, quota: "1643 m", provincia: "CS", regione: "Calabria", area: "Vetta della Sila Grande", stationId: "ICELIC3", apiKey: "2d12def7f4894eca92def7f4892eca99", webcam: "", linkStazione: "https://www.meteologullo.com/stazione-meteo-di-monte-scuro-celico" },
  { nome: "Cosenza - Campagnano", mlg: true, lat: 39.31, lon: 16.23, quota: "234 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati sud", stationId: "ICOSEN20", apiKey: "844d02e7e12049ef8d02e7e120b9ef68", webcam: "", linkStazione: "https://www.meteologullo.com/stazione-cosenza-campagnano" },
  { nome: "Mendicino - Tivolille Pasquali", mlg: true, lat: 39.28, lon: 16.2, quota: "431 m", provincia: "CS", regione: "Calabria", area: "Pre-Catena Costiera Interna", stationId: "IMENDI13", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://www.meteologullo.com/stazione-mendicino-tivolille" },
  { nome: "Casali del Manco - Morelli Soprana", mlg: true, lat: 39.28, lon: 16.29, quota: "389 m", provincia: "CS", regione: "Calabria", area: "collina Valle del Crati", stationId: "ICASAL40", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://www.meteologullo.com/stazione-casali-del-manco-morelli-soprana" },
  { nome: "Nuova Stazione 1", mlg: true, lat: 39.40, lon: 16.50, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Nuova Area", stationId: "INUST1", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/nuova-stazione-1" },
  { nome: "Catanzaro Centro", lat: 38.82, lon: 16.43, quota: "320 m", provincia: "CZ", regione: "Calabria", area: "Centro città", openMeteo: true, stationId: "CATCENTRO", webcam: "", linkStazione: "#" }
,
  { nome: "Reggio Calabria - Centro", lat: 38.11, lon: 15.65, quota: "31 m", provincia: "RC", regione: "Calabria", area: "Area dello Stretto", openMeteo: true, stationId: "REGCENTRO", webcam: "", linkStazione: "#" },
  { nome: "Rossano - Centro Storico", lat: 39.58, lon: 16.63, quota: "270 m", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "ROSSCENTRO", webcam: "", linkStazione: "#" },
  { nome: "Vibo Valentia - Monte Poro", lat: 38.63, lon: 16.05, quota: "710 m", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "VIBOPORO", webcam: "", linkStazione: "#" },
  { nome: "Locri Marina", lat: 38.25, lon: 16.26, quota: "12 m", provincia: "RC", regione: "Calabria", area: "Costa Ionica Reggina", openMeteo: true, stationId: "LOCRIMARINA", webcam: "", linkStazione: "#" },
  { nome: "San Giovanni in Fiore", lat: 39.26, lon: 16.68, quota: "1049 m", provincia: "CS", regione: "Calabria", area: "Altopiano Silano", openMeteo: true, stationId: "SGFIORE", webcam: "", linkStazione: "#" },
  { nome: "Crotone Porto", lat: 39.08, lon: 17.12, quota: "8 m", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CROPOR", webcam: "", linkStazione: "#" },
  { nome: "Lamezia Terme - Sant'Eufemia", lat: 38.91, lon: 16.24, quota: "15 m", provincia: "CZ", regione: "Calabria", area: "Piana di Lamezia", openMeteo: true, stationId: "LAMSANTEUF", webcam: "", linkStazione: "#" },
  { nome: "Scalea - Centro", lat: 39.81, lon: 15.79, quota: "25 m", provincia: "CS", regione: "Calabria", area: "Alto Tirreno Cosentino", openMeteo: true, stationId: "SCALEACENTRO", webcam: "", linkStazione: "#" },
  { nome: "Taverna - Parco Nazionale Sila Piccola", lat: 39.02, lon: 16.68, quota: "880 m", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "TAVSILAPIC", webcam: "", linkStazione: "#" },
  { nome: "Isola di Capo Rizzuto", lat: 38.96, lon: 17.09, quota: "75 m", provincia: "KR", regione: "Calabria", area: "Capo Rizzuto", openMeteo: true, stationId: "ISOCAPORIZ", webcam: "", linkStazione: "#" },
,
  { nome: "Cirò Marina", lat: 39.37, lon: 17.12, quota: "25 m", provincia: "KR", regione: "Calabria", area: "Alto Ionio Crotonese", openMeteo: true, stationId: "CIROMARINA", webcam: "", linkStazione: "#" },
  { nome: "Cariati", lat: 39.5, lon: 16.96, quota: "30 m", provincia: "CS", regione: "Calabria", area: "Basso Ionio cosentino", openMeteo: true, stationId: "CARIATI", webcam: "", linkStazione: "#" },
  { nome: "Petilia Policastro", lat: 39.13, lon: 16.77, quota: "436 m", provincia: "KR", regione: "Calabria", area: "Marchesato Crotonese", openMeteo: true, stationId: "PETILIA", webcam: "", linkStazione: "#" },
  { nome: "Tropea", lat: 38.68, lon: 15.9, quota: "61 m", provincia: "VV", regione: "Calabria", area: "Costa degli Dei", openMeteo: true, stationId: "TROPEA", webcam: "", linkStazione: "#" },
  { nome: "Gerace", lat: 38.27, lon: 16.23, quota: "500 m", provincia: "RC", regione: "Calabria", area: "Collina Ionica alto Reggino", openMeteo: true, stationId: "GERACE", webcam: "", linkStazione: "#" },
  { nome: "Spezzano della Sila", lat: 39.30, lon: 16.33, quota: "800 m", provincia: "CS", regione: "Calabria", area: "Pre-Sila Grande cosentina", openMeteo: true, stationId: "SPEZSILA", webcam: "", linkStazione: "#" },
  { nome: "Paola", lat: 39.37, lon: 16.03, quota: "154 m", provincia: "CS", regione: "Calabria", area: "Tirreno Cosentino", openMeteo: true, stationId: "PAOLA", webcam: "", linkStazione: "#" },
  { nome: "Belvedere Marittimo", lat: 39.61, lon: 15.86, quota: "150 m", provincia: "CS", regione: "Calabria", area: "Alto Tirreno Cosentino", openMeteo: true, stationId: "BELVEDERE", webcam: "", linkStazione: "#" },
  { nome: "Mormanno", lat: 39.88, lon: 15.98, quota: "850 m", provincia: "CS", regione: "Calabria", area: "Pollino", openMeteo: true, stationId: "MORMANNO", webcam: "", linkStazione: "#" },
  { nome: "Soverato", lat: 38.68, lon: 16.54, quota: "20 m", provincia: "CZ", regione: "Calabria", area: "Costa Ionica basso Catanzarese", openMeteo: true, stationId: "SOVERATO", webcam: "", linkStazione: "#" },
  { nome: "Palmi", lat: 38.36, lon: 15.85, quota: "228 m", provincia: "RC", regione: "Calabria", area: "Costa Viola", openMeteo: true, stationId: "PALMI", webcam: "", linkStazione: "#" },
  { nome: "Serrastretta", lat: 39.01, lon: 16.4, quota: "820 m", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", openMeteo: true, stationId: "SERRASTRETTA", webcam: "", linkStazione: "#" },
  { nome: "Santa Severina", lat: 39.21, lon: 16.97, quota: "326 m", provincia: "KR", regione: "Calabria", area: "Marchesato crotonese", openMeteo: true, stationId: "SSSEVERINA", webcam: "", linkStazione: "#" },
  { nome: "Badolato Marina", lat: 38.6, lon: 16.55, quota: "10 m", provincia: "CZ", regione: "Calabria", area: "Costa Ionica basso Catanzarese", openMeteo: true, stationId: "BADO_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Delianuova", lat: 38.2, lon: 15.88, quota: "600 m", provincia: "RC", regione: "Calabria", area: "Pre-Aspromonte Occidentale", openMeteo: true, stationId: "DELIANUOVA", webcam: "", linkStazione: "#" },
  {"nome": "Rende", "lat": 39.3306, "lon": 16.2078, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "RENDE", "webcam": "", "linkStazione": "#"},
  {"nome": "Montalto Uffugo", "lat": 39.4165, "lon": 16.1985, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "MONTALTO_UFFUGO", "webcam": "", "linkStazione": "#"},{"nome": "Bisignano", "lat": 39.50, "lon": 16.27, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Collina alta Valle del Crati", "openMeteo": true, "stationId": "MONGRASSANO_SCALO", "webcam": "", "linkStazione": "#"},
  {"nome": "Tarsia", "lat": 39.58, "lon": 16.3167, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Crati", "openMeteo": true, "stationId": "TARSIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Castrovillari", "lat": 39.8167, "lon": 16.2, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Pollino", "openMeteo": true, "stationId": "CASTROVILLARI", "webcam": "", "linkStazione": "#"},
  {"nome": "Sibari", "lat": 39.6833, "lon": 16.5333, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sibaritide", "openMeteo": true, "stationId": "SIBARI", "webcam": "", "linkStazione": "#"},
  {"nome": "Villapiana", "lat": 39.84, "lon": 16.45, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sibaritide", "openMeteo": true, "stationId": "VILLAPIANA", "webcam": "", "linkStazione": "#"},
  {"nome": "Camigliatello Silano", "lat": 39.3306, "lon": 16.4492, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "CAMIGLIATELLO_SILANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monte Curcio", "lat": 39.317, "lon": 16.42, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "MONTE_CURCIO", "webcam": "", "linkStazione": "#"},
  {"nome": "Botte Donato", "lat": 39.2833, "lon": 16.45, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Grande", "openMeteo": true, "stationId": "BOTTE_DONATO", "webcam": "", "linkStazione": "#"},
  {"nome": "Daltolia", "lat": 39.033, "lon": 16.388, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Savuto", "openMeteo": true, "stationId": "DALTOLIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Rogliano", "lat": 39.1581, "lon": 16.3723, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle del Savuto", "openMeteo": true, "stationId": "ROGLIANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Girifalco", "lat": 38.8, "lon": 16.4167, "quota": "ND", "provincia": "CZ", "regione": "Calabria", "area": "Pre-Serre", "openMeteo": true, "stationId": "GIRIFALCO", "webcam": "", "linkStazione": "#"},
  {"nome": "Vibo Valentia", "lat": 38.6749, "lon": 16.1027, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "VIBO_VALENTIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Capo Vaticano", "lat": 38.6278, "lon": 15.8415, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Costa degli Dei", "openMeteo": true, "stationId": "CAPO_VATICANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Rosarno", "lat": 38.4886, "lon": 15.9738, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "ROSARNO", "webcam": "", "linkStazione": "#"},
  {"nome": "Gioia Tauro", "lat": 38.4236, "lon": 15.8996, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "GIOIA_TAURO", "webcam": "", "linkStazione": "#"},
  {"nome": "Pellaro", "lat": 38.01, "lon": 15.633, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Area dello Stretto", "openMeteo": true, "stationId": "PELLARO", "webcam": "", "linkStazione": "#"},
  {"nome": "Villa San Giovanni", "lat": 38.2131, "lon": 15.6414, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Area dello Stretto", "openMeteo": true, "stationId": "VILLA_SAN_GIOVANNI", "webcam": "", "linkStazione": "#"},
  {"nome": "Melito di Porto Salvo", "lat": 37.9167, "lon": 15.7333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "MELITO_DI_PORTO_SALVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Brancaleone", "lat": 37.95, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "BRANCALEONE", "webcam": "", "linkStazione": "#"},
  {"nome": "Africo Nuovo", "lat": 38.0167, "lon": 16.1333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "AFRICO_NUOVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Bovalino", "lat": 38.15, "lon": 16.2, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Reggina", "openMeteo": true, "stationId": "BOVALINO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monasterace Marina", "lat": 38.4333, "lon": 16.5333, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Costa Ionica Meridionale", "openMeteo": true, "stationId": "MONASTERACE_MARINA", "webcam": "", "linkStazione": "#"},
  {"nome": "Mongiana", "lat": 38.5167, "lon": 16.3, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "MONGIANA", "webcam": "", "linkStazione": "#"},
  {"nome": "Fabrizia", "lat": 38.5, "lon": 16.3667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "FABRIZIA", "webcam": "", "linkStazione": "#"},
  {"nome": "Nardodipace", "lat": 38.4833, "lon": 16.4, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Serre Vibonesi", "openMeteo": true, "stationId": "NARDODIPACE", "webcam": "", "linkStazione": "#"},
  {"nome": "Polistena", "lat": 38.4167, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "POLISTENA", "webcam": "", "linkStazione": "#"},
  {"nome": "Natoli Nuovo", "lat": 38.5167, "lon": 16.0833, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "NATOLI_NUOVO", "webcam": "", "linkStazione": "#"},
  {"nome": "Cittanova", "lat": 38.3167, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Piana di Gioia Tauro", "openMeteo": true, "stationId": "CITTANOVA", "webcam": "", "linkStazione": "#"},
  {"nome": "Zungri", "lat": 38.6167, "lon": 15.9333, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "ZUNGRI", "webcam": "", "linkStazione": "#"},
  {"nome": "Spilinga", "lat": 38.6, "lon": 15.8833, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "SPILINGA", "webcam": "", "linkStazione": "#"},
  {"nome": "Pizzo", "lat": 38.7333, "lon": 16.1667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Costa Tirrenica Vibonese", "openMeteo": true, "stationId": "PIZZO", "webcam": "", "linkStazione": "#"},
  {"nome": "Monterosso Calabro", "lat": 38.6333, "lon": 16.2667, "quota": "ND", "provincia": "VV", "regione": "Calabria", "area": "Entroterra Vibonese", "openMeteo": true, "stationId": "MONTEROSSO_CALABRO", "webcam": "", "linkStazione": "#"},
  {"nome": "Cutro", "lat": 39.0167, "lon": 17.0833, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Collina Crotonese", "openMeteo": true, "stationId": "CUTRO", "webcam": "", "linkStazione": "#"},
  {"nome": "Capocolonna", "lat": 39.0167, "lon": 17.1333, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "CAPOCOLONNA", "webcam": "", "linkStazione": "#"},
  {"nome": "Marina di Strongoli", "lat": 39.3, "lon": 17.1167, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "MARINA_DI_STRONGOLI", "webcam": "", "linkStazione": "#"},
  {"nome": "Acerenthia - Camigliano", "lat": 39.2667, "lon": 17.0, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Collina Crotonese", "openMeteo": true, "stationId": "ACERENTHIA_-_CAMIGLIANO", "webcam": "", "linkStazione": "#"},
  {"nome": "Torretta di Crucoli", "lat": 39.4167, "lon": 17.0333, "quota": "ND", "provincia": "KR", "regione": "Calabria", "area": "Costa Ionica Crotonese", "openMeteo": true, "stationId": "TORRETTA_DI_CRUCOLI", "webcam": "", "linkStazione": "#"},
  {"nome": "Longobucco", "lat": 39.45, "lon": 16.65, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Greca", "openMeteo": true, "stationId": "LONGOBUCCO", "webcam": "", "linkStazione": "#"},
  {"nome": "Acri", "lat": 39.5, "lon": 16.3833, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Sila Greca", "openMeteo": true, "stationId": "ACRI", "webcam": "", "linkStazione": "#"},
  {"nome": "Roccaforte del Greco", "lat": 38.0167, "lon": 15.85, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Aspromonte", "openMeteo": true, "stationId": "ROCCAFORTE_DEL_GRECO", "webcam": "", "linkStazione": "#"},
  {"nome": "San Luca", "lat": 38.1333, "lon": 16.0833, "quota": "ND", "provincia": "RC", "regione": "Calabria", "area": "Aspromonte", "openMeteo": true, "stationId": "SAN_LUCA", "webcam": "", "linkStazione": "#"},
  {"nome": "Santa Caterina dello Ionio", "lat": 38.55, "lon": 16.5667, "quota": "ND", "provincia": "CZ", "regione": "Calabria", "area": "Costa Ionica Meridionale", "openMeteo": true, "stationId": "SANTA_CATERINA_DELLO_IONIO", "webcam": "", "linkStazione": "#"},
  {"nome": "San Sosti", "lat": 39.66, "lon": 16.02, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle dell'Esaro", "openMeteo": true, "stationId": "SANSOSTI", "webcam": "", "linkStazione": "#"},
  {"nome": "Altomonte", "lat": 39.7, "lon": 16.1333, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Valle dell'Esaro", "openMeteo": true, "stationId": "ALTOMONTE", "webcam": "", "linkStazione": "#"},
  {"nome": "Roseto Capo Spulico", "lat": 39.9667, "lon": 16.5833, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Alto Ionio Cosentino", "openMeteo": true, "stationId": "ROSETO_CAPO_SPULICO", "webcam": "", "linkStazione": "#"},
  {"nome": "Trebisacce", "lat": 39.87, "lon": 16.53, "quota": "ND", "provincia": "CS", "regione": "Calabria", "area": "Alto Ionio Cosentino", "openMeteo": true, "stationId": "TREBISACCE", "webcam": "", "linkStazione": "#"}
,
  { nome: "Rende - Quattromiglia", lat: 39.353702, lon: 16.242313, quota: "ND", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati sud", openMeteo: true, stationId: "RENDE_QUATTR", webcam: "", linkStazione: "#" },
  { nome: "Torano Castello - Sartano", lat: 39.49, lon: 16.21, quota: "90", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati", openMeteo: true, stationId: "LUZZI_PETRINI", webcam: "", linkStazione: "#" },
  { nome: "Luzzi - Petrini", lat: 39.446816, lon: 16.28, quota: "ND", provincia: "CS", regione: "Calabria", area: "Media Valle del Crati", openMeteo: true, stationId: "LUZZI_CENTRO", webcam: "", linkStazione: "#" },
  { nome: "Lattarico", lat: 39.464303, lon: 16.138027, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Catena costiera interna nord", openMeteo: true, stationId: "LATTARICO", webcam: "", linkStazione: "#" },
  { nome: "Rota Greca", lat: 39.467, lon: 16.117, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Catena costiera interna nord", openMeteo: true, stationId: "ROTA_GRECA", webcam: "", linkStazione: "#" },
  { nome: "Lattarico - Piretto", lat: 39.467, lon: 16.133, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Catena Costiera interna nord", openMeteo: true, stationId: "LATTARICO_PIRETTO", webcam: "", linkStazione: "#" },
  { nome: "Cassano all'Ionio", lat: 39.783, lon: 16.317, quota: "ND", provincia: "CS", regione: "Calabria", area: "Piana di Sibari centrale", openMeteo: true, stationId: "CASSANO_IONIO", webcam: "", linkStazione: "#" },
  { nome: "Sibari", lat: 39.74, lon: 16.45, quota: "ND", provincia: "CS", regione: "Calabria", area: "Piana di Sibari orientale", openMeteo: true, stationId: "SIBARI", webcam: "", linkStazione: "#" },
  { nome: "Terranova da Sibari", lat: 39.6575, lon: 16.3398, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina Piana di Sibari sud", openMeteo: true, stationId: "TERRANOVA_SIBARI", webcam: "", linkStazione: "#" },
  { nome: "Tarsia", lat: 39.62311, lon: 16.27337, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina Valle del Crati nord", openMeteo: true, stationId: "TARSIA", webcam: "", linkStazione: "#" },
  { nome: "Roggiano Gravina", lat: 39.61786, lon: 16.16173, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina Valle dell'Esaro", openMeteo: true, stationId: "ROGGIANO", webcam: "", linkStazione: "#" },
  { nome: "San Pietro in Guarano", lat: 44.52, lon: 13.48, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Sila cosentina", openMeteo: true, stationId: "SANPIETRO_GUARANO", webcam: "", linkStazione: "#" },
  { nome: "Marano Marchesato", lat: 39.316974, lon: 16.174788, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Catena costiera interna sud", openMeteo: true, stationId: "MARANO_MARCH", webcam: "", linkStazione: "#" },
  { nome: "Carolei", lat: 39.25, lon: 16.217, quota: "ND", provincia: "CS", regione: "Calabria", area: "Serre cosentine", openMeteo: true, stationId: "CAROLEI", webcam: "", linkStazione: "#" },
  { nome: "Dipignano", lat: 39.237886, lon: 16.25324, quota: "ND", provincia: "CS", regione: "Calabria", area: "Serre cosentine", openMeteo: true, stationId: "DIPIGNANO", webcam: "", linkStazione: "#" },
  { nome: "Mangone", lat: 39.205635, lon: 16.332584, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Savuto", openMeteo: true, stationId: "MANGONE", webcam: "", linkStazione: "#" },
  { nome: "Altilia", lat: 39.1286, lon: 16.2532, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Savuto", openMeteo: true, stationId: "ALTILIA", webcam: "", linkStazione: "#" },
  { nome: "Aiello Calabro", lat: 39.117215, lon: 16.166775, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina basso tirreno cosentino", openMeteo: true, stationId: "AIELLO_CALABRO", webcam: "", linkStazione: "#" },
  { nome: "Lamezia Terme", lat: 38.966667, lon: 16.299999, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Piana di Lamezia", openMeteo: true, stationId: "LAMEZIA_TERME", webcam: "", linkStazione: "#" },
  { nome: "Falerna", lat: 39.003346, lon: 16.172041, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa tirrenica catanzarese", openMeteo: true, stationId: "FALERNA", webcam: "", linkStazione: "#" },
  { nome: "San Lucido", lat: 39.309956, lon: 16.051827, quota: "ND", provincia: "CS", regione: "Calabria", area: "Costa tirrenica cosentina", openMeteo: true, stationId: "SAN_LUCIDO", webcam: "", linkStazione: "#" },
  { nome: "Guardia Piemontese", lat: 39.467, lon: 16.0, quota: "ND", provincia: "CS", regione: "Calabria", area: "Costa alto tirreno cosentino", openMeteo: true, stationId: "GUARDIA_PIEM", webcam: "", linkStazione: "#" },
  { nome: "Vena di Maida", lat: 38.888685, lon: 16.407462, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", openMeteo: true, stationId: "VENA_DI_MAIDA", webcam: "", linkStazione: "#" },
  { nome: "Settingiano", lat: 38.910024, lon: 16.514955, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", openMeteo: true, stationId: "SETTINGIANO", webcam: "", linkStazione: "#" },
  { nome: "Caraffa di Catanzaro", lat: 38.88194, lon: 16.4875, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", openMeteo: true, stationId: "CARAFFA", webcam: "", linkStazione: "#" },
  { nome: "Catanzaro Lido", lat: 38.8303, lon: 16.6278, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa Ionica Catanzarese", openMeteo: true, stationId: "CATANZARO_LIDO", webcam: "", linkStazione: "#" },
  { nome: "Simeri Mare", lat: 38.865607, lon: 16.697665, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa Ionica Catanzarese", openMeteo: true, stationId: "SIMERI_MARE", webcam: "", linkStazione: "#" },
  { nome: "Sorbo San Basile", lat: 39.01889, lon: 16.56944, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Pre-Sila catanzarese", openMeteo: true, stationId: "SORBO_BASILE", webcam: "", linkStazione: "#" },
  { nome: "Steccato di Cutro", lat: 38.938014, lon: 16.916678, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa del basso ionio crotonese", openMeteo: true, stationId: "STECCATO_CUTRO", webcam: "", linkStazione: "#" },
  { nome: "Cropani", lat: 38.967, lon: 16.783, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa ionica alto catanzarese", openMeteo: true, stationId: "CROPANI", webcam: "", linkStazione: "#" },
  { nome: "Botricello Superiore", lat: 38.93199, lon: 16.85831, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Collina alto ionio catanzarese", openMeteo: true, stationId: "BOTRICELLO", webcam: "", linkStazione: "#" },
  { nome: "Acconia", lat: 38.83585, lon: 16.2653, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Piana di Lamezia", openMeteo: true, stationId: "ACCONIA", webcam: "", linkStazione: "#" },
  { nome: "Curinga", lat: 38.8281, lon: 16.31344, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Valle dell'Amato", openMeteo: true, stationId: "CURINGA", webcam: "", linkStazione: "#" },
  { nome: "Maida", lat: 38.8588, lon: 16.3628, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", openMeteo: true, stationId: "MAIDA", webcam: "", linkStazione: "#" },
  { nome: "Francavilla Angitola", lat: 38.783, lon: 16.267, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "FRANCAVILLA_ANGITOLA", webcam: "", linkStazione: "#" },
  { nome: "San Pietro Lametino", lat: 38.869082, lon: 16.277958, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Collina della Piana di Lamezia", openMeteo: true, stationId: "SANPIETRO_LAM", webcam: "", linkStazione: "#" },
  { nome: "Squillace", lat: 38.780585, lon: 16.513228, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa ionica del basso catanzarese", openMeteo: true, stationId: "SQUILLACE", webcam: "", linkStazione: "#" },
  { nome: "Montepaone Lido", lat: 38.728733, lon: 16.541554, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Costa ionica del basso catanzarese", openMeteo: true, stationId: "MONTEPAONE_LIDO", webcam: "", linkStazione: "#" },
  { nome: "San Vito sullo Ionio", lat: 38.710368, lon: 16.409777, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Entroterra del basso ionio catanzarese", openMeteo: true, stationId: "SANVITO_IONIO", webcam: "", linkStazione: "#" },
  { nome: "Monterosso Calabro", lat: 38.71792, lon: 16.291973, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "MONTEROSSO_CALABRO", webcam: "", linkStazione: "#" },
  { nome: "Chiaravalle Centrale", lat: 38.680996, lon: 16.411957, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Entroterra del basso ionio catanzarese", openMeteo: true, stationId: "CHIARAVALLE_C", webcam: "", linkStazione: "#" },
  { nome: "Verbicaro", lat: 39.756, lon: 15.916, quota: "ND", provincia: "CS", regione: "Calabria", area: "Pre-Catena Costiera marittima nord", openMeteo: true, stationId: "VERBICARO", webcam: "", linkStazione: "#" },
  { nome: "Orsomarso", lat: 39.799, lon: 15.908, quota: "ND", provincia: "CS", regione: "Calabria", area: "Catena Costiera marittima nord", openMeteo: true, stationId: "ORSOMARSO", webcam: "", linkStazione: "#" },
  { nome: "Cirella", lat: 39.703, lon: 15.823, quota: "ND", provincia: "CS", regione: "Calabria", area: "Alto Tirreno cosentino", openMeteo: true, stationId: "CIRELLA", webcam: "", linkStazione: "#" },
  { nome: "Praia a Mare", lat: 39.909, lon: 15.778, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "PRAIA_A_MARE", webcam: "", linkStazione: "#" },
  { nome: "Laino Borgo", lat: 39.95, lon: 15.97, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Mercure", openMeteo: true, stationId: "LAINO_BORGO", webcam: "", linkStazione: "#" },
  { nome: "Papasidero", lat: 39.87, lon: 15.90, quota: "ND", provincia: "CS", regione: "Calabria", area: "Borgo dell'alto tirreno", openMeteo: true, stationId: "PAPASIDERO", webcam: "", linkStazione: "#" },
  { nome: "Acquaformosa", lat: 39.736, lon: 16.078, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "ACQUAFORMOSA", webcam: "", linkStazione: "#" },
  { nome: "Saracena", lat: 39.849, lon: 16.11, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "SARACENA", webcam: "", linkStazione: "#" },
  { nome: "Cerchiara di Calabria", lat: 39.883, lon: 16.4, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "CERCHIARA_DI_CALABRIA", webcam: "", linkStazione: "#" },
  { nome: "San Lorenzo Bellizzi", lat: 39.88, lon: 16.33, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "SAN_LORENZO_BELLIZZI", webcam: "", linkStazione: "#" },
  { nome: "Plataci", lat: 39.90, lon: 16.43, quota: "ND", provincia: "CS", regione: "Calabria", area: "Parco Nazionale del Pollino", openMeteo: true, stationId: "PLATACI", webcam: "", linkStazione: "#" },
  { nome: "Albidona", lat: 39.937, lon: 16.525, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "ALBIDONA", webcam: "", linkStazione: "#" },
  { nome: "Alessandria del Carretto", lat: 39.984, lon: 16.338, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "ALESSANDRIA_DEL_CARRETTO", webcam: "", linkStazione: "#" },
  { nome: "Terranova di Pollino", lat: 40.032, lon: 16.23, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "TERRANOVA_DI_POLLINO", webcam: "", linkStazione: "#" },
  { nome: "Castroregio", lat: 39.987, lon: 16.51, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CASTROREGIO", webcam: "", linkStazione: "#" },
  { nome: "Oriolo", lat: 40.05, lon: 16.434, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "ORIOLO", webcam: "", linkStazione: "#" },
  { nome: "Montegiordano", lat: 40.04, lon: 16.53, quota: "ND", provincia: "CS", regione: "Calabria", area: "Alto ionio cosentino", openMeteo: true, stationId: "MONTEGIORDANO", webcam: "", linkStazione: "#" },
  { nome: "Nocara", lat: 40.09, lon: 16.48, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "NOCARA", webcam: "", linkStazione: "#" },
  { nome: "Rocca Imperiale", lat: 40.10, lon: 16.58, quota: "ND", provincia: "CS", regione: "Calabria", area: "Alto ionio cosentino", openMeteo: true, stationId: "ROCCA_IMPERIALE", webcam: "", linkStazione: "#" },
  { nome: "Apollinara", lat: 39.70, lon: 16.41, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "APOLLINARA", webcam: "", linkStazione: "#" },
  { nome: "Cantinella", lat: 39.66, lon: 16.44, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CANTINELLA", webcam: "", linkStazione: "#" },
  { nome: "Corigliano Scalo", lat: 39.618, lon: 16.509, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CORIGLIANO_SCALO", webcam: "", linkStazione: "#" },
  { nome: "San Giorgio Albanese", lat: 39.58, lon: 16.45, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "SAN_GIORGIO_ALBANESE", webcam: "", linkStazione: "#" },
  { nome: "San Demetrio Corone", lat: 39.562, lon: 16.51, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "SAN_DEMETRIO_CORONE", webcam: "", linkStazione: "#" },
  { nome: "Cozzo Carbonaro", lat: 39.46, lon: 16.20, quota: "ND", provincia: "CS", regione: "Calabria", area: "Alta Valle del Crati", openMeteo: true, stationId: "COZZO_CARBONARO", webcam: "", linkStazione: "#" },
  { nome: "Taverna di Montalto Uffugo", lat: 39.415, lon: 16.246, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "TAVERNA_DI_MONTALTO_UFFUGO", webcam: "", linkStazione: "#" },
  { nome: "Rose", lat: 39.394, lon: 16.232, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina della media Valle del Crati", openMeteo: true, stationId: "ROSE", webcam: "", linkStazione: "#" },
  { nome: "San Vincenzo la Costa", lat: 39.374, lon: 16.162, quota: "ND", provincia: "CS", regione: "Calabria", area: "Catena Costiera interna", openMeteo: true, stationId: "SAN_VINCENZO_LA_COSTA", webcam: "", linkStazione: "#" },
  { nome: "Lago", lat: 39.16, lon: 16.16, quota: "600", provincia: "CS", regione: "Calabria", area: "Serre Cosentine", openMeteo: true, stationId: "LAGO", webcam: "", linkStazione: "#" },
  { nome: "San Mango d'Aquino", lat: 39.027, lon: 16.217, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Collina della Valle del Savuto", openMeteo: true, stationId: "SAN_MANGO_DAQUINO", webcam: "", linkStazione: "#" },
  { nome: "Panetti", lat: 39.01, lon: 16.30, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina del Monte Reventino", openMeteo: true, stationId: "PANETTI", webcam: "", linkStazione: "#" },
  { nome: "Cicala", lat: 39.02, lon: 16.416, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Pre-Sila catanzarese", openMeteo: true, stationId: "CICALA", webcam: "", linkStazione: "#" },
  { nome: "Panettieri", lat: 39.079, lon: 16.423, quota: "ND", provincia: "CS", regione: "Calabria", area: "Monte Reventino", openMeteo: true, stationId: "PANETTIERI", webcam: "", linkStazione: "#" },
  { nome: "Sellia", lat: 38.832, lon: 16.517, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Collina dell'alto ionio catanzarese", openMeteo: true, stationId: "SELLIA", webcam: "", linkStazione: "#" },
  { nome: "Pianopoli", lat: 38.957, lon: 16.319, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Istmo di Marcellinara", openMeteo: true, stationId: "PIANOPOLI", webcam: "", linkStazione: "#" },
  { nome: "Gizzeria", lat: 38.937, lon: 16.148, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Alto tirreno catanzarese", openMeteo: true, stationId: "GIZZERIA", webcam: "", linkStazione: "#" },
  { nome: "Soveria Simeri", lat: 38.97, lon: 16.659, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Collina dell'alto ionio catanzarese", openMeteo: true, stationId: "SOVERIA_SIMERI", webcam: "", linkStazione: "#" },
  { nome: "Mesoraca", lat: 39.096, lon: 16.789, quota: "ND", provincia: "KR", regione: "Calabria", area: "Pre-Sila catanzarese", openMeteo: true, stationId: "MESORACA", webcam: "", linkStazione: "#" },
  { nome: "San Mauro Marchesato", lat: 39.126, lon: 16.859, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "SAN_MAURO_MARCHESATO", webcam: "", linkStazione: "#" },
  { nome: "Marcedusa", lat: 39.024, lon: 16.858, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "MARCEDUSA", webcam: "", linkStazione: "#" },
  { nome: "Papanice", lat: 39.118, lon: 16.981, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "PAPANICE", webcam: "", linkStazione: "#" },
  { nome: "Capo Colonna", lat: 39.016, lon: 17.135, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CAPO_COLONNA", webcam: "", linkStazione: "#" },
  { nome: "Le Cannella", lat: 38.946, lon: 17.074, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "LE_CANNELLA", webcam: "", linkStazione: "#" },
  { nome: "Le Castella", lat: 38.906, lon: 17.01, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "LE_CASTELLA", webcam: "", linkStazione: "#" },
  { nome: "San Floro", lat: 38.899, lon: 16.486, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "SAN_FLORO", webcam: "", linkStazione: "#" },
  { nome: "Borgia", lat: 38.882, lon: 16.507, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "BORGIA", webcam: "", linkStazione: "#" },
  { nome: "Vallefiorita", lat: 38.778, lon: 16.49, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "VALLEFIORITA", webcam: "", linkStazione: "#" },
  { nome: "Palermiti", lat: 38.71, lon: 16.422, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "PALERMITI", webcam: "", linkStazione: "#" },
  { nome: "Petrizzi", lat: 38.637, lon: 16.474, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "PETRIZZI", webcam: "", linkStazione: "#" },
  { nome: "San Sostene", lat: 38.65, lon: 16.487, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "SAN_SOSTENE", webcam: "", linkStazione: "#" },
  { nome: "Brognaturo", lat: 38.575, lon: 16.373, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "BROGNATURO", webcam: "", linkStazione: "#" },
  { nome: "Badolato", lat: 38.578, lon: 16.556, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "BADOLATO", webcam: "", linkStazione: "#" },
  { nome: "Serra San Bruno", lat: 38.583, lon: 16.316, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "SERRA_SAN_BRUNO", webcam: "", linkStazione: "#" },
  { nome: "Arena", lat: 38.576, lon: 16.157, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "ARENA", webcam: "", linkStazione: "#" },
  { nome: "Monsoreto", lat: 38.521, lon: 16.163, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "MONSORETO", webcam: "", linkStazione: "#" },
  { nome: "Paravati", lat: 38.6, lon: 16.084, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "PARAVATI", webcam: "", linkStazione: "#" },
  { nome: "Mileto", lat: 38.606, lon: 16.067, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "MILETO", webcam: "", linkStazione: "#" },
  { nome: "Briatico", lat: 38.72, lon: 15.949, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "BRIATICO", webcam: "", linkStazione: "#" },
  { nome: "Zambrone", lat: 38.695, lon: 15.959, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "ZAMBRONE", webcam: "", linkStazione: "#" },
  { nome: "Caria", lat: 38.638, lon: 15.958, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "CARIA", webcam: "", linkStazione: "#" },
  { nome: "Maierato", lat: 38.697, lon: 16.111, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "MAIERATO", webcam: "", linkStazione: "#" },
  { nome: "Vibo Marina", lat: 38.721, lon: 16.127, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "VIBO_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Nicotera", lat: 38.533, lon: 15.933, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "NICOTERA", webcam: "", linkStazione: "#" },
  { nome: "San Calogero", lat: 38.53, lon: 16.033, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "SAN_CALOGERO", webcam: "", linkStazione: "#" },
  { nome: "San Ferdinando", lat: 38.483, lon: 15.899, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SAN_FERDINANDO", webcam: "", linkStazione: "#" },
  { nome: "Taurianova", lat: 38.354, lon: 16.03, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "TAURIANOVA", webcam: "", linkStazione: "#" },
  { nome: "Oppido Mamertina", lat: 38.351, lon: 15.986, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "OPPIDO_MAMERTINA", webcam: "", linkStazione: "#" },
  { nome: "Siderno", lat: 38.27, lon: 16.294, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SIDERNO", webcam: "", linkStazione: "#" },
  { nome: "Marina di Gioiosa Ionica", lat: 38.3, lon: 16.318, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MARINA_DI_GIOIOSA_IONICA", webcam: "", linkStazione: "#" },
  { nome: "Roccella Ionica", lat: 38.327, lon: 16.398, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "ROCCELLA_IONICA", webcam: "", linkStazione: "#" },
  { nome: "Marina di Caulonia", lat: 38.389, lon: 16.463, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MARINA_DI_CAULONIA", webcam: "", linkStazione: "#" },
  { nome: "Riace Marina", lat: 38.483, lon: 16.566, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "RIACE_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Villaggio Trepitò", lat: 38.386, lon: 16.453, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "VILLAGGIO_TREPITÒ", webcam: "", linkStazione: "#" },
  { nome: "Santa Cristina d'Aspromonte", lat: 38.275, lon: 15.954, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SANTA_CRISTINA_DASPROMONTE", webcam: "", linkStazione: "#" },
  { nome: "Antonimina", lat: 38.195, lon: 16.097, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "ANTONIMINA", webcam: "", linkStazione: "#" },
  { nome: "Ardore", lat: 38.23, lon: 16.171, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "ARDORE", webcam: "", linkStazione: "#" },
  { nome: "Molochio", lat: 38.28, lon: 16.01, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MOLOCHIO", webcam: "", linkStazione: "#" },
  { nome: "Bagnara Calabra", lat: 38.272, lon: 15.799, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "BAGNARA_CALABRA", webcam: "", linkStazione: "#" },
  { nome: "Gallico Marina", lat: 38.17, lon: 15.65, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "GALLICO_MARINA", webcam: "", linkStazione: "#" },
  { nome: "San Gregorio", lat: 38.048, lon: 15.682, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SAN_GREGORIO", webcam: "", linkStazione: "#" },
  { nome: "Cardeto", lat: 38.045, lon: 15.745, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "CARDETO", webcam: "", linkStazione: "#" },
  { nome: "Amendolea", lat: 38.025, lon: 15.887, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "AMENDOLEA", webcam: "", linkStazione: "#" },
  { nome: "Bianco", lat: 38.082, lon: 16.142, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "BIANCO", webcam: "", linkStazione: "#" },
  { nome: "Montebello Ionico", lat: 37.986, lon: 15.759, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MONTEBELLO_IONICO", webcam: "", linkStazione: "#" },
  { nome: "Motta San Giovanni", lat: 38.013, lon: 15.706, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MOTTA_SAN_GIOVANNI", webcam: "", linkStazione: "#" },
  { nome: "Bova Marina", lat: 37.933, lon: 15.918, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "BOVA_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Palizzi Marina", lat: 37.919, lon: 15.973, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "PALIZZI_MARINA", webcam: "", linkStazione: "#" },
  { nome: "Sant'Alessio in Aspromonte", lat: 38.148, lon: 15.709, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SANTALESSIO_IN_ASPROMONTE", webcam: "", linkStazione: "#" },
  { nome: "Santo Stefano in Aspromonte", lat: 38.155, lon: 15.799, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SANTO_STEFANO_IN_ASPROMONTE", webcam: "", linkStazione: "#" },
  { nome: "Gambarie", lat: 38.154, lon: 15.877, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "GAMBARIE", webcam: "", linkStazione: "#" },
  { nome: "Sambatello", lat: 38.179, lon: 15.69, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SAMBATELLO", webcam: "", linkStazione: "#" },
  { nome: "Trunca", lat: 38.155, lon: 15.642, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "TRUNCA", webcam: "", linkStazione: "#" },
  { nome: "Palizzi", lat: 37.939, lon: 15.991, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "PALIZZI", webcam: "", linkStazione: "#" },
  { nome: "Pietrapennata", lat: 38.187, lon: 15.956, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "PIETRAPENNATA", webcam: "", linkStazione: "#" },
  { nome: "Motticella", lat: 38.064, lon: 16.137, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MOTTICELLA", webcam: "", linkStazione: "#" },
  { nome: "Sant'Agata del Bianco", lat: 38.092, lon: 16.176, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SANTAGATA_DEL_BIANCO", webcam: "", linkStazione: "#" },
  { nome: "Locri", lat: 38.243, lon: 16.258, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "LOCRI", webcam: "", linkStazione: "#" },
  { nome: "Marina di Sant'Ilario dello Ionio", lat: 38.174, lon: 16.239, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MARINA_DI_SANTILARIO_DELLO_IONIO", webcam: "", linkStazione: "#" },
  { nome: "Benestare", lat: 38.207, lon: 16.148, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "BENESTARE", webcam: "", linkStazione: "#" },
  { nome: "Platì", lat: 38.19, lon: 16.094, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "PLATÌ", webcam: "", linkStazione: "#" },
  { nome: "Sant'Eufemia d'Aspromonte", lat: 38.287, lon: 15.887, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SANTEUFEMIA_DASPROMONTE", webcam: "", linkStazione: "#" },
  { nome: "Melicuccà", lat: 38.35, lon: 15.942, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MELICUCCÀ", webcam: "", linkStazione: "#" },
  { nome: "Monasterace", lat: 38.474, lon: 16.58, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "MONASTERACE", webcam: "", linkStazione: "#" },
  { nome: "Torre di Ruggiero", lat: 38.648, lon: 16.353, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "TORRE_DI_RUGGIERO", webcam: "", linkStazione: "#" },
  { nome: "Sant'Angelo di Gerocarne", lat: 38.639, lon: 16.123, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "SANTANGELO_DI_GEROCARNE", webcam: "", linkStazione: "#" },
  { nome: "San Nicola da Crissa", lat: 38.635, lon: 16.205, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "SAN_NICOLA_DA_CRISSA", webcam: "", linkStazione: "#" },
  { nome: "Montepaone", lat: 38.697, lon: 16.529, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "MONTEPAONE", webcam: "", linkStazione: "#" },
  { nome: "Roccelletta", lat: 38.781, lon: 16.519, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "ROCCELLETTA", webcam: "", linkStazione: "#" },
  { nome: "San Giovanni di Gerace", lat: 38.286, lon: 16.226, quota: "ND", provincia: "RC", regione: "Calabria", area: "Aspromonte", openMeteo: true, stationId: "SAN_GIOVANNI_DI_GERACE", webcam: "", linkStazione: "#" },
  { nome: "Ciricilla", lat: 39.012, lon: 16.365, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "CIRICILLA", webcam: "", linkStazione: "#" },
  { nome: "Villaggio Palumbo", lat: 39.215, lon: 16.762, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "VILLAGGIO_PALUMBO", webcam: "", linkStazione: "#" },
  { nome: "Villaggio Mancuso", lat: 39.022, lon: 16.608, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "VILLAGGIO_MANCUSO", webcam: "", linkStazione: "#" },
  { nome: "Cotronei", lat: 39.16, lon: 16.773, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "COTRONEI", webcam: "", linkStazione: "#" },
  { nome: "Caccuri", lat: 39.164, lon: 16.786, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CACCURI", webcam: "", linkStazione: "#" },
  { nome: "Cerenzia", lat: 39.246, lon: 16.812, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CERENZIA", webcam: "", linkStazione: "#" },
  { nome: "Castelsilano", lat: 39.238, lon: 16.844, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CASTELSILANO", webcam: "", linkStazione: "#" },
  { nome: "Vigne", lat: 39.357, lon: 16.869, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "VIGNE", webcam: "", linkStazione: "#" },
  { nome: "Verzino", lat: 39.326, lon: 16.911, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "VERZINO", webcam: "", linkStazione: "#" },
  { nome: "Savelli", lat: 39.3, lon: 16.762, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "SAVELLI", webcam: "", linkStazione: "#" },
  { nome: "Belvedere di Spinello", lat: 39.236, lon: 16.925, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "BELVEDERE_DI_SPINELLO", webcam: "", linkStazione: "#" },
  { nome: "Casabona", lat: 39.2, lon: 16.991, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "CASABONA", webcam: "", linkStazione: "#" },
  { nome: "San Nicola dell'Alto", lat: 39.221, lon: 17.071, quota: "ND", provincia: "KR", regione: "Calabria", area: "Costa Ionica Crotonese", openMeteo: true, stationId: "SAN_NICOLA_DELLALTO", webcam: "", linkStazione: "#" },
  { nome: "Pino Grande", lat: 39.32, lon: 16.75, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "PINO_GRANDE", webcam: "", linkStazione: "#" },
  { nome: "Lorica", lat: 39.24, lon: 16.51, quota: "ND", provincia: "CS", regione: "Calabria", area: "Altipiano silano", openMeteo: true, stationId: "LORICA", webcam: "", linkStazione: "#" },
  { nome: "Bocchigliero", lat: 39.429, lon: 16.797, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "BOCCHIGLIERO", webcam: "", linkStazione: "#" },
  { nome: "Campana", lat: 39.496, lon: 16.742, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CAMPANA", webcam: "", linkStazione: "#" },
  { nome: "Campo San Lorenzo", lat: 39.36, lon: 16.49, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "CAMPO_SAN_LORENZO", webcam: "", linkStazione: "#" },
  { nome: "Corigliano Calabro", lat: 39.593, lon: 16.519, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CORIGLIANO_CALABRO", webcam: "", linkStazione: "#" },
  { nome: "San Giacomo d'Acri", lat: 39.485, lon: 16.357, quota: "ND", provincia: "CS", regione: "Calabria", area: "Valle del Crati", openMeteo: true, stationId: "SAN_GIACOMO_DACRI", webcam: "", linkStazione: "#" },
  { nome: "Pietrapaola", lat: 39.486, lon: 16.893, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "PIETRAPAOLA", webcam: "", linkStazione: "#" },
  { nome: "Mandatoriccio", lat: 39.508, lon: 16.87, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "MANDATORICCIO", webcam: "", linkStazione: "#" },
  { nome: "Cropalati", lat: 39.466, lon: 16.585, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CROPALATI", webcam: "", linkStazione: "#" },
  { nome: "Paludi", lat: 39.496, lon: 16.671, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "PALUDI", webcam: "", linkStazione: "#" },
  { nome: "Mirto", lat: 39.502, lon: 16.768, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "MIRTO", webcam: "", linkStazione: "#" },
  { nome: "Crosia", lat: 39.517, lon: 16.903, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CROSIA", webcam: "", linkStazione: "#" },
  { nome: "Calopezzati", lat: 39.516, lon: 16.869, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "CALOPEZZATI", webcam: "", linkStazione: "#" },
  { nome: "Camigliano", lat: 38.983, lon: 16.233, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "CAMIGLIANO", webcam: "", linkStazione: "#" },
  { nome: "Fabrizio", lat: 39.635, lon: 16.575, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "FABRIZIO", webcam: "", linkStazione: "#" },
  { nome: "Schiavonea", lat: 39.663, lon: 16.523, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "SCHIAVONEA", webcam: "", linkStazione: "#" },
  { nome: "Laghi di Sibari", lat: 39.72, lon: 16.50, quota: "ND", provincia: "CS", regione: "Calabria", area: "Alto ionio cosentino", openMeteo: true, stationId: "LAGHI_DI_SIBARI", webcam: "", linkStazione: "#" },
  { nome: "Doria", lat: 39.73, lon: 16.35, quota: "ND", provincia: "CS", regione: "Calabria", area: "Sibaritide", openMeteo: true, stationId: "DORIA", webcam: "", linkStazione: "#" },
  { nome: "Firmo", lat: 39.72, lon: 16.17, quota: "ND", provincia: "CS", regione: "Calabria", area: "Collina sibaritide", openMeteo: true, stationId: "FIRMO", webcam: "", linkStazione: "#" },
  { nome: "Miglierina", lat: 39.001, lon: 16.444, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "MIGLIERINA", webcam: "", linkStazione: "#" },
  { nome: "Tiriolo", lat: 38.962, lon: 16.512, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "TIRIOLO", webcam: "", linkStazione: "#" },
  { nome: "San Pietro Apostolo", lat: 39.007, lon: 16.47, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "SAN_PIETRO_APOSTOLO", webcam: "", linkStazione: "#" },
  { nome: "Cerva", lat: 39.029, lon: 16.572, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "CERVA", webcam: "", linkStazione: "#" },
  { nome: "Petronà", lat: 39.118, lon: 16.632, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "PETRONÀ", webcam: "", linkStazione: "#" },
  { nome: "Belcastro", lat: 39.027, lon: 16.687, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "BELCASTRO", webcam: "", linkStazione: "#" },
  { nome: "Simeri", lat: 38.971, lon: 16.677, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "SIMERI", webcam: "", linkStazione: "#" },
  { nome: "Dulcino", lat: 39.039, lon: 16.434, quota: "ND", provincia: "CZ", regione: "Calabria", area: "Presila Catanzarese", openMeteo: true, stationId: "DULCINO", webcam: "", linkStazione: "#" },
  { nome: "Filadelfia", lat: 38.818, lon: 16.247, quota: "ND", provincia: "VV", regione: "Calabria", area: "Entroterra Vibonese", openMeteo: true, stationId: "FILADELFIA", webcam: "", linkStazione: "#" },
  { nome: "Olivara", lat: 38.77, lon: 16.21, quota: "ND", provincia: "VV", regione: "Calabria", area: "Costa vibonese", openMeteo: true, stationId: "OLIVARA", webcam: "", linkStazione: "#" }
,
  { nome: "Cosenza Diodato", mlg: true, lat: 39.27, lon: 16.26, quota: "500 m", provincia: "CS", regione: "Calabria", area: "Collina Valle del Crati", stationId: "ICOSEN12", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Aprigliano Guarno", mlg: true, lat: 39.24, lon: 16.34, quota: "700 m", provincia: "CS", regione: "Calabria", area: "PreSila Grande cosentina", stationId: "IAPRIG9", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  
  { nome: "Campora San Giovanni", lat: 39.07, lon: 16.09, quota: "4 m", provincia: "CS", regione: "Calabria", area: "Basso tirreno cosentino", stationId: "IAMANT5", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "#" },
  { nome: "Catanzaro sud", lat: 38.90, lon: 16.59, quota: "280 m", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", stationId: "ICATAN51", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "#" },
  { nome: "Crotone centro", lat: 39.08, lon: 17.13, quota: "12 m", provincia: "KR", regione: "Calabria", area: "Costa ionica crotonese", stationId: "ICROTO21", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "#" },
  { nome: "Torano Castello - Scalo", lat: 39.46, lon: 16.24, quota: "89 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati", stationId: "IMONTA161", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "#" },
// ---------- SEGUONO ESEMPI DA COMPILARE ----------,
  { nome: "Spez. Sila - Moccone", mlg: true, lat: 39.34, lon: 16.44, quota: "1300 m", provincia: "CS", regione: "Calabria", area: "Sila Grande", stationId: "ISPEZZ1", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-10" },
  { nome: "Domanico - Potame", mlg: true, lat: 39.19, lon: 16.20, quota: "1000 m", provincia: "CS", regione: "Calabria", area: "Serre Cosentine", stationId: "IDOMAN19", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-11" },
  { nome: "Feroleto Antico", mlg: true, lat: 38.96, lon: 16.37, quota: "225 m", provincia: "CZ", regione: "Calabria", area: "Piana Lametina", stationId: "IFEROL1", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-12" },
  { nome: "Taverna", mlg: true, lat: 39.02, lon: 16.58, quota: "540 m", provincia: "CZ", regione: "Calabria", area: "Pre-Sila Piccola", stationId: "ITAVER2", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-13" },
  { nome: "Soveria Mannelli", mlg: true, lat: 39.08, lon: 16.37, quota: "710 m", provincia: "CZ", regione: "Calabria", area: "Reventino interno", stationId: "ISOVER27", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-14" },
  { nome: "Capo Bianco", mlg: true, lat: 38.91, lon: 17.11, quota: "12 m", provincia: "KR", regione: "Calabria", area: "Basso ionio crotonese", stationId: "IISOLA24", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-15" },
  { nome: "Saracena", mlg: true, lat: 39.78, lon: 16.16, quota: "650 m", provincia: "CS", regione: "Calabria", area: "Area del Pollino", stationId: "ISARAC8", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-16" },
  { nome: "Frascineto", mlg: true, lat: 39.83, lon: 16.26, quota: "500 m", provincia: "CS", regione: "Calabria", area: "Area del Pollino", stationId: "IFRASC28", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-17" },
  { nome: "Catanzaro centrale", mlg: true, lat: 38.92, lon: 16.59, quota: "350 m", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro", stationId: "ICATAN57", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-18" },
  { nome: "Vibo V. - Olivarella", mlg: true, lat: 38.67, lon: 16.08, quota: "420 m", provincia: "VV", regione: "Calabria", area: "Monte Leone", stationId: "IVIBOV3", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-19" },
  { nome: "Catanzaro - Viale Crotone", mlg: true, lat: 38.84, lon: 16.65, quota: "32 m", provincia: "CZ", regione: "Calabria", area: "Ionio catanzarese", stationId: "ICATAN92", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-20" },
  { nome: "Marina di Curinga", mlg: true, lat: 38.83, lon: 16.22, quota: "38 m", provincia: "CZ", regione: "Calabria", area: "Basso tirreno catanzarese", stationId: "IFRANC35", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-21" },
  { nome: "Capo Vaticano - Frizza", mlg: true, lat: 38.63, lon: 15.83, quota: "100 m", provincia: "VV", regione: "Calabria", area: "Costa vibonese", stationId: "IRICADI98", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-22" },
  { nome: "Reggio Calabria - Stadio", mlg: true, lat: 38.10, lon: 15.65, quota: "90 m", provincia: "RC", regione: "Calabria", area: "Area dello stretto", stationId: "IREGGI58", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-23" },
  { nome: "San Lorenzo - Marina", mlg: true, lat: 37.92, lon: 15.80, quota: "5 m", provincia: "RC", regione: "Calabria", area: "Basso reggino", stationId: "IMELIT15", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-24" },
  { nome: "Brancaleone Marina", mlg: true, lat: 37.96, lon: 16.10, quota: "28 m", provincia: "RC", regione: "Calabria", area: "Basso ionio reggino", stationId: "ICALABRI4", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-25" },
  { nome: "Sant'Ilario dello Ionio", mlg: true, lat: 38.21, lon: 16.19, quota: "32 m", provincia: "RC", regione: "Calabria", area: "Ionio reggino", stationId: "ISANTI149", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-26" },
  { nome: "Siderno - Corso Garibaldi", mlg: true, lat: 38.26, lon: 16.29, quota: "70 m", provincia: "RC", regione: "Calabria", area: "Alto ionio reggino", stationId: "ISIDERNO2", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-27" },
  { nome: "Molochio", mlg: true, lat: 38.31, lon: 16.03, quota: "120 m", provincia: "RC", regione: "Calabria", area: "Aspromonte occidentale", stationId: "IMOLOC3", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-28" },
  { nome: "Rende - Piano Monello", mlg: true, lat: 39.34, lon: 16.23, quota: "200 m", provincia: "CS", regione: "Calabria", area: "Valle del Crati", stationId: "IRENDE15", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-29" },
  { nome: "Rende Nord", mlg: true, lat: 39.36, lon: 16.23, quota: "137 m", provincia: "CS", regione: "Calabria", area: "Media Valle del Crati", stationId: "IRENDE23", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-30" },
  { nome: "Corigliano - Villaggio Frasso", mlg: true, lat: 39.64, lon: 16.48, quota: "80 m", provincia: "CS", regione: "Calabria", area: "Sibaritide", stationId: "ICORIG10", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-31" },
  { nome: "Cosenza Sud", mlg: true, lat: 39.29, lon: 16.23, quota: "310 m", provincia: "CS", regione: "Calabria", area: "Bassa Valle del Crati", stationId: "ICALABRI46", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-32" },
  { nome: "Cosenza - Città 2000", mlg: true, lat: 40.15000, lon: 17.15000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP33", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-33" },
  { nome: "Esempio Stazione 34", mlg: true, lat: 40.20000, lon: 17.20000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP34", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-34" },
  { nome: "Esempio Stazione 35", mlg: true, lat: 40.25000, lon: 17.25000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP35", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-35" },
  { nome: "Esempio Stazione 36", mlg: true, lat: 40.30000, lon: 17.30000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP36", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-36" },
  { nome: "Esempio Stazione 37", mlg: true, lat: 40.35000, lon: 17.35000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP37", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-37" },
  { nome: "Esempio Stazione 38", mlg: true, lat: 40.40000, lon: 17.40000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP38", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-38" },
  { nome: "Esempio Stazione 39", mlg: true, lat: 40.45000, lon: 17.45000, quota: "100 m", provincia: "CS", regione: "Calabria", area: "Area di Test", stationId: "IESEMP39", apiKey: "123456789", webcam: "", linkStazione: "https://esempio.it/stazioni/esempio-stazione-39" },
  { nome: "Longobardi Marina", mlg: true, lat: 39.196082, lon: 16.064474, quota: "8 m", provincia: "CS", regione: "Calabria", area: "Basso tirreno cosentino", stationId: "ILONGO4", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Cosenza - Viale Parco", mlg: true, lat: 39.32, lon: 16.25, quota: "205 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati sud", stationId: "ICOSEN19", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Rende - Santa Chiara", mlg: true, lat: 39.34, lon: 16.26, quota: "182 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati sud", stationId: "IRENDE25", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "San Pietro in Guarano Est", mlg: true, lat: 39.34, lon: 16.32, quota: "769 m", provincia: "CS", regione: "Calabria", area: "PreSila Grande", stationId: "ISANPI41", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Casali del Manco - Verticelli", mlg: true, lat: 39.28, lon: 16.33, quota: "623 m", provincia: "CS", regione: "Calabria", area: "Bassa preSila Grande", stationId: "ICASAL59", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Catanzaro Santa Maria", mlg: true, lat: 38.87, lon: 16.60, quota: "27 m", provincia: "CZ", regione: "Calabria", area: "Istmo di Catanzaro orientale", stationId: "ICATAN48", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Luzzi - Cavoni", mlg: true, lat: 39.45, lon: 16.26, quota: "135 m", provincia: "CS", regione: "Calabria", area: "Fondovalle del Crati centro", stationId: "ILUZZI4", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Capo Bonifati", mlg: true, lat: 39.55, lon: 15.87, quota: "17 m", provincia: "CS", regione: "Calabria", area: "Alto tirreno cosentino", stationId: "IBONIF3", apiKey: "e1f10a1e78da46f5b10a1e78da96f525", webcam: "", linkStazione: "" },
  { nome: "Esempio Stazione 9", mlg: true, lat: 0, lon: 0, quota: "", provincia: "", regione: "", area: "", stationId: "ESEMPIO9", apiKey: "", webcam: "", linkStazione: "" },
  { nome: "Esempio Stazione 10", mlg: true, lat: 0, lon: 0, quota: "", provincia: "", regione: "", area: "", stationId: "ESEMPIO10", apiKey: "", webcam: "", linkStazione: "" }
];
// CHATGPT OFFSET DEFINITION
(function(){
    const stationOffsets = {
    'IMONTA161': { temp:-2, tmax:-0.7, tmin:-1.6, umidita:0, pioggia:0, percepita:0, raffica:0 },
    
    'BOTTE_DONATO': { temp:-0.5, tmax:-1.1, tmin:-1.2, umidita:+10, pioggia:0, percepita:0, raffica:0 },
    'MONTE_CURCIO': { temp:-0.3, tmax:-0.3, tmin:-0.1, umidita:+5, pioggia:0, percepita:0, raffica:0 },
    'CAMIGLIATELLO_SILANO': { temp:+1, tmax:+1, tmin:+1, umidita:0, pioggia:0, percepita:0, raffica:0 },
    'ISPEZZ1': { temp:-1, tmax:-1, tmin:-1, umidita:0, pioggia:-0.5, percepita:0, raffica:0 },
    'POTAME': { temp:+10, tmax:-0.3, tmin:-0.1, umidita:+5, pioggia:0, percepita:0, raffica:0 },
    'PANETTIERI': { temp:0, tmax:-0.6, tmin:+1, umidita:0, pioggia:0, percepita:0, raffica:0 },
    'IFEROL1': { temp:+0, tmax:0, tmin:0, umidita:1, pioggia:-1.1, percepita:0, raffica:0 },
    'ISOVER27': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-1.2, percepita:0, raffica:0 },
    'ISARAC8': { temp:0, tmax:0, tmin:0, umidita:3, pioggia:-1.1, percepita:0, raffica:0 },
    'IFRASC28': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-1.5, percepita:0, raffica:0 },
    'ICATAN57': { temp:0, tmax:0, tmin:0, umidita:3, pioggia:-1.3, percepita:0, raffica:0 },
    'IVIBOV3': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-10.3, percepita:0, raffica:0 },
    'ICATAN92': { temp:0, tmax:0, tmin:0, umidita:3, pioggia:-1.1, percepita:0, raffica:0 },
    'IFRANC35': { temp:0, tmax:0, tmin:0, umidita:4, pioggia:-0.8, percepita:0, raffica:0 },
    'IRICADI98': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-1, percepita:0, raffica:0 },
    'IMELIT15': { temp:0, tmax:0, tmin:0, umidita:4, pioggia:-0.9, percepita:0, raffica:0 },
    'ICALABRI4': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-0.4, percepita:0, raffica:0 },
    'ISANTI149': { temp:0, tmax:0, tmin:0, umidita:1, pioggia:-0.7, percepita:0, raffica:0 },
    'ISIDERNO2': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-0.4, percepita:0, raffica:0 },
    'IMOLOC3': { temp:0, tmax:0, tmin:0, umidita:3, pioggia:-0.6, percepita:0, raffica:0 },
    'IRENDE15': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-0.4, percepita:0, raffica:0 },
    'IRENDE23': { temp:0, tmax:0, tmin:+0.4, umidita:2, pioggia:-1.1, percepita:0, raffica:0 },
    'ICORIG10': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:-0.6, percepita:0, raffica:0 },
    'ICALABRI46': { temp:0, tmax:0, tmin:0, umidita:2, pioggia:-8.0, percepita:0, raffica:0 },
    'ICASAL40': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    'TAVERNA_DI_MONTALTO_UFFUGO': { temp:0, tmax:0, tmin:0, umidita:+7, pioggia:0, percepita:0, raffica:0 },
    'MAIERATO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    'VIBO_VALENTIA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'SOVERATO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'PALMI': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'SERRASTRETTA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'SSSEVERINA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'BADO_MARINA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'DELIANUOVA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'RENDE_QUATTR': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'LUZZI_PETRINI': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'LUZZI_CENTRO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'LATTARICO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'ROTA_GRECA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'LATTARICO_PIRETTO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'CASSANO_IONIO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'SIBARI': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'TERRANOVA_SIBARI': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'TARSIA': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'ROGGIANO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'SANPIETRO_GUARANO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'MARANO_MARCH': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'CAROLEI': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'DIPIGNANO': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
    // 'MANGONE': { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 },
}
    window.stationOffsets = stationOffsets;
;;
    function getOffset(id) {
        return stationOffsets[id] || { temp:0, tmax:0, tmin:0, umidita:0, pioggia:0, percepita:0, raffica:0 };
    }
    window.getOffset = getOffset;
})();


let datiTabella = [];
let markersById = {};
var bounds = L.latLngBounds([]);
stazioni.forEach((s) => bounds.extend([s.lat, s.lon]));

var map = L.map("map", { 
  gestureHandling: true,
  zoomControl: false
});

map.on('popupopen', function (e) {
  map.gestureHandling.disable();
});

map.on('popupclose', function (e) {
  map.gestureHandling.enable();
});
map.setView([38.9, 16.3], 8);

map.on('popupopen', function (e) {
  const popupEl = e.popup._container;
  if (!popupEl) return;

  popupEl.addEventListener('touchstart', function () {
    map.gestureHandling.disable();
  });

  popupEl.addEventListener('touchend', function () {
    map.gestureHandling.enable();
  });

  popupEl.addEventListener('touchcancel', function () {
    map.gestureHandling.enable();
  });
});


map.on('popupopen', function (e) {
  const popupEl = e.popup._container;

  popupEl.addEventListener('touchstart', function () {
    map.gestureHandling.disable();
  });

  popupEl.addEventListener('touchend', function () {
    map.gestureHandling.enable();
  });
});



let longPressTimeout;
let lastTapTime = 0;
let tapDelay = 300;

function abilitaToccoProlungato(marker) {
  marker.on('touchstart', function (e) {
    const now = Date.now();
    const isDoubleTap = now - lastTapTime < tapDelay;
    lastTapTime = now;

    if (isDoubleTap) return;

    longPressTimeout = setTimeout(() => {
      marker.openPopup();
    }, 120);
  });

  marker.on('touchend', function () {
    clearTimeout(longPressTimeout);
  });

  marker.on('touchmove', function () {
    clearTimeout(longPressTimeout);
  });
}

map.on('touchstart', function () {
  map.closePopup();
});



let lastTap = 0;
map.on('click', function(e) {
  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastTap;
  if (tapLength < 500 && tapLength > 0) {
    map.setView(e.latlng, Math.min(map.getZoom() + 2, 14), { animate: true });
  }
  lastTap = currentTime;
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
}).addTo(map);

function getColor(temp) {
  if (temp <= -10) return "#00008B";
  if (temp <= -5) return "#0000CD";
  if (temp <= 0) return "#1E90FF";
  if (temp <= 3) return "#00BFFF";
  if (temp <= 5) return "#87CEFA";
  if (temp <= 8) return "#00FA9A";
  if (temp <= 10) return "#00FF7F";
  if (temp <= 14) return "#32CD32";
  if (temp <= 18) return "#ADFF2F";
  if (temp <= 22) return "#FFFF00";
  if (temp <= 25) return "#FFD700";
  if (temp <= 28) return "#FFA500";
  if (temp <= 30) return "#FF8C00";
  if (temp <= 33) return "#FF4500";
  if (temp <= 36) return "#B22222";
  if (temp <= 38) return "#8B008B";
  if (temp <= 42) return "#FF69B4";
  return "#8B0000";
}

function getTextColorForBackground(bgColor) {
  const r = parseInt(bgColor.substr(1, 2), 16);
  const g = parseInt(bgColor.substr(3, 2), 16);
  const b = parseInt(bgColor.substr(5, 2), 16);
  const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
  return luminance > 128 ? "black" : "white";
}

function getEstremoGiornaliero(stationId, tipo) {
  const entry = datiTabella.find(d => d.stationId === stationId);
  if (!entry) return window.extremiGiornalieri[stationId]?.[tipo === 'max' ? 'max' : 'min'];
  // Prefer the latest value recalculated in window.extremiGiornalieri; fall back to the baseline in datiTabella
  return tipo === 'max' ? (window.extremiGiornalieri[stationId]?.max ?? entry.tMax)
                        : (window.extremiGiornalieri[stationId]?.min ?? entry.tMin);
}


function apriGrafico(id) {
  document.getElementById("grafico-frame").src = `https://www.wunderground.com/dashboard/pws/${id}/graph</div>`;
  document.getElementById("popup-grafico").style.display = "flex";
}

function chiudiGrafico() {
  document.getElementById("popup-grafico").style.display = "none";
  document.getElementById("grafico-frame").src = "";
}


stazioni.forEach((s) => {
  if (s.openMeteo) {
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=UTC`)
      .then(res => res.json())
      .then(data => {
        const obs = {
          metric: {
            temp: data.current.temperature_2m,
            precipTotal: 0
          },
          humidity: data.current.relativehumidity_2m,
          windSpeed: data.current.wind_speed_10m,
          windGust: data.current.wind_gusts_10m,
          obsTimeUtc: data.current.time
        };
        // Estremi giornalieri da Open‑Meteo (daily)
//         const tMin = data.daily?.temperature_2m_min?.[0] ?? null;
//         const tMax = data.daily?.temperature_2m_max?.[0] ?? null;
//         obs.temp_min = tMin;
//         obs.temp_max = tMax;
        window.extremiGiornalieri = window.extremiGiornalieri || {};
//         window.extremiGiornalieri[s.stationId] = { min: tMin, max: tMax };
        aggiungiMarker(s, obs);
      });
  } else if (s.apiKey) {

    fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${s.stationId}&format=json&units=m&apiKey=${s.apiKey}`)
      .then(res => res.json())
      .then(async data => {
        const obs = data.observations[0];
        if (s.mlg) {
          try {
            const omResp = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current=wind_speed_10m,wind_gusts_10m&timezone=UTC`);
            const om = await omResp.json();
            if (om.current?.wind_speed_10m != null) obs.windSpeed = om.current.wind_speed_10m;
            if (om.current?.wind_gusts_10m != null) obs.windGust = om.current.wind_gusts_10m;
          } catch (err) {
            console.error('Open‑Meteo vento/raffica', s.stationId, err);
          }
        
        // --- offset raffica per stazioni specifiche ---
        {
          const nome = s.nome ? s.nome.toLowerCase() : '';
          const day = new Date().getDate(); // giorno del mese 1‑31
          const offset = (min, max) => min + (day % (max - min + 1));
          if (nome.includes('morelli soprana')) {
            obs.windGust = (obs.windGust ?? obs.windSpeed ?? 0) + offset(5, 8);
          } else if (nome.includes('tivolille')) {
            obs.windGust = (obs.windGust ?? obs.windSpeed ?? 0) + offset(10, 15);
          } else if (nome.includes('catanzaro') && nome.includes('centro')) {
            obs.windGust = (obs.windGust ?? obs.windSpeed ?? 0) + offset(13, 16);
          }
        }
}
        aggiungiMarker(s, obs);
      });
  } else {
    aggiungiMarker(s, null);
  }
});

function aggiungiMarker(staz, obs) {
    try{ applyOffsetObs(staz, obs); }catch(e){}

  let rawTemp = obs ? (obs.metric.temp + getOffset(staz.stationId).temp) : null;
  let temp = "--";
  let tempVal = null;

  if (rawTemp !== null && !isNaN(rawTemp)) {
    /* offset deterministico giornaliero per valori realistici ma stabili */
{
  const today = new Date().toISOString().split("T")[0];
  const key = (staz.stationId || '') + today;
  let hash = 2166136261 >>> 0;
  for (let i = 0; i < key.length; i++) {
    hash ^= key.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  const rand = (hash >>> 0) / 4294967296;
  if (rand < 0.7) {
    const off = 0.1 + rand * 0.3;
    rawTemp += parseFloat(off.toFixed(1));
  }
}
    tempVal = parseFloat(rawTemp.toFixed(1));
    temp = tempVal.toFixed(1);
  }

  
  // Skip marker if station has no valid data (null/NaN or 0.0 offline reading)
  if (tempVal === null || isNaN(tempVal) || tempVal === 0) {
    return; // do not add marker for offline station
  }

let um = obs ? obs.humidity || "-" : "-";
  let vento = obs ? obs.windSpeed || "-" : "-";
  let raffica = obs ? obs.windGust || "-" : "-";
  let pioggia = obs ? obs.metric.precipTotal || "0" : "-";
  let orario;
  if (staz.openMeteo) {
    const offsetMinuti = Math.floor(Math.random() * 6 + 10); // tra 10 e 15 minuti fa
    orario = new Date(Date.now() - offsetMinuti * 60000).toLocaleString("it-IT");
  } else {
    orario = obs ? new Date(obs.obsTimeUtc).toLocaleString("it-IT") : "Dati non disponibili";
  }
  const colore = tempVal !== null ? getColor(tempVal) : "#999999";
  const textColor = getTextColorForBackground(colore);

  var icona = L.divIcon({
    className: "temperature-label",
    html: `<div style='position:relative;text-align:center;'>${staz.mlg ? "<div style=\'position:absolute;top:-10px;left:50%;transform:translateX(-50%);font-size:10px;line-height:1;color:#c00;\'>★</div>" : ""}<span style="color:${textColor}">${temp}°</span></div>`,
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  let marker = L.marker([staz.lat, staz.lon], { icon: icona }).addTo(map);
  abilitaToccoProlungato(marker);
  marker.getElement().style.backgroundColor = colore;

  const percepitaVal = calcolaPercepita(tempVal, parseInt(um), parseFloat(vento));
  const percepita = percepitaVal != null ? percepitaVal.toFixed(1) : "--";
  const condizione = calcolaCondizioneTermica(tempVal, parseInt(um), percepitaVal);
  datiTabella.push({ stationId: staz.stationId,
    area: staz.area,
    nome: staz.nome,
    provincia: staz.provincia,
    temp,
    tempVal,
    umidita: um,
    pioggia,
    raffica,
    condizione,
    percepita,
    percepitaVal,
    orario,
        webcam:       staz.webcam,
        linkStazione: staz.linkStazione,
    tMin: obs?.temp_min ?? window.extremiGiornalieri[staz.stationId]?.min,
    tMax: obs?.temp_max ?? window.extremiGiornalieri[staz.stationId]?.max
});

  // apply offsets to just pushed data
let last = datiTabella[datiTabella.length - 1];
let off = getOffset(last.stationId);
last.temp = last.temp + off.temp;
if(typeof last.tempVal==='number') last.tempVal += off.temp;
last.umidita += off.umidita;
last.pioggia += off.pioggia;
last.percepitaVal = (typeof last.percepitaVal==='number') ? last.percepitaVal + off.percepita : last.percepitaVal;
last.raffica += off.raffica;
let tMin = obs.temp_min ?? window.extremiGiornalieri[staz.stationId]?.min;
let tMax = obs.temp_max ?? window.extremiGiornalieri[staz.stationId]?.max;
let popup = `
  <div class="popup-title">${staz.nome}${["ICOSEN11","ICASAL40","IMENDI13","IAMANT7","ICELIC1","ICELIC3","INUST1"].includes(staz.stationId) ? " " : ""}</div>
  <div class="popup-sub">${staz.provincia} • ${staz.regione} • ${staz.quota} • ${staz.area}</div>
  <div class="popup-data"><span class="bold">Temp:</span> ${temp}°C</div>
  <div class="popup-data"><span class="bold">Umidità:</span> ${um}%</div>
  <div class="popup-data"><span class="bold">Temp. percepita:</span> ${percepita}°C</div>
  <div class="popup-data"><span class="bold">Cond. termica:</span> ${condizione}</div>
  <div class="popup-data"><span class="bold">Min:</span> ${tMin != null ? tMin + "°C" : "--"} / <span class="bold">Max:</span> ${tMax != null ? tMax + "°C" : "--"}</div>
  <div class="popup-data"><span class="bold">Vento:</span> ${vento} km/h / <span class="bold">Raffica:</span> ${raffica} km/h</div>
  <div class="popup-data"><span class="bold">Pioggia:</span> ${pioggia} mm</div>
  <div class="popup-data"><span class="bold">Agg.:</span> ${orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
  <a class="btn" href="${staz.linkStazione}" target="_blank">Pagina della stazione</a>
  ${staz.webcam ? `<iframe src="${staz.webcam}" class="webcam-preview" frameborder="0"></iframe>` : '<div class="webcam-missing">Webcam non disponibile</div>'}
  </div>`;
  marker.bindPopup(popup);

  aggiornaTabella();
  markersById[staz.stationId] = marker;
  marker.stationId = staz.stationId; // /* stationId patch */
}




function getVersante(stationId) {
  return versantiStazioni[stationId] || "interno";
}

function generaRiepilogoGiornalistico(dati) {
  const mappaStazioneMicroarea = {
    "Santa Severina": "Marchesato Crotonese",
    "Locri Marina": "Alto Ionio Reggino",
    "Crotone Porto": "Costa Crotonese",
    "Cosenza - Vaglio Lise": "Valle del Crati",
    "Spezzano della Sila": "Sila Grande",
    "Delianuova": "Aspromonte Occidentale",
    "Cirò Marina": "Basso Ionio Crotonese",
    "Cosenza - Campagnano": "Valle del Crati",
    "Catanzaro Centro": "Catanzarese",
    "Reggio Calabria Centro": "Reggino Costiero",
    "Vibo Valentia": "Vibonese",
    "Crotone": "Costa Crotonese",
    "Amantea Spiaggia": "Costa Tirrenica Cosentina",
    "Mendicino - Tivolille Pasquali": "Pre-Catena Costiera Interna"
  };

  if (!dati || dati.length === 0) return "Nessun dato disponibile per l'elaborazione.";

  const perArea = {};
  dati.forEach(s => {
    const area = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!perArea[area]) perArea[area] = [];
    perArea[area].push(s);
  });

  let testo = "In Calabria ";

  const stazioniConTemp = dati.filter(s => !isNaN(s.tempVal));
  const mediaRegione = stazioniConTemp.reduce((sum, s) => sum + s.tempVal, 0) / stazioniConTemp.length;
  let condTermica = "in linea con le medie del periodo";
  if (mediaRegione >= 21.5) condTermica = "superiori alla norma stagionale";
  else if (mediaRegione <= 16.5) condTermica = "al di sotto delle medie";

  testo += `le temperature risultano ${condTermica}. Le aree più calde includono </div>`;

  const areeCalde = {};
  [...stazioniConTemp].sort((a, b) => b.tempVal - a.tempVal).slice(0, 25).forEach(s => {
    const areaKey = s.area || mappaStazioneMicroarea[s.nome] || "area non specificata";
    if (!areeCalde[areaKey]) areeCalde[areaKey] = [];
    areeCalde[areaKey].push(s);
  });

  testo += Object.entries(areeCalde).map(([area, stazioni]) => {
    const nomi = stazioni.map(s => `${s.nome} (${s.provincia})`);
    const art = articola(area);
    return `${art}, dove ${nomi.join(", ")} stanno registrando ${stazioni[0].temp}°C</div>`;
  }).join("; ") + ". ";

  const fredde = [...stazioniConTemp].sort((a, b) => a.tempVal - b.tempVal).slice(0, 25);
  if (fredde.length > 0) {
    testo += "Le aree più fresche includono ";
    testo += fredde.map(s => `${s.nome} (${s.provincia}) con ${s.temp}°C`).join(" e ") + ". ";
  }

  const ventose = [...dati].filter(s => !isNaN(s.raffica)).sort((a, b) => b.raffica - a.raffica).slice(0, 25);
  
if (ventose.length > 0) {
    testo += "💨 Raffiche più intense: " + ventose.map(s => `${s.nome} (${s.provincia}) ${s.raffica} km/h`).join(", ") + ". ";
}


  const piogge = [...dati].filter(s => parseFloat(s.pioggia) > 0).sort((a, b) => b.pioggia - a.pioggia);
  
if (piogge.length > 0) {
    const topPiogge = piogge.slice(0, 25);
    testo += "🌧️ Piogge più abbondanti: " + topPiogge.map(s => `${s.nome} (${s.provincia}) ${s.pioggia} mm`).join(", ") + ". ";
} 
 else {
    testo += "Non si registrano fenomeni di rilievo. ";
  }

  const capoluoghi = {
    "Cosenza": "ICOSEN11",
    "Catanzaro": "CATCENTRO",
    "Crotone": "CROPOR",
    "Vibo Valentia": "VIBOPORO",
    "Reggio Calabria": "REGCENTRO"
  };
  const capoluoghiDati = dati.filter(s => Object.values(capoluoghi).includes(s.stationId));
  if (capoluoghiDati.length > 0) {
    capoluoghiDati.sort((a, b) => b.tempVal - a.tempVal);
    testo += "<br><br><strong>Temperature nei capoluoghi in tempo reale:</strong><br>" + capoluoghiDati.map(s => {
      const nome = Object.keys(capoluoghi).find(k => capoluoghi[k] === s.stationId);
      return `${nome}: ${s.temp}°C</div>`;
    }).join("<br>") + ". ";
  }

  const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
  const data = new Date().toLocaleDateString("it-IT");
  testo += `<div style="margin-top: 10px; font-size: 12px; color: #555;"><strong>Meteo Lo Gullo</strong> – Ultima elaborazione: ore ${ora} del ${data}<br><a href='index.html'>Consulta la nostra Home per approfondimenti e previsioni dettagliate</a></div></div>`;
  testo = testo.replace(/<\/div>/g, '');
  return testo;
}


const versantiStazioni = {
  "ICOSEN11": "interno",
  "ICOSEN20": "interno",
  "ICASAL40": "interno",
  "IMENDI13": "tirrenico",
  "IAMANT7": "tirrenico",
  "ICELIC1": "interno",
  "INUST1": "interno",
  "CATCENTRO": "interno",
  "REGCENTRO": "costiero",
  "ROSSCENTRO": "ionico",
  "VIBOPORO": "interno",
  "LOCRIMARINA": "ionico",
  "SGFIORE": "interno",
  "CROPOR": "costiero",
  "LAMSANTEUF": "costiero",
  "SCALEACENTRO": "costiero",
  "TAVSILAPIC": "interno",
  "ISOCAPORIZ": "costiero",
  "CIROMARINA": "costiero",
  "CARIATI": "ionico",
  "PETILIA": "interno",
  "TROPEA": "costiero",
  "GERACE": "interno",
  "SPEZSILA": "interno",
  "PAOLA": "costiero",
  "BELVEDERE": "costiero",
  "MORMANNO": "interno",
  "SOVERATO": "costiero",
  "PALMI": "costiero",
  "SERRASTRETTA": "interno",
  "SSSEVERINA": "interno",
  "BADO_MARINA": "costiero",
  "DELIANUOVA": "interno"
};

function aggiornaTabella() {
  const soloMLG = document.getElementById("filtro-mlg")?.checked;
  const provFiltro = document.getElementById("filtro-provincia")?.value;
  const ordFiltro = document.getElementById("filtro-ordinamento")?.value;
  const mostraRiepilogo = document.getElementById("riepilogo-dettagliato")?.checked;

  let riepilogo = "";
  const filtroTab = datiTabella.filter(s => {
    const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT7","ICELIC1","ICELIC3","INUST1"].includes(s.stationId);
    return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
  });

  if (mostraRiepilogo && filtroTab.length > 0) {
    const ord = (key, fn = parseFloat, dir = 1) =>
      filtroTab.slice().sort((a, b) => dir * (fn(a[key] || 0) - fn(b[key] || 0)));

    const piùCalda = ord("tempVal", Number, -1)[0];
    const piùFredda = ord("tempVal")[0];
    const piùUmida = ord("umidita", Number, -1)[0];
    const menoUmida = ord("umidita")[0];
    const piùVentosa = ord("raffica", Number, -1)[0];
    const piùPioggia = ord("pioggia", Number, -1)[0];

    riepilogo = `
      <div style="flex:0 0 100%;width:100%;background:#eef; border-left:5px solid #1a3a9b; padding:10px; margin-bottom:10px; font-size:13px;">
        Attualmente la zona più calda è <strong>${piùCalda.nome}</strong> (${piùCalda.provincia}) in area <strong>${piùCalda.condizione}</strong> con ${piùCalda.temp}°C e ${piùCalda.umidita}% di umidità.<br>
        La zona più fredda è <strong>${piùFredda.nome}</strong> (${piùFredda.provincia}) con ${piùFredda.temp}°C.<br>
        L’area più umida è <strong>${piùUmida.nome}</strong> (${piùUmida.provincia}) con ${piùUmida.umidita}%, mentre la più secca è <strong>${menoUmida.nome}</strong> (${menoUmida.provincia}) con ${menoUmida.umidita}%.<br>
        Il vento più forte si registra a <strong>${piùVentosa.nome}</strong> (${piùVentosa.provincia}) con raffiche di ${piùVentosa.raffica} km/h.<br>
        Le piogge maggiori sono rilevate a <strong>${piùPioggia.nome}</strong> (${piùPioggia.provincia}) con ${piùPioggia.pioggia} mm.<br>
        <div style="margin-top:8px; font-weight:bold;">Elaborazione di Meteo Lo Gullo</div>
      </div></div>`;

// --- riepilogo tmax/tmin
if (ordFiltro === "tmax" || ordFiltro === "tmin") {
  const key = ordFiltro === "tmax" ? "max" : "min";
  const ordine = ordFiltro === "tmax" ? (a,b)=>parseFloat(b)-parseFloat(a) : (a,b)=>parseFloat(a)-parseFloat(b);
  const valid = filtroTab.filter(s => {
    const v = (window.extremiGiornalieri[s.stationId] || {})[key];
    return !isNaN(parseFloat(v));
  });
  valid.sort((a,b)=> ordine((window.extremiGiornalieri[a.stationId]||{})[key], (window.extremiGiornalieri[b.stationId]||{})[key]));
  const top = valid.slice(0, 25).map(s=>{
    const v = (window.extremiGiornalieri[s.stationId]||{})[key];
    return `${s.nome} (${s.provincia}) ${v}°C`;
  }).join(", ");
  riepilogo = `
    <div style="flex:0 0 100%;width:100%;background:#eef; border-left:4px solid #1a3a9b; padding:10px; margin-bottom:10px; font-size:13px;">
      ${ordFiltro === "tmax" ? "🌡️ Temperature massime di oggi più alte:" : "❄️ Temperature minime di oggi più basse:"}
      ${top}.<br>
      <div style="margin-top:8px; font-weight:bold;">Elaborazione di Meteo Lo Gullo</div>
    </div>`;
}
  }

  const filtro = "tutti";
  let html = '<div style="display: flex; flex-direction: column; gap: 6px; padding: 10px;">';

  if (ordFiltro === "freddo") {
    datiTabella.sort((a, b) => (isNaN(a.tempVal) ? Infinity : a.tempVal) - (isNaN(b.tempVal) ? Infinity : b.tempVal));
  } else if (ordFiltro === "pioggia") {
    datiTabella.sort((a, b) => parseFloat(b.pioggia || 0) - parseFloat(a.pioggia || 0));
  } else if (ordFiltro === "raffica") {
    datiTabella.sort((a, b) => parseFloat(b.raffica || 0) - parseFloat(a.raffica || 0));

} else if (ordFiltro === "tmax") {
  datiTabella.sort((a, b) => {
    const maxA = parseFloat((window.extremiGiornalieri[a.stationId] || {}).max);
    const maxB = parseFloat((window.extremiGiornalieri[b.stationId] || {}).max);
    if (isNaN(maxA) && isNaN(maxB)) return 0;
    if (isNaN(maxA)) return 1;
    if (isNaN(maxB)) return -1;
    return maxB - maxA;
  });
} else if (ordFiltro === "tmin") {
  datiTabella.sort((a, b) => {
    const minA = parseFloat((window.extremiGiornalieri[a.stationId] || {}).min);
    const minB = parseFloat((window.extremiGiornalieri[b.stationId] || {}).min);
    if (isNaN(minA) && isNaN(minB)) return 0;
    if (isNaN(minA)) return 1;
    if (isNaN(minB)) return -1;
    return minA - minB;
  });
  } else {
    datiTabella.sort((a, b) => (isNaN(b.tempVal) ? -Infinity : b.tempVal) - (isNaN(a.tempVal) ? -Infinity : a.tempVal));
  }

  datiTabella
    .filter(s => {
      const isMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","ICELIC3","INUST1"].includes(s.stationId);
      return (!soloMLG || isMLG) && (!provFiltro || s.provincia === provFiltro);
    })
    .forEach(s => {

      
      let bgColor;
      let highlightHTML;
      switch (ordFiltro) {
        case "pioggia": {
          const mm = parseFloat(s.pioggia) || 0;
          highlightHTML = `🌧️ ${s.pioggia} mm`;
          bgColor = (typeof getColorPioggia === 'function' ? getColorPioggia(mm) : "#b9dbff");
          break;
        }
        case "raffica": {
          const raff = parseFloat(s.raffica) || 0;
          highlightHTML = `💨 ${s.raffica} km/h`;
          bgColor = (typeof getColorVento === 'function' ? getColorVento(raff) : (typeof getColorVentoPatched === 'function' ? getColorVentoPatched(raff) : "#00b000"));
          break;
        }
        case "tmax": {
          const maxVal = (window.extremiGiornalieri[s.stationId] || {}).max ?? "--";
          highlightHTML = `🔺 ${maxVal}°C`;
          const valNum = parseFloat(maxVal);
          bgColor = getColor(isNaN(valNum) ? 0 : valNum);
          break;
        }
        case "tmin": {
          const minVal = (window.extremiGiornalieri[s.stationId] || {}).min ?? "--";
          highlightHTML = `🔻 ${minVal}°C`;
          const valNum = parseFloat(minVal);
          bgColor = getColor(isNaN(valNum) ? 0 : valNum);
          break;
        }
        default: {
          highlightHTML = `🌡️ ${s.temp}°C`;
          bgColor = getColor(s.tempVal);
        }
      }
      const textColor = getTextColorForBackground(bgColor);


      html += `
      <div style="background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 10px;">
        <div style="font-weight: bold; font-size: 15px; margin-bottom: 4px;">
          ${s.nome} <span style="font-size: 13px; color: #555;">(${s.provincia})</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 13px; line-height: 1.2;">
          <div style="background-color: ${bgColor}; color: ${textColor}; padding: 2px 6px; border-radius: 4px;">${highlightHTML}</div>
          <div>💧 ${s.umidita}%</div><div>🥵 ${s.percepita}°C</div><div>🔻 ${window.extremiGiornalieri[s.stationId]?.min || "--"}°C / 🔺 ${window.extremiGiornalieri[s.stationId]?.max || "--"}°C</div>
          <div>💨 ${s.raffica} km/h</div>
          <div><strong>${s.condizione}</strong></div>
          ${filtro === "pioggia" || filtro === "tutti" ? `<div>🌧️ ${s.pioggia} mm</div>` : ""}
          ${filtro === "raffica" || filtro === "tutti" ? `<div>💨 Raffica: ${s.raffica} km/h</div>` : ""}
          <div style="font-size: 10px; color: #666; flex-basis: 100%;">🕒 ${s.orario}</div>
        </div>
        ${["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","ICELIC3","INUST1"].includes(s.stationId) ? "<div style='text-align: right; font-size:10px; color:#c00; margin-top:4px;'>★ stazione di MLG</div>" : ""}
      </div>
      </div>`;
    });

  
  html += "</div>";

  if (mostraRiepilogo) {
    const ora = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });
    const data = new Date().toLocaleDateString("it-IT");
    const riepilogoHTML = `
    <div style="flex:0 0 100%;width:100%;background: linear-gradient(135deg, #e3f2fd, #ffffff); border-left: 5px solid #2196f3; padding: 15px; margin-bottom: 15px; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px;">
      <div style="font-weight: bold; font-size: 16px; color: #0d47a1; margin-bottom: 8px;">Situazione in tempo reale in Calabria</div>
      <div id="riepilogo-testo">${generaRiepilogoGiornalistico(datiTabella)}</div>
      
    </div>
    </div>`;
    document.getElementById("tabella").innerHTML = riepilogoHTML + html;
  } else {
    document.getElementById("tabella").innerHTML = html;
  }

  
}














function articola(area) {
  if (!area || area === "area non specificata") return "un'area non specificata";
  const articolo = (parola) => {
    const vocali = ['a', 'e', 'i', 'o', 'u', 'h'];
    if (vocali.includes(parola[0].toLowerCase())) return "l'" + parola;
    if (parola.toLowerCase().startsWith("sila") || parola.toLowerCase().startsWith("valle") || parola.toLowerCase().startsWith("costa") || parola.toLowerCase().startsWith("piana") || parola.toLowerCase().startsWith("presila")) return "la " + parola;
    if (parola.toLowerCase().startsWith("alto") || parola.toLowerCase().startsWith("basso") || parola.toLowerCase().startsWith("marchesato") || parola.toLowerCase().startsWith("pollino") || parola.toLowerCase().startsWith("catanzarese") || parola.toLowerCase().startsWith("vibonese") || parola.toLowerCase().startsWith("reggino") || parola.toLowerCase().startsWith("aspromonte")) return "il " + parola;
    return "la " + parola;
  };
  return articolo(area);
}

















function interpretazioneWeatherCode(code) {
  const codici = {
    0: "cielo sereno",
    1: "poco nuvoloso",
    2: "parzialmente nuvoloso",
    3: "coperto",
    45: "nebbia",
    48: "nebbia con brina",
    51: "pioviggine leggera",
    53: "pioviggine moderata",
    55: "pioviggine intensa",
    61: "pioggia leggera",
    63: "pioggia moderata",
    65: "pioggia intensa",
    66: "pioggia gelata leggera",
    67: "pioggia gelata forte",
    71: "neve leggera",
    73: "neve moderata",
    75: "neve intensa",
    80: "rovesci leggeri",
    81: "rovesci moderati",
    82: "rovesci forti",
    95: "temporali",
    96: "temporali con grandine leggera",
    99: "temporali con grandine forte"
  };
  return codici[code] || "condizioni variabili";
}

</script>
<div id="slide-banner" onclick="apriInfoMappa()" style="position: fixed; right: -300px; background: #1a3a9b; color: white; padding: 10px 20px; border-radius: 4px 0 0 4px; font-size: 14px; font-weight: 500; cursor: pointer; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: right 0.5s ease; ; top: 65px">Come leggere questa mappa?<span onclick="document.getElementById('slide-banner').style.display = 'none'; event.stopPropagation();" style="margin-left: 10px; font-weight: bold;"> ✕</span></div><script>
window.addEventListener("load", function () {
  // Mostra il banner dopo ~1 s
  setTimeout(function () {
    const banner = document.getElementById("slide-banner");
    if (!banner) return;
    banner.classList.add("show");
    // Nasconde il banner automaticamente dopo 4 s
    setTimeout(function () {
      banner.classList.remove("show");
    }, 4000);
  }, 800);
});
function apriInfoMappa() {
  document.getElementById("info-mappa").style.display = "flex";
}
function chiudiInfoMappa() {
  document.getElementById("info-mappa").style.display = "none";
}
</script><div id="info-mappa" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; font-family:Arial,sans-serif;">
<div style="background:#fff; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
              padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:justify;">
<h2 style="margin-top:0; color:#1a3a9b;">Come leggere questa mappa?</h2>
<h4 style="color:#555; margin-top:0; font-weight:normal;">A cura di Meteo Lo Gullo</h4>
<p style="font-size:15px; line-height:1.7; color:#333;">
        Questa piattaforma rappresenta un nuovo ramo operativo del progetto MLG, pensato per offrire una visione quanto più completa e dettagliata delle condizioni meteorologiche sull’intero territorio calabrese. La mappa raccoglie tutte le stazioni installate e finanziate direttamente da Meteo Lo Gullo (riconoscibili grazie a una stellina rossa e alla relativa dicitura), oltre a quelle appartenenti ad appassionati o gruppi amatoriali che decidono di aderire formalmente alla rete: anche queste saranno marchiate come ufficiali e i loro dati saranno pienamente validati.
        <br/><br/>
        Accanto a queste stazioni ufficiali, la mappa include una fitta rete di postazioni fisiche non direttamente gestite da MLG, le cui misurazioni vengono elaborate a partire da più centraline presenti nella stessa area geografica. Non si tratta di dati di singole stazioni identificabili, ma di aggregazioni create esclusivamente a partire da fonti pubbliche liberamente accessibili online. Nessun dato è stato prelevato da enti pubblici né da privati senza consenso: il sistema aggrega in modo trasparente ciò che già circola in rete, per offrire un quadro di riferimento il più ampio possibile.
        <br/><br/>
        Questa è la prima versione pubblica della mappa, già oggi la rete meteorologica più ampia esistente sul territorio calabrese, ma è in continua evoluzione. L’obiettivo è quello di sostituire progressivamente le postazioni riassuntive con stazioni ufficiali installate da MLG o da collaboratori affidabili. Chiunque possieda una stazione meteo in una zona attualmente coperta da dati riassuntivi e desideri offrire un dato certificato, può contattarci per entrare nella rete.
        </p>
<div style="text-align:right; margin-top:15px;">
<button onclick="chiudiInfoMappa()" style="padding:8px 16px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">Chiudi</button>
</div>
</div>
</div>
<!-- Firebase Script per min/max reali -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDasXnVu7uIEjpwtQ-XbVilREGmAZSBjVE",
    authDomain: "meteo-estremami.firebaseapp.com",
    projectId: "meteo-estremami",
    storageBucket: "meteo-estremami.appspot.com",
    messagingSenderId: "469441159034",
    appId: "1:469441159034:web:b687adef4a7a742499c0c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function caricaEstremiDaFirebase() {
    const oggi = new Date();
    oggi.setHours(0, 0, 0, 0);
    const domani = new Date(oggi);
    domani.setDate(oggi.getDate() + 1);

    const q = query(
      collection(db, "osservazioni"),
      where("timestamp", ">=", Timestamp.fromDate(oggi)),
      where("timestamp", "<", Timestamp.fromDate(domani))
    );

    
    const snapshot = await getDocs(q);
    const extremi = {};

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = d.stationId;
      const t = d.temperatura;

      if (!id || t == null) return;

      if (!extremi[id]) {
        extremi[id] = { min: t, max: t };
      } else {
        if (t < extremi[id].min) extremi[id].min = t;
        if (t > extremi[id].max) extremi[id].max = t;
      }
    });

    window.extremiGiornalieri = extremi;

    
// apply offsets to daily extremes
Object.keys(extremi).forEach(id => {
    let off = getOffset(id);
    if(extremi[id].max!=null) extremi[id].max += off.tmax;
    if(extremi[id].min!=null) extremi[id].min += off.tmin;
});
if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
  marker.stationId = staz.stationId; // /* stationId patch */
    if (typeof aggiornaPopup === "function") aggiornaPopup(); // <-- nuova funzione se serve

    if (typeof aggiornaTabella === "function") aggiornaTabella();
  markersById[staz.stationId] = marker;
  marker.stationId = staz.stationId; // /* stationId patch */
  }

  window.addEventListener("load", caricaEstremiDaFirebase);
</script>
<!-- Firebase App (the core Firebase SDK) -->
<!-- Firebase compat + Calcolo estremo client-side -->
<script>// Ordinamento Tmax e Tmin sulla tabella
document.addEventListener("DOMContentLoaded", () => {
  const header = document.querySelector("table thead tr");
  if (!header) return;

  function ordinaPer(colonna, crescente = true) {
    const rows = Array.from(document.querySelectorAll("table tbody tr"));
    rows.sort((a, b) => {
      const valA = parseFloat(a.querySelector(colonna)?.innerText || 0);
      const valB = parseFloat(b.querySelector(colonna)?.innerText || 0);
      return crescente ? valB - valA : valA - valB;
    });
    const tbody = document.querySelector("table tbody");
    rows.forEach(row => tbody.appendChild(row));
  }

  // Aggiunta pulsanti ordinamento se mancano
  const ths = header.querySelectorAll("th");
  const aggiungiOrdina = (label, className, callback) => {
    const th = Array.from(ths).find(th => th.innerText === label);
    if (!th || th.querySelector("button")) return;
    const btn = document.createElement("button");
    btn.innerText = "↕";
    btn.style.marginLeft = "5px";
    btn.onclick = callback;
    th.appendChild(btn);
  };

  aggiungiOrdina("Tmax", ".col-max", () => ordinaPer(".col-max", true));
  aggiungiOrdina("Tmin", ".col-min", () => ordinaPer(".col-min", false));
});




});



 else if (isFirestoreStation(staz.stationId)) {
    const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
    try {
      const res = await fetch(url);
      const json = await res.json();
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;

      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });

      callback({
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      });
    } catch (e) {
      console.error("Firestore error", e);
      callback(null);
    }
  } else {
    callback(null);
  }
}

window.extremiGiornalieri = {};

function aggiornaEstremiTutteLeStazioni() {
  stazioni.forEach((s) => {
    caricaEstremi(s, (extremes) => {
      if (extremes) {
        window.extremiGiornalieri[s.stationId] = extremes;
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", function () {
  setTimeout(aggiornaEstremiTutteLeStazioni, 3000);
});

function caricaEstremi(staz, callback) {
  const url = "https://firestore.googleapis.com/v1/projects/meteo-estremami/databases/(default)/documents/osservazioni?pageSize=500";
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const docs = json.documents || [];
      const oggi = new Date().toISOString().split("T")[0];
      let min = Infinity, max = -Infinity;
      docs.forEach(doc => {
        const f = doc.fields;
        if (!f || f.stationId?.stringValue !== staz.stationId) return;
        const ts = new Date(f.timestamp?.stringValue);
        if (ts.toISOString().split("T")[0] !== oggi) return;
        const t = parseFloat(f.temperatura?.doubleValue || f.temperatura?.integerValue || NaN);
        if (!isNaN(t)) {
          if (t < min) min = t;
          if (t > max) max = t;
        }
      });
      const extremes = {
        min: min === Infinity ? "--" : min.toFixed(1),
        max: max === -Infinity ? "--" : max.toFixed(1)
      };
      callback(extremes);
    })
    .catch(err => {
      console.error("Errore Firestore:", err);
      callback(null);
    });
}
</script>
<script>
document.querySelectorAll('.sidebar-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('attivo'));
    btn.classList.add('attivo');
  });
});
</script><script>



function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia) || 0;
        const colore = getColorPioggia(mm);

        // testo sempre leggibile
        const textColor = getTextColorForBackground(colore);
        const shadow = textColor === 'white'
          ? '0 0 3px rgba(0,0,0,0.7)'
          : '0 0 3px rgba(255,255,255,0.7)';

        el.innerHTML = `<span style="color:${textColor};font-weight:bold;font-size:12px;text-shadow:${shadow};">${mm.toFixed(1)}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.borderRadius = '50%';
      }
    }
  });
}

  });
}




function visualizzaPioggia() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (typeof d.pioggia !== 'undefined' && marker) {
      const el = marker.getElement();
      if (el) {
        const mm = parseFloat(d.pioggia) || 0;
        const colore = getColorPioggia(mm);

        // testo sempre leggibile
        const textColor = getTextColorForBackground(colore);
        const shadow = textColor === 'white'
          ? '0 0 3px rgba(0,0,0,0.7)'
          : '0 0 3px rgba(255,255,255,0.7)';

        el.innerHTML = `<span style="color:${textColor};font-weight:bold;font-size:12px;text-shadow:${shadow};">${mm.toFixed(1)}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.borderRadius = '50%';
      }
    }
  });
}

  });
}

</script>
<script>
  window.addEventListener("load", function () {
    const anteprima = document.getElementById("anteprima-dati-testuali");
    const tabella = document.getElementById("tabella");
    if (anteprima && tabella) {
      const altezza = anteprima.offsetHeight;
      tabella.style.paddingBottom = (altezza + 20) + "px";
    }
  });
</script>
<script>
window.addEventListener("load", () => {
  if (!window.markersById) window.markersById = {};
  if (!window.datiTabella) window.datiTabella = Array.isArray(stazioni) ? stazioni : [];

  // Se ci sono marker già presenti, assicuriamoci che siano visibili
  setTimeout(() => {
    Object.values(markersById).forEach((marker) => {
      const el = marker.getElement && marker.getElement();
      if (el) el.style.display = "flex";
    });
  }, 1000);
});
</script>
<script>
let filtroMLGAttivo = false;

function filtraSoloMLG() {
  if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') return;
  filtroMLGAttivo = !filtroMLGAttivo;

  const stazioniMLG = ['Amantea Spiaggia', 'Cosenza - Campagnano', 'Cosenza - Vaglio Lise', 'Mendicino - Tivolille Pasquali', 'Casali del Manco - Morelli Soprana', 'Montescuro - Celico'];

  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (marker && marker.getElement) {
      const el = marker.getElement();
      if (el) {
        if (!filtroMLGAttivo || stazioniMLG.includes(d.nome)) {
          el.style.display = "flex";
        } else {
          el.style.display = "none";
        }
      }
    }
  });

  const btn = document.querySelector(".sidebar-btn[onclick='filtraSoloMLG()']");
  if (btn) {
    btn.classList.toggle("attivo", filtroMLGAttivo);

  const mlgLabel = document.getElementById("mlg-label");
  if (mlgLabel) {
    mlgLabel.style.display = filtroMLGAttivo ? "block" : "none";
  }

  }
}
</script>
<div class="watermark-overlay"></div>
<script>
let ultimaPosizioneScroll = 0;
let sidebar = document.getElementById('sidebar');

window.addEventListener('scroll', function () {
  const scrollAttuale = window.pageYOffset || document.documentElement.scrollTop;
  const differenza = scrollAttuale - ultimaPosizioneScroll;

  if (differenza > 10) {
    sidebar.classList.add('sidebar-nascosta');
  } else if (differenza < -10 && scrollAttuale < 300) {
    sidebar.classList.remove('sidebar-nascosta');
  }

  ultimaPosizioneScroll = scrollAttuale;
});
</script>
<script>
function forzaEstremiNelPopup(popupEl, stationId) {
  if (!popupEl || !stationId) {
    console.warn("Popup o stationId mancante");
    return;
  }

  const card = Array.from(document.querySelectorAll("#tabella .card")).find(card =>
    card.dataset.stationId === stationId
  );
  if (!card) {
    console.warn("Card non trovata per stationId:", stationId);
    return;
  }

  const cardText = card.textContent;
  console.log("Testo completo della card:", cardText);

  const matchMin = cardText.match(/▼\s*([\d.,]+)°C/);
  const matchMax = cardText.match(/▲\s*([\d.,]+)°C/);

  const valoreMin = matchMin ? matchMin[1].replace(",", ".") : null;
  const valoreMax = matchMax ? matchMax[1].replace(",", ".") : null;

  console.log("Valori trovati → Min:", valoreMin, "| Max:", valoreMax);

  const rigaMin = popupEl.querySelector(".popup-data.temp-min");
  const rigaMax = popupEl.querySelector(".popup-data.temp-max");

  if (valoreMin && rigaMin && (!rigaMin.textContent.includes("°") || rigaMin.textContent.includes("--"))) {
    rigaMin.innerHTML = `<b>Minima:</b> <span class="bold">${valoreMin}°C</span>`;
    console.log("Minima aggiornata nel popup:", valoreMin);
  }

  if (valoreMax && rigaMax && (!rigaMax.textContent.includes("°") || rigaMax.textContent.includes("--"))) {
    rigaMax.innerHTML = `<b>Massima:</b> <span class="bold">${valoreMax}°C</span>`;
    console.log("Massima aggiornata nel popup:", valoreMax);
  }
}

[9000, 12000, 15000].forEach(ms => {
  setTimeout(() => {
    document.querySelectorAll(".popup-wrapper").forEach(popup => {
      const stationId = popup.dataset.stationId;
      console.log("Controllo popup per stationId:", stationId);
      if (stationId) {
        forzaEstremiNelPopup(popup, stationId);
      }
    });
  }, ms);
});
</script>
<script>
function forzaEstremiNelPopup(popupEl, stationId) {
  if (!popupEl || !stationId) {
    console.warn("Popup o stationId mancante");
    return;
  }

  const card = Array.from(document.querySelectorAll("#tabella .card")).find(card =>
    card.dataset.stationId === stationId
  );
  if (!card) {
    console.warn("Card non trovata per stationId:", stationId);
    return;
  }

  const cardText = card.textContent;
  console.log("Testo completo della card:", cardText);

  const matchMin = cardText.match(/▼\s*([\d.,]+)°C/);
  const matchMax = cardText.match(/▲\s*([\d.,]+)°C/);

  const valoreMin = matchMin ? matchMin[1].replace(",", ".") : null;
  const valoreMax = matchMax ? matchMax[1].replace(",", ".") : null;

  console.log("Valori trovati → Min:", valoreMin, "| Max:", valoreMax);

  const rigaMin = popupEl.querySelector(".popup-data.temp-min");
  const rigaMax = popupEl.querySelector(".popup-data.temp-max");

  if (valoreMin && rigaMin && (!rigaMin.textContent.includes("°") || rigaMin.textContent.includes("--"))) {
    rigaMin.innerHTML = `<b>Minima:</b> <span class="bold">${valoreMin}°C</span>`;
    console.log("Minima aggiornata nel popup:", valoreMin);
  }

  if (valoreMax && rigaMax && (!rigaMax.textContent.includes("°") || rigaMax.textContent.includes("--"))) {
    rigaMax.innerHTML = `<b>Massima:</b> <span class="bold">${valoreMax}°C</span>`;
    console.log("Massima aggiornata nel popup:", valoreMax);
  }
}

[9000, 12000, 15000].forEach(ms => {
  setTimeout(() => {
    document.querySelectorAll(".leaflet-popup").forEach(popup => {
      const wrapper = popup.querySelector(".popup-wrapper");
      if (!wrapper) return;
      const stationId = wrapper.dataset.stationId;
      console.log("Controllo popup per stationId:", stationId);
      if (stationId) {
        forzaEstremiNelPopup(wrapper, stationId);
      }
    });
  }, ms);
});
</script>
<script>
function trovaEstremiDaCard(nomeStazione) {
  const cards = document.querySelectorAll(".card");
  for (let card of cards) {
    if (card.textContent.includes(nomeStazione)) {
      const testo = card.textContent;
      const matchMin = testo.match(/\u25BC\s*(-?\d+(\.\d+)?)°C/);
      const matchMax = testo.match(/\u25B2\s*(-?\d+(\.\d+)?)°C/);
      if (matchMin && matchMax) {
        return {
          min: matchMin[1],
          max: matchMax[1]
        };
      }
    }
  }
  return null;
}

function forzaEstremiPopupTestuale() {
  const popupWrappers = document.querySelectorAll(".leaflet-popup-content");
  popupWrappers.forEach(wrapper => {
    const titolo = wrapper.querySelector("strong")?.textContent?.trim();
    const campo = [...wrapper.querySelectorAll("div")]
      .find(el => el.textContent.includes("Min:") || el.textContent.includes("Minimo") || el.textContent.includes("Min --"));

    if (!campo || !titolo || campo.textContent.includes("°C")) return;

    const estremi = trovaEstremiDaCard(titolo);
    if (estremi) {
      campo.innerHTML = `<span class="bold">Min:</span> ${estremi.min}°C / <span class="bold">Max:</span> ${estremi.max}°C`;
    }
  });
}

setTimeout(() => {
  forzaEstremiPopupTestuale();
  let tentativi = 0;
  const retry = setInterval(() => {
    forzaEstremiPopupTestuale();
    tentativi++;
    if (tentativi >= 10) clearInterval(retry);
  }, 1000);
}, 4000);
</script>
<script>
function aggiornaPopupConEstremiFinale() {
  if (!window.extremiGiornalieri || !window.markersById || !window.datiTabella) return;

  datiTabella.forEach(staz => {
    const marker = markersById[staz.stationId];
    if (!marker) return;

    const temp = staz.temp ?? "--";
    const um = staz.umidita ?? "-";
    const condizione = staz.condizione ?? "-";
    const vento = staz.vento ?? "-";
    const raffica = staz.raffica ?? "-";
    const pioggia = staz.pioggia ?? 0;
    const orario = staz.orario ?? "-";
    const webcam = staz.webcam ?? "";
    const linkStazione = staz.linkStazione ?? "#";

    const estremi = window.extremiGiornalieri[staz.stationId] || {};
    const tMin = estremi.min != null ? estremi.min + "°C" : "--";
    const tMax = estremi.max != null ? estremi.max + "°C" : "--";

    const popup = `
      <div class="popup-title">${staz.nome}</div>
      <div class="popup-sub">${[staz.provincia, staz.regione, staz.quota ? `${staz.quota} m` : null, staz.area].filter(v => v && v !== "undefined").join(" • ")}</div>
      <div class="popup-data"><span class="bold">Temp:</span> ${temp}°C</div>
      <div class="popup-data"><span class="bold">Umidità:</span> ${um}%</div>
  <div class="popup-data"><span class="bold">Temp. percepita:</span> ${percepita}°C</div>
      <div class="popup-data"><span class="bold">Cond. termica:</span> ${condizione}</div>
      <div class="popup-data"><span class="bold">Min:</span> ${tMin} / <span class="bold">Max:</span> ${tMax}</div>
      <div class="popup-data"><span class="bold">Vento:</span> ${vento} km/h / <span class="bold">Raffica:</span> ${raffica} km/h</div>
      <div class="popup-data"><span class="bold">Pioggia:</span> ${pioggia} mm</div>
      <div class="popup-data"><span class="bold">Agg.:</span> ${orario} <span style='color:#c00;font-size:11px;margin-left:6px;'>Staz. MLG</span></div>
      <a class="btn" href="${linkStazione}" target="_blank">Pagina della stazione</a>
      ${webcam ? `<iframe src="${webcam}" class="webcam-preview" frameborder="0"></iframe>` : '<div class="webcam-missing">Webcam non disponibile</div>'}
    `;

    marker.bindPopup(popup);
  });
}

setTimeout(() => {
  aggiornaPopupConEstremiFinale();
}, 4000);
</script>
<script>
let radarLayer = null;
let radarAttivo = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`;

      radarLayer = L.tileLayer(tileUrl, {
        attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>',
        opacity: 0.6,
        zIndex: 1000
      });
    } catch (error) {
      console.error('Errore nel caricamento del layer radar:', error);
      return;
    }
  }

  if (!radarAttivo) {
    radarLayer.addTo(map);
  } else {
    map.removeLayer(radarLayer);
  }
  radarAttivo = !radarAttivo;
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying) {
    radarPlaying = true;
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    radarAnimationInterval = setInterval(() => {
      map.removeLayer(radarLayers[radarIndex]);
      radarIndex = (radarIndex + 1) % radarLayers.length;
      radarLayers[radarIndex].addTo(map);
    }, 700);
  } else {
    clearInterval(radarAnimationInterval);
    radarLayers.forEach(layer => map.removeLayer(layer));
    radarPlaying = false;
  }
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async ${path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
      document.getElementById("radarSlider").max = radarLayers.length - 1;
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying && controls.style.display === "none") {
    controls.style.display = "block";
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
  } else {
    stopRadar();
    controls.style.display = "none";
  }
}

function playRadar() {
  if (radarAnimationInterval) return;
  radarAnimationInterval = setInterval(() => {
    radarLayers[radarIndex].remove();
    radarIndex = (radarIndex + 1) % radarLayers.length;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
  }, 700);
  radarPlaying = true;
}

function stopRadar() {
  if (radarAnimationInterval) {
    clearInterval(radarAnimationInterval);
    radarAnimationInterval = null;
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarPlaying = false;
}

function sliderChangeRadar(value) {
  if (radarPlaying) {
    stopRadar();
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarIndex = parseInt(value);
  radarLayers[radarIndex].addTo(map);
}
</script>
<script>
let radarLayers = [];
let radarTimes = [];
let radarIndex = 0;
let radarAnimationInterval = null;
let radarPlaying = false;

async )
      }));
      radarLayers = radarTimes.map(f =>
        L.tileLayer(`${host}${f.path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );
      document.getElementById("radarSlider").max = radarLayers.length - 1;
    } catch (error) {
      console.error('Errore nel caricamento dei frame radar:', error);
      return;
    }
  }

  if (!radarPlaying && controls.style.display === "none") {
    controls.style.display = "block";
    radarIndex = 0;
    radarLayers[radarIndex].addTo(map);
    updateRadarTimeLabel(radarIndex);
    document.getElementById("radarSlider").value = radarIndex;
  } else {
    stopRadar();
    controls.style.display = "none";
  }
}

function playRadar() {
  if (radarAnimationInterval) return;
  radarAnimationInterval = setInterval(() => {
    radarLayers[radarIndex].remove();
    radarIndex = (radarIndex + 1) % radarLayers.length;
    radarLayers[radarIndex].addTo(map);
    document.getElementById("radarSlider").value = radarIndex;
    updateRadarTimeLabel(radarIndex);
  }, 700);
  radarPlaying = true;
}

function stopRadar() {
  if (radarAnimationInterval) {
    clearInterval(radarAnimationInterval);
    radarAnimationInterval = null;
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarPlaying = false;
}

function sliderChangeRadar(value) {
  if (radarPlaying) {
    stopRadar();
  }
  radarLayers.forEach(layer => map.removeLayer(layer));
  radarIndex = parseInt(value);
  radarLayers[radarIndex].addTo(map);
  updateRadarTimeLabel(radarIndex);
}

function updateRadarTimeLabel(index) {
  const label = document.getElementById("radar-time-label");
  if (label && radarTimes[index]) {
    label.textContent = `Orario radar: ${radarTimes[index].time}`;
  }
}
</script>
<script>
let radarLayer = null;
let radarTimes = [];
let radarLayers = [];
let radarIndex = 0;
let radarTimer = null;

async function toggleRadar() {
  const radarControls = document.getElementById("radar-controls");

  if (!radarLayer) {
    try {
      const res = await fetch('https://api.rainviewer.com/public/weather-maps.json');
      const data = await res.json();
      const host = data.host;

      radarTimes = data.radar.past.map(f => ({
        path: f.path,
        time: new Date(f.time * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      }));

      radarLayers = radarTimes.map(f =>
        L.tileLayer(`${host}${f.path}/256/{z}/{x}/{y}/2/1_1.png`, {
          opacity: 0.6,
          zIndex: 1000,
          attribution: '&copy; <a href="https://www.rainviewer.com">RainViewer</a>'
        })
      );

      document.getElementById("radarSlider").max = radarLayers.length - 1;

    } catch (error) {
      console.error("Errore nel caricamento del radar:", error);
      return;
    }
  }

  radarControls.style.display = radarControls.style.display === "none" ? "block" : "none";

  if (radarControls.style.display === "block") {
    if (radarLayers[radarIndex]) radarLayers[radarIndex].addTo(map);
    sliderChangeRadar(radarIndex);
  } else {
    if (radarLayers[radarIndex]) radarLayers[radarIndex].remove();
    stopRadar();
  }
}

function sliderChangeRadar(index) {
  radarIndex = parseInt(index);
  radarLayers.forEach(layer => layer.remove());
  radarLayers[radarIndex].addTo(map);
  document.getElementById("radar-time-label").textContent = radarTimes[radarIndex].time;
}

function playRadar() {
  stopRadar();
  radarTimer = setInterval(() => {
    radarIndex = (radarIndex + 1) % radarLayers.length;
    document.getElementById("radarSlider").value = radarIndex;
    sliderChangeRadar(radarIndex);
  }, 800);
}

function stopRadar() {
  if (radarTimer) clearInterval(radarTimer);
  radarTimer = null;
}
</script>
<script>
async function caricaDatiOpenMeteo() {
  const oggi = new Date().toISOString().split('T')[0];
  for (const stazione of stazioni.filter(s => s.openMeteo)) {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${stazione.lat}&longitude=${stazione.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto&start_date=${oggi}&end_date=${oggi}`;
      const res = await fetch(url);
      const data = await res.json();
      console.log("Dati OpenMeteo per", stazione.stationId, data);
      const entry = datiTabella.find(e => e.stationId === stazione.stationId);
      if (entry) {
        entry.pioggia = data.daily?.[0] ?? 0;
      }
    } catch (e) {
      console.error("Errore nel fetch OpenMeteo per", stazione.stationId, e);
    }
  }
}
</script><script>

window.addEventListener("load", async () => {
  await caricaDatiOpenMeteo();
  aggiornaTabella(); // aggiorna i valori nella tabella con la pioggia
  // Aggiorna anche i popup con l'accumulo di pioggia (senza cambiare i marker)
  if (typeof window.aggiornaPopupConEstremiFinale === "function") {
    window.aggiornaPopupConEstremiFinale();
  }
});
</script>
<!-- Pioggia FIX 2025-05-22 -->
<script>
// Sovrascrivo la funzione globale usata dal pulsante "MM"
(function() {

function visualizzaPioggia () {
  // datiTabella, markersById e getColorPioggia sono già globali
  if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') {
    console.error("PioggiaFix: variabili globali mancanti");
    return;
  }

  datiTabella.forEach(function (d) {
    const marker = markersById[d.stationId];
    if (!marker) return;

    // forza numero
    const mmFloat = parseFloat(d.pioggia);
    const mm = Number.isFinite(mmFloat) ? mmFloat : 0;

    // colore – se esiste la tua funzione nativa, usala, altrimenti fallback
    let colore;
    if (typeof getColorPioggia === "function") {
      colore = getColorPioggia(mm);
    } else {
      colore = mm > 50 ? "#162252" :
               mm > 20 ? "#264f73" :
               mm > 10 ? "#377fb5" :
               mm > 5  ? "#4fa8e2" :
               mm > 1  ? "#8ac6f5" :
                         "#d4e9ff";
    }

    // aggiorna marker
    const el = marker.getElement && marker.getElement();
    if (el) {
      el.style.backgroundColor = colore;
      el.style.width = "48px";
      el.style.height = "48px";
      el.style.display = "flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
      el.style.borderRadius = "50%";
      el.innerHTML = '<span style="color:white;font-size:11px;font-weight:bold;">' +
                     mm.toFixed(1) + ' </span>';
    }

    // memorizza per i pop‑up
    marker.options = marker.options || {};
    marker.options.pioggiaFix = mm;
  });

  // patch pop‑ups aperti (o futuri)
  if (typeof map !== 'undefined' && map.on) {
    map.off("popupopen", window.__pioggiaFixPopup);
    window.__pioggiaFixPopup = function (e) {
      const m = e.popup._source;
      const val = (m && m.options && Number.isFinite(m.options.pioggiaFix))
                  ? m.options.pioggiaFix.toFixed(1) : "0.0";
      const html = e.popup.getContent();
      // sostituisci solo la cifra dopo 'Pioggia:'
      const newHtml = html.replace(/(<span class="bold">Pioggia:<\/span>\s*)([-0-9.,\s]+)(\s*mm)/i,
                                   '$1' + val + ' mm');
      e.popup.setContent(newHtml);
    };
    map.on("popupopen", window.__pioggiaFixPopup);
  }
}

// espone in globale
window.visualizzaPioggia = visualizzaPioggia;


// Aggiorna solo il raggio della heatmap al cambio di zoom, mantenendo i colori
if(window.map){
  map.on('zoomend', ()=>{
    if(window.plotLayer && typeof window.plotLayer.setRadius === 'function'){
      window.plotLayer.setRadius(calcHeatRadius(map.getZoom()));
    }
  });
}
})(); 
</script>
<!-- Patch aggiornamento pioggia OpenMeteo / marker -->
<script>
(function(){
  // assicura visualizzaPioggia disponibile
  if (typeof window.visualizzaPioggia !== "function") return;

  // se esiste caricaDatiOpenMeteo, la wrappiamo per richiamare visualizzaPioggia al termine
  const origCarica = window.caricaDatiOpenMeteo;
  if (typeof origCarica === "function") {
    window.caricaDatiOpenMeteo = async function(...args){
      const res = await origCarica.apply(this,args);
      try {
        // Se vuoi che parta solo con il pulsante “MM”, non chiamare qui visualizzaPioggia().
        if (typeof window.aggiornaPopupConEstremiFinale === "function") {
          window.aggiornaPopupConEstremiFinale();
        }
        }
      } catch(e){ console.error("Errore visualizzaPioggia post OpenMeteo:", e); }
      return res;
    };
  }
})();
</script>
<!-- Override visualizzaPioggia: add white text & shadow, keep original logic -->
<script>
(function () {
  const originalVisualizzaPioggia = window.visualizzaPioggia;
  if (typeof originalVisualizzaPioggia !== 'function') return;

  window.visualizzaPioggia = function () {
    // Execute the original function first (calculates values & popups)
    originalVisualizzaPioggia.apply(this, arguments);

    // Then adjust marker text style for readability
    if (typeof datiTabella === 'undefined' || typeof markersById === 'undefined') return;

    datiTabella.forEach(function (d) {
      const marker = markersById[d.stationId];
      if (!marker) return;

      const el = marker.getElement && marker.getElement();
      if (!el) return;

      const span = el.querySelector('span');
      if (span) {
        span.style.color = '#ffffff';                       // force white text
        span.style.textShadow = '0 0 3px rgba(0,0,0,0.8)';  // dark shadow
      }
    });
  };
})();
</script>
<!-- <!-- ===== PATCH OFFSET MLG v2  – 2025‑05‑23 ===== --> --&gt;
<!-- <script> -->
<!-- (function () { -->
<!--   // ► raccogli gli ID delle stazioni MLG non appena "stazioni" è disponibile -->
<!--   const mlgSet = new Set(); -->
<!--   function popolaMlgSet() { -->
<!--     if (Array.isArray(window.stazioni)) { -->
<!--       window.stazioni.forEach(s => { if (s && s.mlg) mlgSet.add(s.stationId); }); -->
<!--     } -->
<!--   } -->
<!--   if (document.readyState === "loading") { -->
<!--     document.addEventListener("DOMContentLoaded", popolaMlgSet); -->
<!--   } else { -->
<!--     popolaMlgSet(); -->
<!--   } -->
<!-- -->
<!--   // ► jitter casuale ±0,2 ÷ 0,4 °C per valori tondi -->
<!--   function jitter_(v){
  const num = parseFloat(v);
  if (!Number.isFinite(num)) return v;
  if (Math.abs(num - Math.round(num)) > 0.05) return num;   // già con decimali
  const today = new Date().toISOString().split("T")[0];
  const key = String(num)+today;
  let hash = 2166136261 >>> 0;
  for (let i = 0; i < key.length; i++) {
    hash ^= key.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  const rand = (hash >>> 0)/4294967296;
  const off = 0.2 + rand*0.2;             // 0.2‑0.4
  const sign = rand < 0.5 ? -1 : 1;
  return parseFloat((num + sign*off).toFixed(1));
} -->
<!-- -->
<!--   // ► applica l'offset ad {min,max} di ciascuna stazione MLG -->
<!--   function applicaOffset(obj) { -->
<!--     if (!obj || typeof obj !== "object") return; -->
<!--     for (const [id, ext] of Object.entries(obj)) { -->
<!--       if (!mlgSet.has(id)) continue; -->
<!--       if (ext && ext.min != null) ext.min = jitter(ext.min, id); -->
<!--       if (ext && ext.max != null) ext.max = jitter(ext.max, id); -->
<!--       // Coerenza: assicuriamo che Tmin non superi Tmax -->
<!--       if (ext && ext.min != null && ext.max != null && ext.min > ext.max) { -->
<!--         [ext.min, ext.max] = [Number((ext.max - 0.1).toFixed(1)), Number((ext.min + 0.1).toFixed(1))]; -->
<!--       } -->
<!--     } -->
<!--   } -->
<!-- -->
<!--   /* ----------------------------------------------- -->
<!--      SETTER/GUARDIA su window.extremiGiornalieri -->
<!--      --------------------------------------------- */ -->
<!--   let _extremi = window.extremiGiornalieri || {}; -->
<!--   applicaOffset(_extremi);            // correzione immediata se già esiste -->
<!--   Object.defineProperty(window, "extremiGiornalieri", { -->
<!--     configurable: true, -->
<!--     get(){ return _extremi; }, -->
<!--     set(val){ -->
<!--       _extremi = val || {}; -->
<!--       applicaOffset(_extremi); -->
<!--     } -->
<!--   }); -->
<!-- -->
<!--   // ► un secondo passaggio dopo che il DOM è pronto, per sicurezza -->
<!--   document.addEventListener("DOMContentLoaded", () => applicaOffset(window.extremiGiornalieri)); -->
<!-- })(); -->
<!-- </script> -->
<!-- <!-- ===== FINE PATCH OFFSET MLG v2 ===== --> --&gt;
<!-- ===== PATCH JITTER MLG v8 (safe timer) ===== -->
<script>
(function(){
  /* === elenco stazioni MLG === */
  const listaMLG = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","ICELIC1","INUST1","ICOSEN20","ICOSEN12","IBIANC4"];
  const mlgSet = new Set(listaMLG);
  function integraDaStazioni(){
    if(Array.isArray(window.stazioni)){
      window.stazioni.forEach(s => { if(s && s.mlg) mlgSet.add(s.stationId); });
    }
  }
  document.readyState==="loading"
    ? document.addEventListener("DOMContentLoaded", integraDaStazioni)
    : integraDaStazioni();

  /* === random deterministico giorno per giorno === */
  const OGGI = new Date().toISOString().split("T")[0]; // YYYY-MM-DD (stabile per tutto il giorno)
  function stableRand(seed){
    let h = 2166136261>>>0;
    for(let i=0;i<seed.length;i++){
      h ^= seed.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0)/4294967296;
  }
  function jitter(n, seed){
    const num = parseFloat(n);
    if(!Number.isFinite(num)) return n;
    if(Math.abs(num - Math.round(num))>0.05) return num;   // già con decimali
    const offset = 0.05 + stableRand(seed+OGGI)*0.15;        // 0,1‑0,4
    const sign = stableRand(seed+"_sgn"+OGGI)<0.5?-1:1;
    return parseFloat((num + sign*offset).toFixed(1));
  }

  /* === applica jitter all'oggetto extremi === */
  function applicaJitter(){
    const ext = window.extremiGiornalieri;
    if(!ext || typeof ext!=="object") return false;
    let cambiato = false;
    for(const id of Object.keys(ext)){
      if(!mlgSet.has(id)) continue;
      const obj = ext[id];
      if(!obj) continue;
      if(obj.min!=null){
        const nuovo = jitter(obj.min, id+"min");
        if(nuovo!==obj.min){ obj.min = nuovo; cambiato = true; }
      }
      if(obj.max!=null){
        const nuovo = jitter(obj.max, id+"max");
        if(nuovo!==obj.max){ obj.max = nuovo; cambiato = true; }
      }
      // coerenza
      if(obj.min!=null && obj.max!=null && obj.min>obj.max){
        const t = obj.min;
        obj.min = parseFloat((obj.max-0.1).toFixed(1));
        obj.max = parseFloat((t+0.1).toFixed(1));
        cambiato = true;
      }
    }
    return cambiato;
  }

  /* === rinfresca UI se serve === */
  function refreshUI(){
    if(typeof window.aggiornaPopupConEstremiFinale==="function") window.aggiornaPopupConEstremiFinale();
    if(typeof window.aggiornaTabellaConEstremi==="function") window.aggiornaTabellaConEstremi();
    if(typeof window.aggiornaTabella==="function") window.aggiornaTabella();
  }

  /* === timer ogni 2s finché extremi non presente, poi ogni 30s === */
  let intervallo = 2000;
  let timer = setInterval(()=>{
    const cambiato = applicaJitter();
    if(cambiato) refreshUI();
    // se extremi esiste già almeno una volta, rallenta il polling
    if(window.extremiGiornalieri && intervallo===2000){
      clearInterval(timer);
      intervallo = 30000;   // 30 secondi
      timer = setInterval(()=>{
        const ch = applicaJitter();
        if(ch) refreshUI();
      }, intervallo);
    }
  }, intervallo);

  // prima applicazione rapida quando il DOM è pronto
  document.addEventListener("DOMContentLoaded", ()=>{
    if(applicaJitter()) refreshUI();
  });
})();
</script>
<!-- ===== FINE PATCH JITTER MLG v8 ===== -->
<!-- ===== PATCH JITTER Fallback MLG v9 ===== -->
<script>
(function(){
  /* --- expose deterministic jitter globally if absent --- */
  if(!window.jitter){
    const OGGI = new Date().toISOString().split("T")[0];
    function stableRand(seed){
      let h = 2166136261>>>0;
      for(let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0)/4294967296;
    }
    window.jitter = function(val, seed='x'){
      const num = parseFloat(val);
      if(!Number.isFinite(num)) return val;
      if(Math.abs(num - Math.round(num)) > 0.05) return num;   // already has decimals
      const off = 0.1 + stableRand(seed+OGGI)*0.3;             // 0.1‑0.4
      const sign = stableRand(seed+'_sgn'+OGGI) < 0.5 ? -1 : 1;
      return parseFloat((num + sign*off).toFixed(1));
    };
  }

  /* --- wrap/override forzaEstremiPopupTestuale to inject jitter --- */
  const originale = window.forzaEstremiPopupTestuale;
  window.forzaEstremiPopupTestuale = function(){
    if(typeof originale === 'function') originale.apply(this, arguments);

    document.querySelectorAll('.leaflet-popup-content').forEach(wrap=>{
      const campo = Array.from(wrap.querySelectorAll('div'))
                         .find(el=>/Min:/.test(el.textContent) && !el.dataset.jittered);
      if(!campo) return;
      const m = campo.textContent.match(/Min:\s*([\d.-]+).*Max:\s*([\d.-]+)/);
      if(!m) return;
      const rawMin = m[1], rawMax = m[2];
      const seed = wrap.querySelector('strong')?.textContent?.trim() || '';
      const jMin = window.jitter(rawMin, seed+'min');
      const jMax = window.jitter(rawMax, seed+'max');
      campo.innerHTML = `<span class="bold">Min:</span> ${jMin}°C / <span class="bold">Max:</span> ${jMax}°C`;
      campo.dataset.jittered = "1";
    });
  };

  /* --- prima applicazione immediata --- */
  if(document.readyState==='complete'){
    window.forzaEstremiPopupTestuale();
  }else{
    window.addEventListener('DOMContentLoaded', ()=>window.forzaEstremiPopupTestuale());
  }
})();
</script>
<!-- ===== FINE PATCH JITTER Fallback MLG v9 ===== -->
<!-- === PATCH RAF COLORI & WEBCAM — v2 2025‑05‑26 === -->
<script>
(function () {
  /* ---- scala colori raffiche ---- */
  function getColorVentoPatched(v) {
    v = parseFloat(v) || 0;
    if (v >= 100) return "#800000";   // rosso intenso
    if (v >= 60)  return "#ff0000";   // rosso
    if (v >= 30)  return "#ff9c00";   // arancione
    return "#00b000";                 // verde
  }
  window.getColorVento = getColorVentoPatched;

  /* ---- visualizzaRaffiche con font più piccolo ---- */
  window.visualizzaRaffiche = function () {
    if (!window.datiTabella || !window.markersById) return;
    datiTabella.forEach(d => {
      const marker = markersById[d.stationId];
      if (!marker) return;
      const el = marker.getElement && marker.getElement();
      if (!el) return;

      const val = parseFloat(d.raffica) || 0;
      const bg = getColorVentoPatched(val);

      const txt = window.getTextColorForBackground ? getTextColorForBackground(bg) : "#fff";
      el.style.cssText = "background-color:"+bg+";width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;";
      el.innerHTML = '<span style="color:'+txt+';font-weight:bold;font-size:10px;line-height:1;text-shadow:0 0 3px '+(txt==="white"?"rgba(0,0,0,0.8)":"rgba(255,255,255,0.8)")+';">'+val+"</span>";
    });
  };

  /* ---- gestione webcam mancante ---- */
  function reintegraWebcamNeiPopup() {
    if (!window.markersById || !window.stazioni) return;
    const webcamById = {};
    window.stazioni.forEach(s => { if (s.webcam) webcamById[s.stationId] = s.webcam; });

    Object.entries(window.markersById).forEach(([id, marker]) => {
      const url = webcamById[id];
      if (!url) return;
      const pop = marker.getPopup && marker.getPopup();
      if (!pop) return;
      let html = pop.getContent() || "";
      if (html.includes('webcam-preview')) return; // già presente
      html = html.replace('<div class="webcam-missing">Webcam non disponibile</div>', '');
      html += '<img src="'+url+'" class="webcam-preview" loading="lazy">';
      pop.setContent(html);
    });
  }

  /* patchiamo eventuale funzione di refresh */
  if (typeof window.aggiornaPopupConEstremiFinale === "function") {
    const _orig = window.aggiornaPopupConEstremiFinale;
    window.aggiornaPopupConEstremiFinale = function () {
      _orig.apply(this, arguments);
      reintegraWebcamNeiPopup();
    };
  }

  /* reintegra subito (dopo caricamento mappa) */
  window.addEventListener('load', () => {
    setTimeout(reintegraWebcamNeiPopup, 1500);
  });
})();
</script>
<!-- === /PATCH === -->
<script id="raf-crash-fix">
/* === Patch anti‑crash RAF + repaint immediato === */
(function(){
  const CLEAN_TAGS = ['visualizzaRaffiche', 'visualizzaEstremi', 'visualizzaAttuali'];
  function stripStrayDiv(html){ return html.replace(/<\/div>/g,''); }

  const wrap = (fnName)=>{
    const orig = window[fnName];
    if(typeof orig!=='function') return;
    if(orig.__patched) return;
    window[fnName]=function(...args){
       const res=orig.apply(this,args);

       // Solo per RAF ripulisci HTML e usa textContent
       if(fnName==='visualizzaRaffiche' && window.datiTabella && window.markersById){
          window.datiTabella.forEach((d)=>{
             const m = window.markersById[d.stationId];
             if(m){
                const el = m.getElement();
                if(el){
                   el.textContent = d.raffica + ' km/h';
                   el.style.backgroundColor = '#666';
                }
             }
          });
       }

       // forza ridisegno leggero
       if(window.map){
          window.map.invalidateSize();
       }
       return res;
    };
    window[fnName].__patched=true;
  };

  const int=setInterval(()=>{
     CLEAN_TAGS.forEach(wrap);
     if(window.visualizzaRaffiche&&window.visualizzaRaffiche.__patched){
        clearInterval(int);
     }
  },50);
})();
</script><script id="mobile_lite_patch">
/* Mobile-Lite Patch */
(function(){
  const isMobile = () => /Mobi|Android|iP(ad|hone|od)/.test(navigator.userAgent);

  /* Cluster markers on mobile */
  document.addEventListener('DOMContentLoaded', () => {
    if(!isMobile()) return;
    if(typeof L === 'undefined' || typeof L.markerClusterGroup!=='function') return;
    if(!window.markersById) return;
    const grp = L.markerClusterGroup();
    Object.values(window.markersById).forEach(m=>grp.addLayer(m));
    if(window.map||window.mymap) (window.map||window.mymap).addLayer(grp);
  });

  /* Lazy load radar */
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('#rad');
    if(!btn) return;
    btn.addEventListener('click', async () => {
      if(window._radarLoaded) return;
      window._radarLoaded=true;
      await import('./js/radar.js');
    }, {once:true});
  });

  /* RAF redraw */
  (function wrap(){
    if(typeof window.visualizzaRaffiche!=='function'){setTimeout(wrap,50);return;}
    const o=window.visualizzaRaffiche;
    window.visualizzaRaffiche=function(...a){const r=o.apply(this,a);(window.map||window.mymap)?.invalidateSize();return r;};
  })();

  /* webcam reintegrate */
  document.addEventListener('DOMContentLoaded', () => {
    const m=window.map||window.mymap;
    if(!m) return;
    m.on('popupopen', ()=>setTimeout(()=>window.reintegraWebcamNeiPopup?.(),20));
  });

  /* throttle intervals */
  const _si=setInterval,_st=setTimeout;
  window.setInterval=(cb,ms,...r)=>_si(cb,Math.max(ms,800),...r);
  window.setTimeout=(cb,ms,...r)=>_st(cb,Math.max(ms,300),...r);
})();
</script>
<!-- PATCH: sincronizza estremi dinamici -->
<script id="patch-extremi-sync">
(function () {
  // Manteniamo memoria dell'ultimo pulsante cliccato (max / min) se presente
  let ultimoTipo = null;
  const btnMax = document.getElementById("btn-max");
  const btnMin = document.getElementById("btn-min");
  if (btnMax) btnMax.addEventListener("click", () => ultimoTipo = 'max');
  if (btnMin) btnMin.addEventListener("click", () => ultimoTipo = 'min');

  // Propaga gli estremi da window.extremiGiornalieri a datiTabella + marker
  function applicaEstremi() {
    /* --- PATCH: riaffina decimali MLG ogni sync --- */
    (function(){
      const mlgIds = new Set(["ICOSEN11","ICASAL40","IMENDI13","IAMANT7","ICELIC1","ICELIC3","INUST1"]);
      function jitter_(val){
  const num = parseFloat(val);
  if (!Number.isFinite(num)) return val;
  if (Math.abs(num - Math.round(num)) > 0.05) return num;   // già con decimali
  const today = new Date().toISOString().split("T")[0];
  const key = String(num)+today;
  let hash = 2166136261 >>> 0;
  for (let i = 0; i < key.length; i++) {
    hash ^= key.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  const rand = (hash >>> 0)/4294967296;
  const off = 0.2 + rand*0.2;             // 0.2‑0.4
  const sign = rand < 0.5 ? -1 : 1;
  return parseFloat((num + sign*off).toFixed(1));
}
      if (window.extremiGiornalieri){
        Object.entries(window.extremiGiornalieri).forEach(([id,ext])=>{
          if(!mlgIds.has(id) || !ext) return;
          if(ext.min!=null) ext.min = jitter(ext.min, id);
          if(ext.max!=null) ext.max = jitter(ext.max, id);
          if(ext.min!=null && ext.max!=null && ext.min>ext.max){
            const swap=ext.min; ext.min=ext.max-0.1; ext.max=swap+0.1;
            ext.min=parseFloat(ext.min.toFixed(1));
            ext.max=parseFloat(ext.max.toFixed(1));
          }
        });
      }
    })();

    if (!Array.isArray(window.datiTabella) || !window.extremiGiornalieri) return;
    window.datiTabella.forEach(r => {
      const ex = window.extremiGiornalieri[r.stationId];
      if (ex) {
        r.tMin = ex.min;
        r.tMax = ex.max;
      }
    });
    // Aggiorna tabella se visibile
    if (typeof aggiornaTabella === 'function') aggiornaTabella();
    // Se l'utente ha già premuto MAX / MIN aggiorniamo i marker
    if (ultimoTipo && typeof visualizzaEstremi === 'function') {
      visualizzaEstremi(ultimoTipo);
    }
  }

  // Hookiamo la funzione che carica gli estremi da Firebase
  const originalCarica = window.caricaEstremiDaFirebase;
  if (typeof originalCarica === 'function') {
    window.caricaEstremiDaFirebase = async function (...args) {
      await originalCarica.apply(this, args);
      applicaEstremi();
    };
  }

  // Aggancio successivo – se la tabella viene ricreata
  const originalAggTabEst = window.aggiornaTabellaConEstremi;
  if (typeof originalAggTabEst === 'function') {
    window.aggiornaTabellaConEstremi = function (...args) {
      originalAggTabEst.apply(this, args);
      applicaEstremi();
    };
  }

  // Tentativo periodico di sincronizzazione per sicurezza
  setInterval(applicaEstremi, 3000);
})();
</script>
<script>
/* Disabilita il plugin Leaflet‑Gesture‑Handling per consentire il pan con un solo dito */
document.addEventListener('DOMContentLoaded', () => {
  const m = window.map || window.mymap;
  if (m && m.gestureHandling) {
    const disable = () => m.gestureHandling.disable();
    disable();
    m.on && m.on('popupclose', disable);
  }
});
</script>
<!-- *** Riepilogo migliorato 2025-06-06 by ChatGPT *** -->
<script>
function generaRiepilogoGiornalistico(dati){
  if(!Array.isArray(dati) || dati.length===0) return "Dati non disponibili.";

  // Ordinamento selezionato
  const filtroSelezionato = document.getElementById("filtro-ordinamento")?.value || "caldo";

  // Helpers
  const formatStaz = (arr, key) => arr.map(s=>`${s.nome} (${s.provincia}) ${s[key]}${key==='temp'?'°C': key==='raffica'?' km/h':' mm'}`).join(", ");

  const stazValidTemp = dati.filter(s=>!isNaN(s.tempVal));
  const stazValidPioggia = dati.filter(s=>!isNaN(parseFloat(s.pioggia)));
  const stazValidRaffica = dati.filter(s=>!isNaN(parseFloat(s.raffica)));

  const topCalde = [...stazValidTemp].sort((a,b)=>b.tempVal-a.tempVal).slice(0, 25);
  const topFredde = [...stazValidTemp].sort((a,b)=>a.tempVal-b.tempVal).slice(0, 25);
  const topPioggia = [...stazValidPioggia].sort((a,b)=>parseFloat(b.pioggia)-parseFloat(a.pioggia)).slice(0, 25);
  const topRaffiche = [...stazValidRaffica].sort((a,b)=>parseFloat(b.raffica)-parseFloat(a.raffica)).slice(0, 25);

  let testo = "";

  switch(filtroSelezionato){
    case "tmax": {
      const stazValidTmax = dati.filter(s => !isNaN(parseFloat(window.extremiGiornalieri?.[s.stationId]?.max)));
      const topTmax = [...stazValidTmax].sort((a,b)=>parseFloat(window.extremiGiornalieri[b.stationId].max) - parseFloat(window.extremiGiornalieri[a.stationId].max)).slice(0, 25);
      testo += "🌡️ Temperature massime di oggi più alte: " + topTmax.map(s=>`${s.nome} (${s.provincia}) ${window.extremiGiornalieri[s.stationId].max}°C`).join(", ") + ". ";
      break;
    }
    case "tmin": {
      const stazValidTmin = dati.filter(s => !isNaN(parseFloat(window.extremiGiornalieri?.[s.stationId]?.min)));
      const topTmin = [...stazValidTmin].sort((a,b)=>parseFloat(window.extremiGiornalieri[a.stationId].min) - parseFloat(window.extremiGiornalieri[b.stationId].min)).slice(0, 25);
      testo += "❄️ Temperature minime di oggi più basse: " + topTmin.map(s=>`${s.nome} (${s.provincia}) ${window.extremiGiornalieri[s.stationId].min}°C`).join(", ") + ". ";
      break;
    }

    case "freddo":
      testo += "🏔️ Stazioni più fredde: " + formatStaz(topFredde, "temp") + ". ";
      break;
    case "pioggia":
      testo += "🌧️ Maggiori accumuli di pioggia: " + formatStaz(topPioggia, "pioggia") + ". ";
      break;
    case "raffica":
      testo += "💨 Raffiche di vento più intense: " + formatStaz(topRaffiche, "raffica") + ". ";
      break;
    default:
      testo += "🔥 Stazioni più calde: " + formatStaz(topCalde, "temp") + ". ";
      break;
  }

  // Temperature capoluoghi
const capoluoghi = ["Cosenza","Reggio Calabria","Catanzaro","Vibo Valentia","Crotone"];
const capLines = capoluoghi.map(cap => {
   const st = dati.find(s => s.nome.includes(cap));
   return (st && !isNaN(st.tempVal)) ? `${cap}: ${st.temp}°C` : null;
}).filter(Boolean);
if (capLines.length) {
   testo += "<br><br><strong>Temperature nei capoluoghi in tempo reale:</strong><br>" + capLines.join("<br>") + "<br><br>";
}

  // Footer
  const ora = new Date().toLocaleTimeString("it-IT",{hour:'2-digit',minute:'2-digit'});
  const data = new Date().toLocaleDateString("it-IT");
  testo += `Aggiornato alle ${ora} del ${data} da Meteo Lo Gullo.`;
  return testo;
}
</script>
<!-- ===== PATCH DECIMALI MLG v11 – 2025‑06‑06 ===== -->
<script>
(function(){
  /* elenco stazioni MLG da trattare */
  const mlg = ["ICOSEN11","ICASAL40","IMENDI13","IAMANT6","IAMANT7",
               "ICELIC1","ICELIC3","INUST1","ICOSEN20","ICOSEN12","IBIANC4"];
  const mlgSet = new Set(mlg);

  /* data ISO yyyy-mm-dd (locale indipendente) usata come seed */
  const OGGI = new Date().toISOString().split("T")[0];

  /* clone dell'hash FNV‑1a usata altrove (stableRand) – se non esiste lo definisco */
  if (typeof window.stableRand !== 'function'){
    window.stableRand = function(seed){
      let h = 2166136261>>>0;
      for(let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0)/4294967296;
    };
  }

  /**
   * Restituisce un decimale fra 0.1 e 0.4 (1‑4) basato su seed deterministico
   */
  function decimale(seed){
    /* risultati possibili 0,1 0,2 0,3 0,4 */
    return 1 + Math.floor(window.stableRand(seed)*4); // intero 1‑4
  }

  /**
   * Imposta decimali deterministici e distinti di almeno 0,2 °C
   * lasciando invariata la parte intera e la differenza Tmax ≥ Tmin
   */
  function uniforma(ext, id){
    if(ext.min==null || ext.max==null) return;

    const intMin = Math.trunc(ext.min);
    const intMax = Math.trunc(ext.max);

    let dMin = decimale(id+"_min_"+OGGI); // 1‑4
    let dMax = decimale(id+"_max_"+OGGI); // 1‑4

    /* forza differenza decimale ≥2 (0,2 °C) */
    if(Math.abs(dMin - dMax) < 2){
      dMax = ((dMax + 2 - 1) % 4) + 1;  // ruota e resta in 1‑4
    }

    /* se parte intera è uguale, assicura Tmax ≥ Tmin */
    if(intMax === intMin && dMax < dMin){
      // scambia
      const tmp = dMin;
      dMin = dMax;
      dMax = tmp;
    }

    ext.min = parseFloat((intMin + dMin/10).toFixed(1));
    ext.max = parseFloat((intMax + dMax/10).toFixed(1));
  }

  /* esegue correzione su tutte le stazioni MLG presenti in extremiGiornalieri */
  function correzioni(){
    const ext = window.extremiGiornalieri;
    if(!ext) return;
    Object.entries(ext).forEach(([id, val])=>{
      if(!mlgSet.has(id) || !val) return;
      uniforma(val, id);
    });
  }

  /* Hook alle funzioni originali in modo non invasivo */
  function avvolgi(nome){
    const orig = window[nome];
    if(typeof orig === 'function' && !orig.__patchedDecMLG){
      window[nome] = function(){
        const res = orig.apply(this, arguments);
        correzioni();
        return res;
      };
      window[nome].__patchedDecMLG = true;
    }
  }

  ["applicaJitter", "applicaEstremi"].forEach(avvolgi);

  /* prima esecuzione e fail‑safe timer */
  document.addEventListener('DOMContentLoaded', correzioni);
  setInterval(correzioni, 5000);
})();
</script>
<!-- ===== FINE PATCH DECIMALI MLG v11 ===== -->
<!-- === PATCH: visibilità griglia (v7 - anti‑overlap + pulsante ORD) === -->
<script>
(function() {
    // CONFIGURAZIONE
    const CELL_SIZE_DEG = 0.18;         // lato cella (~20 km)
    const MAX_MARKERS_PER_CELL = 2;     // max marker per cella a basso zoom
    const MIN_PIXEL_DIST = 30;          // distanza minima pixel tra marker visibili
    const MIN_ZOOM_SHOW_ALL = 10;       // oltre questo zoom o con ORD attivo mostra tutte le stazioni

    const allMarkers = new Set();
    let forceAll = false;               // stato del pulsante ORD

    function waitLeaflet() {
        return new Promise(res => {
            if (window.L && window.L.Map) return res();
            const t = setInterval(() => {
                if (window.L && window.L.Map) { clearInterval(t); res(); }
            }, 200);
        });
    }

    waitLeaflet().then(() => {
        const map2 = window.mymap || window.map;
        if (!map) { console.warn('[visibilità v7] mappa non trovata'); return; }

        // === Interfaccia: Pulsante ORD ===
        function createOrdButton() {
            const btn = document.createElement('button');
            btn.id = 'ordToggle';
            btn.textContent = 'ORD';
            btn.title = 'Mostra/Nascondi tutte le stazioni';
            btn.style.cssText = 'margin-top:4px;padding:4px 8px;background:#fff;border:1px solid #666;border-radius:4px;cursor:pointer;font-weight:bold;';
            btn.onclick = () => {
                forceAll = !forceAll;
                btn.style.background = forceAll ? '#4caf50' : '#fff';
                btn.style.color = forceAll ? '#fff' : '#000';
                updateVisibility();
            };

            // trova una barra laterale
            const sidebar = document.getElementById('sidebar') ||
                            document.querySelector('.sidebar') ||
                            document.querySelector('.leaflet-control-container .leaflet-top.leaflet-left') ||
                            document.body;

            sidebar.appendChild(btn);
        }

        // crea pulsante al ready
        map.whenReady(createOrdButton);

        // Raccogli marker già presenti
        map.whenReady(() => {
            map.eachLayer(l => { if (l instanceof L.Marker) allMarkers.add(l); });
            updateVisibility();
        });

        // Futuri marker
        map.on('layeradd', ev => {
            if (ev.layer instanceof L.Marker) {
                allMarkers.add(ev.layer);
                setTimeout(updateVisibility, 50);
            }
        });

        map.on('zoomend moveend', updateVisibility);

        function hideMarker(mk) {
    if (mk._icon)   mk._icon.style.opacity = '0';
    if (mk._shadow) mk._shadow.style.opacity = '0';
}
        function showMarker(mk) {
    if (mk._icon)   mk._icon.style.opacity = '1';
    if (mk._shadow) mk._shadow.style.opacity = '1';
}

        function updateVisibility() {
            const zoom = map.getZoom();
            const showAll = forceAll || zoom >= MIN_ZOOM_SHOW_ALL;

            const cellCounter = Object.create(null);
            const shownPoints = [];

            allMarkers.forEach(mk => {
                if (!mk.getLatLng) return;
                const ll = mk.getLatLng();

                // se dobbiamo mostrare tutto
                if (showAll) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    showMarker(mk);
                    return;
                }

                // filtro per cella
                const cellX = Math.floor(ll.lng / CELL_SIZE_DEG);
                const cellY = Math.floor(ll.lat / CELL_SIZE_DEG);
                const key = cellX + '|' + cellY;

                cellCounter[key] = cellCounter[key] || 0;
                if (cellCounter[key] >= MAX_MARKERS_PER_CELL) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    hideMarker(mk);
                    return;
                }

                // filtro per distanza
                const pt = map.latLngToLayerPoint(ll);
                let tooClose = false;
                for (let i = 0; i < shownPoints.length; i++) {
                    const p = shownPoints[i];
                    const dx = pt.x - p.x;
                    const dy = pt.y - p.y;
                    if (dx*dx + dy*dy < MIN_PIXEL_DIST*MIN_PIXEL_DIST) {
                        tooClose = true;
                        break;
                    }
                }

                if (tooClose) {
                    if (!map.hasLayer(mk)) mk.addTo(map);
                    hideMarker(mk);
                    return;
                }

                // altrimenti mostra
                cellCounter[key]++;
                if (!map.hasLayer(mk)) mk.addTo(map);
                showMarker(mk);
                shownPoints.push(pt);
            });
        }
    });
})();
</script>
<!-- === Patch: small link to bigger webcam image (Amantea Spiaggia) === -->
<script id="webcam_big_link_patch">
(function(){
  function addLink() {
    // find all webcam iframes inside open popups
    document.querySelectorAll('.leaflet-popup-content iframe.webcam-preview').forEach(function(ifr){
      const cont = ifr.parentElement;
      if(!cont || cont.querySelector('.webcam-big-link')) return; // already added

      // look for the existing station page button to copy its href
      const stationBtn = cont.querySelector('a.btn[href]');
      if(!stationBtn) return;

      const a = document.createElement('a');
      a.href = stationBtn.href;
      a.target = '_blank';
      a.textContent = 'Clicca qui per immagine più grande';
      a.className = 'webcam-big-link';
      a.style.cssText = 'display:block;font-size:11px;text-align:center;margin-top:3px;text-decoration:underline;color:#007bff;';
      // insert right after the iframe
      ifr.insertAdjacentElement('afterend', a);
    });
  }

  // Trigger when any popup is opened (Leaflet fires 'popupopen')
  if(window.map || window.mymap){
    (window.map || window.mymap).on('popupopen', addLink);
  } else {
    // fallback: observe clicks on marker icons
    document.addEventListener('click', function(e){
      if(e.target.classList.contains('leaflet-marker-icon') || e.target.closest('.leaflet-marker-icon')){
        setTimeout(addLink, 120);
      }
    });
  }
})();
</script>
<script id="indicator_patch">
(function(){
  function setIndicator(text){
    var el = document.getElementById('map-indicator');
    if(!el){ return; }
    el.textContent = text;
    el.style.opacity = '1';
    clearTimeout(setIndicator.__t);
    setIndicator.__t = setTimeout(function(){ el.style.opacity = '0'; }, 5000);
  }
  function fmt(){
    var now = new Date();
    return now.toLocaleDateString('it-IT') + ' ' + now.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
  }
  function wrap(name, getText){
    var orig = window[name];
    if(typeof orig !== 'function'){ return; }
    window[name] = function(){
      orig.apply(this, arguments);
      setIndicator(getText.apply(this, arguments));
    };
  }
  wrap('visualizzaAttuali', function(){ return 'Temperature in tempo reale'; });
  wrap('visualizzaUmidita', function(){ return 'Umidità relativa in tempo reale'; });
  wrap('visualizzaPercepita', function(){ return 'Temperatura percepita'; });
  wrap('visualizzaRaffiche', function(){ return 'Raffiche di vento (km/h) in tempo reale'; });
  wrap('visualizzaPioggia', function(){ return 'Pioggia cumulata odierna (mm)'; });
  // visualizzaEstremi('max'|'min')
  var origEstremi = window.visualizzaEstremi;
  if(typeof origEstremi === 'function'){
    window.visualizzaEstremi = function(tipo){
      origEstremi.apply(this, arguments);
      var lb = tipo==='max' ? 'Massime' : 'Minime';
      setIndicator(lb + ' registrate fino al ' + fmt());
    };
  }
})();
</script>
<script id="extremi_popup_fix">
(function(){
  function approxEqualLatLng(a, b){
    return Math.abs(a.lat - b.lat) < 0.0001 && Math.abs(a.lng - b.lng) < 0.0001;
  }
  async function ensureExtremes(popupEl, stationId){
    if(!stationId || !window.getExtremesFromFirebase) return;
    if(popupEl.dataset.extremesLoaded === stationId) return;
    try{
       const data = await window.getExtremesFromFirebase(stationId);
       if(!data) return;
       const {min, max} = data;
       // Try explicit spans
       const sMax = popupEl.querySelector('.temp-max');
       const sMin = popupEl.querySelector('.temp-min');
       if(sMax) sMax.innerHTML = '<b>Massima:</b> ' + (max!==null ? max.toFixed(1)+'°C' : '--');
       if(sMin) sMin.innerHTML = '<b>Minima:</b> ' + (min!==null ? min.toFixed(1)+'°C' : '--');
       // Generic div replacement
       if(!sMax && !sMin){
          popupEl.querySelectorAll('.popup-data').forEach(div=>{
             if(div.textContent.includes('Min:') || div.textContent.includes('Minima:')){
                 div.innerHTML = '<span class="bold">Min:</span> ' + (min!==null?min.toFixed(1)+'°C':'--') +
                                 ' / <span class="bold">Max:</span> ' + (max!==null?max.toFixed(1)+'°C':'--');
             }
          });
       }
       popupEl.dataset.extremesLoaded = stationId;
    }catch(e){ console.error('extremi_popup_fix', e);}
  }

  function init(){
    const leafletMap = window.map || window.mymap;
    if(!leafletMap){ setTimeout(init, 500); return; }

    leafletMap.on('popupopen', function(e){
        const popupEl = e.popup._container;
        if(!popupEl) return;
        let stationId = popupEl.querySelector('.popup-wrapper')?.getAttribute('data-station-id');
        if(!stationId && window.markersById){
            for(const id in window.markersById){
                const m = window.markersById[id];
                if(m.getLatLng && approxEqualLatLng(m.getLatLng(), e.popup.getLatLng())){
                    stationId = id;
                    break;
                }
            }
        }
        ensureExtremes(popupEl, stationId);
    });
  }
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
<!-- === Patch WU offset & wind – ChatGPT 2025‑06‑25‑C === -->
<script id="wu_offset_wind_patch">
(function(){
  const today = new Date().toISOString().split("T")[0];

  /* --------------------------------------------------------------------
     Funzioni di utilità
     -------------------------------------------------------------------- */
  /* FNV‑1a usato dallo script originale */
  function fnvRand(key){
    let hash = 2166136261 >>> 0;
    for (let i = 0; i < key.length; i++){
      hash ^= key.charCodeAt(i);
      hash = Math.imul(hash, 16777619);
    }
    return (hash >>> 0) / 4294967296;
  }
  /* Offset deterministico 0,1‑0,4 °C */
  function offset(stationId){
    const rand = fnvRand(String(stationId||'') + today);
    return 0.1 + rand * 0.3;
  }
  /* Valuta se la stazione è WU */
  function isWU(staz){
    return staz && (staz.apiKey || String(staz.stationId||'').startsWith("I") || staz.mlg);
  }

  /* --------------------------------------------------------------------
     1) Integrazione VENTO/RAFFICA da Open‑Meteo nell’aggiornamento marker
     -------------------------------------------------------------------- */
  const cachedWind = Object.create(null);

  function patchAggiungiMarker(){
    const orig = window.aggiungiMarker;
    if(typeof orig !== "function" || orig.__patchedWU) return;

    window.aggiungiMarker = function patched(staz, obs){
      const wu = isWU(staz);

      /* --- Calcolo offset se manca (rand ≥0.7 nel codice originale) --- */
      if(wu && obs && obs.metric && typeof obs.metric.temp === "number"){
        const rand = fnvRand(String(staz.stationId||'') + today);
        if(rand >= 0.7){       // l'originale non lo applicherà
          obs.metric.temp += parseFloat(offset(staz.stationId).toFixed(1));
        }
      }

      /* --- Vento / raffica Open‑Meteo -------------------------------- */
      function callOrig(){
        return orig.call(this, staz, obs);
      }

      if(!wu || cachedWind[staz.stationId]){
        return callOrig();
      }

      cachedWind[staz.stationId] = true;
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${staz.lat}&longitude=${staz.lon}&current=wind_speed_10m,wind_gusts_10m&timezone=UTC`)
        .then(r => r.json())
        .then(d => {
          if(d.current){
            if(d.current.wind_speed_10m != null) obs.windSpeed = d.current.wind_speed_10m;
            if(d.current.wind_gusts_10m != null) obs.windGust = d.current.wind_gusts_10m;
          }
        })
        .catch(console.error)
        .finally(callOrig);

      /* Non chiamiamo subito l'originale: lo faremo nel finally */
      return;
    };
    window.aggiungiMarker.__patchedWU = true;
  }

  /* --------------------------------------------------------------------
     2) Patch su datiTabella per qualunque stazione (presente/futura)
     -------------------------------------------------------------------- */
  function patchDatiTabella(){
    if(!Array.isArray(window.datiTabella) || window.datiTabella.__patchedWU) return;

    const tab = window.datiTabella;

    /* Applica/controlla offset su oggetto singolo */
    function ensure(obj){
      if(!obj || !isWU(obj)) return;

      const stid = obj.stationId;
      const rand = fnvRand(String(stid||'') + today);
      /* Se rand >=0.7 l'originale non ha messo offset: aggiungiamolo ora */
      if(rand >= 0.7){
        const off = parseFloat(offset(stid).toFixed(1));
        if(typeof obj.tempVal === "number"){
          obj.tempVal = parseFloat((obj.tempVal + off).toFixed(1));
        }
        if(typeof obj.temp === "number"){
          obj.temp = parseFloat((obj.temp + off).toFixed(1));
        }
      }
    }

    /* Patch push per gestire futuri inserimenti */
    const origPush = tab.push;
    tab.push = function(...args){
      args.forEach(ensure);
      return origPush.apply(this, args);
    };
    tab.__patchedWU = true;

    /* Corregge già le righe esistenti */
    tab.forEach(ensure);

    /* Rinfresca subito la tabella/marker se funzione esiste */
    if(typeof window.aggiornaTabella === "function"){
      setTimeout(window.aggiornaTabella, 0);
    }
  }

  /* --------------------------------------------------------------------
     3) Timer di autosicurezza: ogni 3 s assicura patch presente
     -------------------------------------------------------------------- */
  function watchdog(){
     patchAggiungiMarker();
     patchDatiTabella();
  }
  document.addEventListener("DOMContentLoaded", watchdog);
  setInterval(watchdog, 3000);   // resta resiliente a re‑inizializzazioni
})();
</script>
<!-- === /Patch WU offset & wind === -->
<!-- ===== PATCH DECIMALI WU v12 – 2025-06-25 ===== -->
<script>
(function(){

  /* ---------- Utilità comune ---------- */
  const OGGI = new Date().toISOString().split("T")[0];
  if (typeof window.stableRand !== 'function') {
      window.stableRand = function(seed) {
        let h = 2166136261 >>> 0;
        for (let i = 0; i < seed.length; i++) {
          h ^= seed.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return (h >>> 0) / 4294967296;
      };
  }

  function decimale(seed) { return 1 + Math.floor(window.stableRand(seed) * 4); } // 1‑4 → 0.1‑0.4

  function uniforma(ext, id) {
      if (!ext || ext.min == null || ext.max == null) return;
      const intMin = Math.trunc(ext.min);
      const intMax = Math.trunc(ext.max);
      let dMin = decimale(id + "_min_" + OGGI);
      let dMax = decimale(id + "_max_" + OGGI);
      if (Math.abs(dMin - dMax) < 2) dMax = ((dMax + 2 - 1) % 4) + 1;
      if (intMax === intMin && dMax < dMin) [dMin, dMax] = [dMax, dMin];
      ext.min = parseFloat((intMin + dMin / 10).toFixed(1));
      ext.max = parseFloat((intMax + dMax / 10).toFixed(1));
  }

  function isWU(id) { return /^I[A-Z0-9]/i.test(id); }

  function applica() {
      const ext = window.extremiGiornalieri;
      if (!ext) return;
      Object.entries(ext).forEach(([id, obj]) => { if (isWU(id)) uniforma(obj, id); });
  }

  function wrap(fnName) {
      const orig = window[fnName];
      if (typeof orig === 'function' && !orig.__patchedWUdec) {
          window[fnName] = function() {
              const res = orig.apply(this, arguments);
              applica();
              return res;
          };
          window[fnName].__patchedWUdec = true;
      }
  }

  ["applicaJitter", "applicaEstremi"].forEach(wrap);

  document.addEventListener("DOMContentLoaded", applica);
  setInterval(applica, 5000);

})();
</script>
<!-- ===== END PATCH DECIMALI WU v12 ===== -->
<!-- Snapshot & QR libraries -->
<script defer="" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script defer="" src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- === Custom per‑stazione label patch 2025‑06‑26 === -->
<script id="custom_station_label">
(function(){
  /* --- helpers ------------------------------------------------------- */
  function isWU(id){ return typeof id==="string" && /^I[A-Z0-9]/i.test(id); }
  function labelFor(id){ return isWU(id) ? "*" : ""; }

  /* Aggiorna la mappa customStationLabels, se presente */
  function patchMapping(){
    if(window.customStationLabels){
      Object.keys(window.customStationLabels).forEach(function(k){
        window.customStationLabels[k] = labelFor(k);
      });
    }
  }

  /* Rimuove/aggiorna etichette dentro un elemento HTML */
  function scrubNode(node){
    if(!node) return;
    /* elimina "Staz. ..." e spazi finali */
    node.innerHTML = node.innerHTML.replace(/Staz\.[^<]*/g, function(match){
      /* se era "Staz. MLG" o "Staz. di ..." toglilo pure */
      return "";
    });
  }

  /* ------------------------------------------------------------------ */
  /* 1.  Intercetta bindPopup PRIMA della creazione dei popup --------- */
  const origBind = L.Marker && L.Marker.prototype.bindPopup;
  if(origBind && !origBind.__patchedForAsterisk){
    L.Marker.prototype.bindPopup = function(content, opts){
      try{
        const sid = this.stationId || (this.options && this.options.stationId);
        const lbl = labelFor(sid);
        if(typeof content === "string"){
          /* Se il contenuto include "Staz." sostituisci */
          content = content.replace(/Staz\.[^<]*/g, lbl);
        }
      }catch(e){ console.warn("asterisk patch bindPopup", e); }
      return origBind.call(this, content, opts);
    };
    L.Marker.prototype.bindPopup.__patchedForAsterisk = true;
  }

  /* 2.  Per popup già preparati/creati, pulizia su evento ---------- */
  function attachPopupScrub(){
    if(window.map && typeof map.on==="function"){
      map.on("popupopen", function(ev){
        scrubNode(ev.popup.getElement());
      });
    }
  }

  /* 3.  Patch aggiornaTabella per la tabella ------------------------ */
  function patchAggiorna(){
    const orig = window.aggiornaTabella;
    if(typeof orig!=="function" || orig.__patchedForAsterisk) return;

    window.aggiornaTabella = function(){
      orig.apply(this, arguments);
      /* pulizia su tutta la tabella */
      document.querySelectorAll('#tabella, #listaStazioni').forEach(scrubNode);
    };
    window.aggiornaTabella.__patchedForAsterisk = true;
  }

  /* 4.  Pulizia periodica di sicurezza ------------------------------ */
  function periodicScrub(){
    setInterval(function(){
      document.querySelectorAll('#tabella, #listaStazioni').forEach(scrubNode);
    }, 1500);
  }

  /* 5.  Inizializzazione ------------------------------------------- */
  function init(){
    patchMapping();
    patchAggiorna();
    attachPopupScrub();
    periodicScrub();
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", init);
  }else{
    init();
  }
})();
</script>
<!-- PATCH PERFORMANCE v3 (2025‑06‑27): caching, dynamic concurrency, timeout, preconnect, lazy CSS -->
<link href="https://api.open-meteo.com" rel="preconnect"/>
<script defer="" id="perf-patch-v3">
(() => {
  /* ---------- CONFIG ---------- */
  const HARDWARE_CORES = navigator.hardwareConcurrency || 8;
  const MAX_CONCURRENT = Math.min(24, Math.max(8, HARDWARE_CORES * 2)); // 2× cores, capped 24
  const FETCH_TIMEOUT_MS = 2500;              // abort after 2.5 s
  const MAX_CACHE_AGE_MS = 5 * 60 * 1000;     // 5 min cache validity
  const CACHE_PREFIX = 'om_';

  /* ---------- AUX: Lazy‑CSS dedupe ---------- */
  document.addEventListener('DOMContentLoaded', () => {
    const seen = new Set();
    document.querySelectorAll('link[rel="stylesheet"]').forEach(l => {
      const href = l.getAttribute('href');
      if(seen.has(href)){
        l.setAttribute('rel', 'preload');
        l.setAttribute('as', 'style');
        l.onload = () => { l.rel = 'stylesheet'; };
      }
      seen.add(href);
    });
  });

  /* ---------- GUARDBOX ---------- */
  if (typeof window.caricaDatiOpenMeteo !== 'function' || !Array.isArray(window.stazioni)) return;

  const stazioniOM = window.stazioni.filter(s => s.openMeteo);

  const buildEntry = (stazione, data) => ({
    stationId     : stazione.stationId,
    temp          : data.current.temperature_2m,
    tempVal       : data.current.temperature_2m,
    pioggia       : data.current.precipitation,
    umidita       : data.current.relativehumidity_2m,
    raffica       : data.current.wind_gusts_10m,
    percepitaVal  : (typeof calcolaPercepita === 'function') ? calcolaPercepita(data.current.temperature_2m,data.current.relativehumidity_2m,data.current.wind_speed_10m) : null
  });

  /* ---------- CACHE HELPERS ---------- */
  function cacheKey(stazione){ return CACHE_PREFIX + stazione.stationId; }
  function loadCache(stazione){
    try{
      const raw = localStorage.getItem(cacheKey(stazione));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(Date.now() - obj.ts > MAX_CACHE_AGE_MS) return null;
      return obj.data;
    }catch(_){ return null; }
  }
  function saveCache(stazione, data){
    try{
      localStorage.setItem(cacheKey(stazione), JSON.stringify({ts: Date.now(), data}));
    }catch(_){}
  }

  /* ---------- SINGLE STATION FETCH ---------- */
  async function fetchStazione (stazione){
    // 1) Check cache
    const cached = loadCache(stazione);
    if(cached){
      window.datiTabella.push(buildEntry(stazione, cached));
      return;
    }

    // 2) Otherwise fetch with timeout
    const base = 'https://api.open-meteo.com/v1/forecast';
    const query = `latitude=${stazione.lat}&longitude=${stazione.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=auto`;
    const url = base + '?' + query;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
    try{
      const resp = await fetch(url, { signal: controller.signal });
      if(!resp.ok) throw new Error(resp.status);
      const data = await resp.json();
      window.datiTabella.push(buildEntry(stazione, data));
      saveCache(stazione, data);
    }catch(err){
      console.warn('OpenMeteo v3 patch: skipping', stazione.stationId, err?.message || err);
    }finally{
      clearTimeout(timeoutId);
    }
  }

  /* ---------- OVERRIDE MAIN FUNCTION ---------- */
  window.caricaDatiOpenMeteo = async function patchedCaricaDatiOpenMeteo(){
    const queue = stazioniOM.slice(); // shallow copy
    const workers = Array.from({ length: Math.min(MAX_CONCURRENT, queue.length) }, async () => {
      while(queue.length){
        await fetchStazione(queue.shift());
      }
    });
    await Promise.all(workers);
  };
})();
</script>
<script>
function calcolaWindChill_C_safe(t, v){
  if(t==null||v==null||isNaN(t)||isNaN(v)||v<2) return null;
  const wci = 13.12 + 0.6215*t - 11.37*Math.pow(v,0.16) + 0.3965*t*Math.pow(v,0.16);
  return Math.round(wci*10)/10;
}
</script>
<!-- Snapshot share-friendly modern skin -->
<style id="snapshot_mobile_modern">
@media (max-width:700px){
  #snapshot-badge{
    position:absolute !important;
    top:12px !important;
    left:50% !important;
    transform:translateX(-50%) !important;
    width:90vw !important;
    max-height:40vh !important;
    overflow-y:auto !important;
    padding:10px 14px !important;
    font-size:13px !important;
    line-height:1.35 !important;
    color:#fff !important;
    background:rgba(0,0,0,0.35) !important;
    backdrop-filter:blur(8px) !important;
    border:1px solid rgba(255,255,255,0.1) !important;
    border-radius:14px !important;
    box-shadow:0 4px 12px rgba(0,0,0,0.4) !important;
  }
  #snap-riepilogo{
    position:absolute !important;
    bottom:82px !important;
    left:50% !important;
    transform:translateX(-50%);
    width:90vw !important;
    font-size:12px !important;
    line-height:1.35 !important;
    padding:10px 12px !important;
    color:#fff !important;
    background:rgba(0,0,0,0.3) !important;
    backdrop-filter:blur(8px) !important;
    border:1px solid rgba(255,255,255,0.1) !important;
    border-radius:12px !important;
    box-shadow:0 4px 12px rgba(0,0,0,0.4) !important;
  }
  #snap-legend{
    position:absolute !important;
    bottom:14px !important;
    left:50% !important;
    transform:translateX(-50%) !important;
    width:150px !important;
    height:10px !important;
    border-radius:8px !important;
    box-shadow:0 2px 6px rgba(0,0,0,0.4) !important;
  }
  .label-snap{
    font-size:10px !important;
    max-width:70px;
    text-align:center;
    white-space:pre-line;
    color:#fff !important;
    text-shadow:0 0 3px #000;
  }
  #snap-qr{
    width:72px !important;
    height:72px !important;
    border-radius:10px !important;
    box-shadow:0 2px 6px rgba(0,0,0,0.4);
  }
}
</style>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
/* ========= Interpolazione regionale (PLOT) ========= */
(function(){
  // Raggio dinamico in base allo zoom (heatmap)
  function calcHeatRadius(z){
     const base=35, baseZ=9;           // raggio base a zoom 9
     return Math.max(8, Math.round(base*Math.pow(2, z-baseZ)));
  }

  let plotLayer=null, plotActive=false, currentParam='temp';

  // patch funzioni per intercettare parametro
  const wrap=(fn,set)=>function(...a){currentParam=set(...a);return fn(...a)};
  if(window.visualizzaAttuali)  visualizzaAttuali=wrap(visualizzaAttuali,()=> 'temp');
  if(window.visualizzaPercepita) visualizzaPercepita=wrap(visualizzaPercepita,()=> 'percepita');
  if(window.visualizzaUmidita)   visualizzaUmidita=wrap(visualizzaUmidita,()=> 'umidita');
  if(window.visualizzaPioggia)   visualizzaPioggia=wrap(visualizzaPioggia, ()=> 'pioggia');
  if(window.visualizzaRaffiche)  visualizzaRaffiche=wrap(visualizzaRaffiche,()=> 'raffica');
  if(window.visualizzaEstremi){
    const _old=visualizzaEstremi;
    window.visualizzaEstremi=function(tipo){currentParam=(tipo==='max')?'tmax':'tmin';return _old(tipo);};
  }

  function getVal(d){
    switch(currentParam){
      case 'temp': return d.tempVal;
      case 'percepita': return d.percepitaVal;
      case 'umidita': return d.umidita;
      case 'pioggia': return parseFloat(d.pioggia)||0;
      case 'raffica': return d.raffica;
      case 'tmax': return getEstremoGiornaliero(d.stationId,'max');
      case 'tmin': return getEstremoGiornaliero(d.stationId,'min');
    }
    return null;
  }

  function gradientFor(p){
    if(p==='umidita') return {0:'#ff5500',0.5:'#66ccff',1:'#0055ff'};
    if(p==='pioggia') return {0:'#ffffff',0.4:'#99ccff',0.7:'#3399ff',1:'#003388'};
    if(p==='raffica') return {0:'#ffffcc',0.5:'#ff9933',1:'#ff0000'};
    return {0:'#0000ff',0.25:'#00ffff',0.5:'#00ff00',0.75:'#ffff00',1:'#ff0000'};
  }

  function buildHeat(){
    if(!window.datiTabella||!window.markersById) return [];
    return datiTabella.map(d=>{
       const m=markersById[d.stationId]; if(!m) return null;
       const v=getVal(d); if(!Number.isFinite(v)) return null;
       const {lat,lng}=m.getLatLng();
       return [lat,lng,v];
    }).filter(Boolean);
  }

  function hideMarkers(on){
    for(const id in markersById){
       const el=markersById[id].getElement(); if(el) el.style.opacity=on?0:1;
    }
  }

  window.togglePlot=function(){
      if(!plotActive){
          const pts=buildHeat();
          if(pts.length<3){alert('Dati in caricamento o insufficienti');return;}
          const vs=pts.map(p=>p[2]); const mn=Math.min(...vs), mx=Math.max(...vs);
          const norm=mx===mn?()=>1:v=>(v-mn)/(mx-mn);
          const heat=L.heatLayer(pts.map(p=>[p[0],p[1],norm(p[2])]),{
             radius: calcHeatRadius(map.getZoom()), blur:25, maxZoom:8, gradient: gradientFor(currentParam)
          }).addTo(map);
          plotLayer=heat; plotActive=true; hideMarkers(true);
          document.getElementById('btnPlot').classList.add('attivo');
      }else{
          if(plotLayer) map.removeLayer(plotLayer);
          plotLayer=null; plotActive=false; hideMarkers(false);
          document.getElementById('btnPlot').classList.remove('attivo');
      }
  };

  // Aggiorna dinamicamente il raggio della heatmap al cambio di zoom
  if(window.map){
    map.on('zoomend', ()=>{
      if(window.plotLayer && window.plotLayer.setOptions){
        window.plotLayer.setOptions({radius: calcHeatRadius(map.getZoom()), gradient: gradientFor(currentParam)});
      }
    });
  }
})();
</script>
<!-- Infocard v10 JS -->
<script id="infocard-upgrade-js">
(function(){
  const KEY_DETECT = {
    caldo:   txt => txt.includes('🌡️'),
    freddo:  txt => txt.includes('🌡️'),
    tmax:    txt => txt.includes('🔺') || txt.toLowerCase().includes('max'),
    tmin:    txt => txt.includes('🔻') || txt.toLowerCase().includes('min'),
    raffica: txt => txt.includes('💨') || txt.toLowerCase().includes('raffica'),
    pioggia: txt => txt.includes('🌧️') || txt.toLowerCase().includes('mm')
  };

  function upgradeCards(){
    const order = document.getElementById('filtro-ordinamento')?.value || 'caldo';
    const detector = KEY_DETECT[order] || (()=>false);

    document.querySelectorAll('#tabella > div:not(:has(#riepilogo-testo))').forEach(card=>{
      // remove previous central metric injections
      card.querySelectorAll('.main-metric.injected').forEach(el=>el.remove());
      card.querySelectorAll('.main-metric').forEach(el=>el.classList.remove('main-metric'));

      const metrics = Array.from(card.querySelectorAll(':scope > div:nth-child(n+2) > div'));

      // reset hidden flags
      metrics.forEach(m=>m.classList.remove('metric-hidden'));

      // choose matching metric
      let chosen = metrics.find(m=>detector(m.textContent));
      if(!chosen) chosen = metrics[0];

      // put chosen in big spot
      const big = chosen.cloneNode(true);
      big.classList.add('main-metric','injected');
      card.insertBefore(big, card.children[1]);

      // hide original chosen
      chosen.classList.add('metric-hidden');
    });
  }

  // run when changes happen
  const table = document.getElementById('tabella');
  if(table){
    new MutationObserver(()=>setTimeout(upgradeCards,0)).observe(table,{childList:true,subtree:true});
  }
  document.getElementById('filtro-ordinamento')?.addEventListener('change',()=>setTimeout(upgradeCards,0));
  window.addEventListener('load',()=>setTimeout(upgradeCards,0));
})();
</script>
<!-- ChatGPT patch: color square metric according to selected filter -->
<script id="chatgpt-metric-color">
(function(){
  const COLOR_MAP = {
    caldo:  "#d0006f",
    freddo: "#0066d0",
    tmax:   "#d0006f",
    tmin:   "#0066d0",
    raffica:"#ff8c00",
    pioggia:"#007bff"
  };
  function recolor(){
     const order = document.getElementById('filtro-ordinamento')?.value || 'caldo';
     const color = COLOR_MAP[order] || "#007bff";
     document.querySelectorAll('#tabella .main-metric').forEach(el=>{
        el.style.backgroundColor = color;
        el.style.color = '#fff';
        el.style.borderRadius = '6px';
        el.style.padding = '2px 6px';
        el.style.display = 'inline-block';
     });
  }
  document.getElementById('filtro-ordinamento')?.addEventListener('change', ()=>setTimeout(recolor,0));
  window.addEventListener('load', ()=>setTimeout(recolor,0));
})();
</script>
<!-- Mobile card compact patch v4 by ChatGPT 2025‑06‑27 -->
<script id="chatgpt-mobile-compact-20250627-v4">
/* Inseriamo il CSS alla fine del caricamento per sovrascrivere qualsiasi regola successiva */
document.addEventListener('DOMContentLoaded', function () {
  const css = `
  @media (max-width:640px){
    /* Container principale: flex wrap */
    #tabella{
      display:flex !important;
      flex-wrap:wrap !important;
      gap:8px !important;
      padding:6px !important;
    }
    /* Tutte le card meteo tranne riepilogo */
    #tabella > div:not(:has(#riepilogo-testo)){
      flex:0 0 calc(50% - 8px) !important; /* due colonne */
      max-width:calc(50% - 8px) !important;
      width:calc(50% - 8px) !important;
      margin:0 !important;
      padding:8px 6px !important;
      box-sizing:border-box !important;
      border-radius:12px !important;
    }
    /* Rimuovo eventuale altezza/min-height fissa */
    #tabella > div:not(:has(#riepilogo-testo)){height:auto !important;min-height:unset !important;}
    /* Titoli compatti */
    #tabella > div:not(:has(#riepilogo-testo)) > div:first-child,
    #tabella > div:not(:has(#riepilogo-testo)) h3{
      font-size:15px !important;
      line-height:1.2 !important;
      margin:0 0 4px 0 !important;
      text-align:left !important;
    }
  }
  @media (max-width:360px){
    #tabella > div:not(:has(#riepilogo-testo)){
      flex:0 0 100% !important;
      max-width:100% !important;
      width:100% !important;
    }
  }`;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);
});
</script>
<!-- === PATCH WIND JITTER v1 – 2025‑06‑29 === -->
<script>
(function(){
  const TODAY = new Date().toISOString().split("T")[0];
  if(typeof window.stableRand!=="function"){
    window.stableRand=function(seed){
      let h=2166136261>>>0;
      for(let i=0;i<seed.length;i++){
        h ^= seed.charCodeAt(i);
        h = Math.imul(h,16777619);
      }
      return (h>>>0)/4294967296;
    };
  }
  function windJitter(val, seed){
    const num=parseFloat(val);
    if(!Number.isFinite(num)) return val;
    const r=window.stableRand(seed+TODAY);
    const sign=r<0.5?-1:1;
    // ±5 % o almeno ±0,2 km/h
    const REL=0.12, MIN=0.5;
    const amp=Math.max(MIN, num*REL);
    const off=(0.3 + (r*0.8))*amp; // 0.2‑1.0 della ampiezza
    return parseFloat((num + sign*off).toFixed(1));
  }
  // Patch funzione globale aggiungiMarker se presente
  const retry=()=>{
    if(typeof window.aggiungiMarker!=='function'){setTimeout(retry,500);return;}
    if(window.aggiungiMarker.__patchedWindJitter) return;
    const orig=window.aggiungiMarker;
    window.aggiungiMarker=function(staz, obs){
       if(obs){
          if(obs.windSpeed!=null) obs.windSpeed=windJitter(obs.windSpeed, (staz.stationId||'')+'_ws');
          if(obs.windGust!=null)  obs.windGust=windJitter(obs.windGust, (staz.stationId||'')+'_wg');
       }
       return orig.apply(this, arguments);
    };
    window.aggiungiMarker.__patchedWindJitter=true;
  };
  retry();
})();
</script>
<!-- === /PATCH WIND JITTER === -->
<!-- CHATGPT surgical patch v2: single decimal formatting, no style changes -->
<script>
(function(){
  function transformTextNode(node){
    node.nodeValue = node.nodeValue
      .replace(/(-?\d+\.\d+)/g, function(match){ return parseFloat(match).toFixed(1); })
      .replace(/-3(?![\.\d])/g, '');
  }
  function process(container){
    var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
    var node;
    while(node = walker.nextNode()){
      transformTextNode(node);
    }
  }
  function clean(){
    var table = document.getElementById('tabella');
    if(table) process(table);
    document.querySelectorAll('.leaflet-popup-content').forEach(function(popup){
      process(popup);
    });
  }
  ['aggiornaTabella','visualizzaAttuali','visualizzaEstremi',
   'forzaEstremiPopupTestuale','aggiornaPopupConEstremiFinale',
   'aggiornaPopupGrafico'].forEach(function(fn){
    var orig = window[fn];
    if(typeof orig === 'function'){
      window[fn] = function(){
        var result = orig.apply(this, arguments);
        clean();
        return result;
      };
    }
  });
  document.addEventListener('DOMContentLoaded', clean);
})();
</script>
<!-- CHATGPT surgical patch v3: formatta mm senza zeri, singolo decimale e applica ai marker -->
<script>
(function(){
  function processText(container){
    var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
    var node;
    while(node = walker.nextNode()){
      var txt = node.nodeValue;
      // Floats (non seguiti da mm): 1 decimale
      txt = txt.replace(/(-?\d+\.\d+)(?!\s*mm)/g, function(m){ return parseFloat(m).toFixed(1); });
      // Interi prima di ' mm': rimuove zeri iniziali (es. 00 -> 0, 03 -> 3)
      txt = txt.replace(/\b0+(\d+)(?=\s*mm)/g, '$1');
      // '00 mm' caso particolare: porta a '0 mm'
      txt = txt.replace(/\b00(?=\s*mm)/g, '0');
      // Rimuove residuali '-3'
      txt = txt.replace(/-3(?![\.\d])/g, '');
      node.nodeValue = txt;
    }
  }
  function clean(){
    processText(document.body);
  }
  // Lista di funzioni da hookare
  var hooks = ['aggiornaTabella','visualizzaAttuali','visualizzaEstremi',
               'forzaEstremiPopupTestuale','aggiornaPopupConEstremiFinale',
               'aggiornaPopupGrafico'];
  document.addEventListener('DOMContentLoaded', clean);
  hooks.forEach(function(name){
    var orig = window[name];
    if(typeof orig === 'function'){
      window[name] = function(){
        var res = orig.apply(this, arguments);
        clean();
        return res;
      };
    }
  });
})();
</script>
<!-- === FAST-LOAD PATCH 2025-07-02 === -->
<script id="fastload_20250702">
(() => {
  /* ───────────────────────────────────────────────────────────── *
   *  Parametri regolabili
   * ───────────────────────────────────────────────────────────── */
  const MAX_CONCURRENT   = 24;                 // fetch paralleli
  const MAX_CACHE_AGE_MS = 10 * 60 * 1e3;      // 10 min cache
  const FETCH_TIMEOUT_MS = 8000;               // 8 s timeout
  const CACHE_PREFIX     = "OMcache_v2_";

  /* fade‑in delicato dei marker quando TUTTO è pronto */
  const revealMarkers = () => {
    const hider = document.getElementById("hideMarkerOpacity");
    if (hider) hider.remove();                 // toglie opacity:0
    if (!document.getElementById("smoothMarkerOpacity")) {
      const css = document.createElement("style");
      css.id = "smoothMarkerOpacity";
      css.textContent = ".leaflet-marker-icon{transition:opacity .35s ease;}";
      document.head.appendChild(css);
    }
  };

  /* ───────────────────────────────────────────────────────────── *
   *  1) Open‑Meteo: override con fetch concorrente + cache
   * ───────────────────────────────────────────────────────────── */
  if (typeof window.caricaDatiOpenMeteo === "function") {
    /* helpers ---------------------------------------------------- */
    const key = s => \`\${CACHE_PREFIX}\${s.stationId}\`;
    const loadCache = s => {
      try {
        const raw = localStorage.getItem(key(s));
        if (!raw) return null;
        const { ts, data } = JSON.parse(raw);
        return (Date.now() - ts < MAX_CACHE_AGE_MS) ? data : null;
      } catch { return null; }
    };
    const saveCache = (s, data) => {
      try {
        localStorage.setItem(key(s), JSON.stringify({ ts: Date.now(), data }));
      } catch { /* quota piena: ignora */ }
    };
    const buildEntry = (s, d) => ({
      stationId    : s.stationId,
      temp         : d.current.temperature_2m,
      tempVal      : d.current.temperature_2m,
      pioggia      : d.current.precipitation,
      umidita      : d.current.relativehumidity_2m,
      raffica      : d.current.wind_gusts_10m,
      percepitaVal : (typeof calcolaPercepita === "function")
                       ? calcolaPercepita(d.current.temperature_2m,
                                          d.current.relativehumidity_2m,
                                          d.current.wind_speed_10m)
                       : null
    });

    /* fetch singolo con timeout + cache ------------------------- */
    async function fetchStazione(s) {
      const cached = loadCache(s);
      if (cached) return buildEntry(s, cached);

      const ctrl = new AbortController();
      const tId  = setTimeout(() => ctrl.abort(), FETCH_TIMEOUT_MS);
      try {
        const q = \`latitude=\${s.lat}&longitude=\${s.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=auto\`;
        const url = \`https://api.open-meteo.com/v1/forecast?\${q}\`;
        const r   = await fetch(url, { signal: ctrl.signal });
        if (!r.ok) throw new Error(r.status);
        const data = await r.json();
        saveCache(s, data);
        return buildEntry(s, data);
      } finally { clearTimeout(tId); }
    }

    /* override --------------------------------------------------- */
    window.caricaDatiOpenMeteo = async () => {
      const lista = (window.stazioni || []).filter(x => x.openMeteo);
      const queue = [...lista];
      window.datiTabella = window.datiTabella || [];

      /* worker pool concorrente ---------------------------------- */
      const workers = Array.from(
        { length: Math.min(MAX_CONCURRENT, queue.length) },
        async () => {
          while (queue.length) {
            const staz = queue.shift();
            try {
              const entry = await fetchStazione(staz);
              window.datiTabella.push(entry);
              /* marker aggiunto ma resta invisibile finché non riveliamo */
              if (typeof window.aggiungiMarker === "function") {
                window.aggiungiMarker(staz, { metric: { temp: entry.tempVal }});
              }
            } catch (e) {
              console.warn("Open-Meteo timeout/skipped:", staz.stationId, e);
            }
          }
        }
      );

      /* aspetta tutti i worker poi rivela in un colpo solo ------- */
      await Promise.allSettled(workers);
      revealMarkers();

      /* refresh tabella se presente ----------------------------- */
      if (typeof window.aggiornaTabella === "function") window.aggiornaTabella();
    };
  }

  /* ───────────────────────────────────────────────────────────── *
   *  2)  Weather Underground: chiamate in idle
   * ───────────────────────────────────────────────────────────── */
  if (typeof window.fetch === "function" && window.requestIdleCallback) {
    const _origWU = window.fetch;
    window.fetch = function(url, opts) {
      if (typeof url === "string" && url.includes("/v2/pws/observations/current")) {
        return new Promise((resolve, reject) => {
          requestIdleCallback(() =>
            _origWU(url, opts).then(resolve).catch(reject)
          , { timeout: 10000 });
        });
      }
      return _origWU(url, opts);
    };
  }
})();
</script>
<!-- === /FAST-LOAD PATCH 2025-07-02 === -->
<!-- FAST-LOAD VIEWPORT PATCH 2025-07-04 -->
<script id="fastload_viewport_20250704">
(() => {
  if (!window.map || !Array.isArray(window.stazioni)) return;

  /* ===== Configurazione ===== */
  const CACHE_PREFIX     = 'OMvp_';
  const CACHE_MS         = 10 * 60 * 1e3;               // 10 minuti
  const TIMEOUT_MS       = 8000;                        // 8 s timeout
  const MAX_CONCURRENT   = Math.min(16, (navigator.hardwareConcurrency || 8) * 2);
  const PAD_FACTOR       = 0.20;                        // bbox padding 20 %

  /* ===== Helpers cache ===== */
  const key   = s => CACHE_PREFIX + s.stationId;
  const load  = s => { try {
      const raw = localStorage.getItem(key(s));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return (Date.now() - obj.ts < CACHE_MS) ? obj.data : null;
  } catch { return null; } };
  const save  = (s,d) => { try {
      localStorage.setItem(key(s), JSON.stringify({ts: Date.now(), data:d}));
  } catch(_){} };

  /* ===== Build entry compatibile con datiTabella ===== */
  const build = (s,d)=>({
     stationId : s.stationId,
     temp      : d.current.temperature_2m,
     tempVal   : d.current.temperature_2m,
     pioggia   : d.current.precipitation,
     umidita   : d.current.relativehumidity_2m,
     raffica   : d.current.wind_gusts_10m,
     percepitaVal : (typeof calcolaPercepita==='function')
                    ? calcolaPercepita(d.current.temperature_2m,
                                       d.current.relativehumidity_2m,
                                       d.current.wind_speed_10m)
                    : null
  });

  /* ===== Coda concorrente ===== */
  const queue = [];
  let running = 0;
  const scheduled = new Set();

  async function fetchStazione(s){
     const cached = load(s);
     if(cached){ window.datiTabella.push(build(s,cached)); return; }

     const ctrl = new AbortController();
     const toId = setTimeout(()=>ctrl.abort(), TIMEOUT_MS);
     try{
        const q = `latitude=${s.lat}&longitude=${s.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=auto`;
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?${q}`, {signal: ctrl.signal});
        if(!r.ok) throw new Error(r.status);
        const data = await r.json();
        save(s,data);
        window.datiTabella.push(build(s,data));
     }catch(e){ console.warn('viewport patch skip', s.stationId, e?.message||e); }
     finally{ clearTimeout(toId); }
  }

  function worker(){
     if(running>=MAX_CONCURRENT || queue.length===0) return;
     running++;
     fetchStazione(queue.shift()).finally(()=>{ running--; worker(); });
  }

  function enqueue(list){
     list.forEach(s=>{
         if(!s.openMeteo || scheduled.has(s.stationId)) return;
         scheduled.add(s.stationId);
         queue.push(s);
     });
     while(running < MAX_CONCURRENT && queue.length) worker();
  }

  /* ===== Selezione stazioni nel viewport + padding ===== */
  function visibili(){
     const b = map.getBounds();
     const padLat = (b.getNorth() - b.getSouth()) * PAD_FACTOR;
     const padLng = (b.getEast() - b.getWest()) * PAD_FACTOR;
     const south = b.getSouth() - padLat;
     const north = b.getNorth() + padLat;
     const west  = b.getWest()  - padLng;
     const east  = b.getEast()  + padLng;
     return window.stazioni.filter(s => s.lat>=south && s.lat<=north && s.lon>=west && s.lon<=east);
  }

  map.whenReady(()=>{
     enqueue(visibili());                    // batch iniziale
     map.on('moveend zoomend', () => enqueue(visibili()));
  });

})();
</script>
<!-- /FAST-LOAD VIEWPORT PATCH 2025-07-04 -->

<!-- *** Patch ChatGPT 2025-07-04: ripristino Tmin/Tmax nei popup *** -->

<script id="patch-estremi-giornalieri-0704">
(function(){
  /* Ritorna estremo min/max per stationId */
  function getEstremoGiornaliero(stationId, tipo){
     const ext = window.extremiGiornalieri && window.extremiGiornalieri[stationId];
     if(!ext) return NaN;
     const v = (tipo==='max' ? ext.max : ext.min);
     const n = parseFloat(v);
     return Number.isFinite(n) ? n : NaN;
  }
  window.getEstremoGiornaliero = getEstremoGiornaliero;

  /* Sincronizza r.tMin / r.tMax dentro datiTabella */
  function syncDati(){
     if(!Array.isArray(window.datiTabella) || !window.extremiGiornalieri) return;
     window.datiTabella.forEach(r=>{
        const ext = window.extremiGiornalieri[r.stationId];
        if(ext){
          r.tMin = ext.min;
          r.tMax = ext.max;
        }
     });
  }
  document.addEventListener('DOMContentLoaded', syncDati);
  setInterval(syncDati, 60000); // ogni minuto

  /* Aggiorna i popup quando vengono aperti */
  function patchPopup(){
      const m = window.map || window.mymap;
      if(!m){ setTimeout(patchPopup,500); return; }
      m.on('popupopen', e=>{
         const popupEl = e.popup && e.popup.getElement && e.popup.getElement();
         if(!popupEl) return;
         const contentEl = popupEl.querySelector('.leaflet-popup-content') || popupEl;
         const stationId = e.popup._source && e.popup._source.stationId;
         if(!stationId) return;
         const ext = window.extremiGiornalieri && window.extremiGiornalieri[stationId];
         if(!ext) return;
         const minTxt = (ext.min!=null && ext.min!=='--') ? ext.min + '°C' : '--';
         const maxTxt = (ext.max!=null && ext.max!=='--') ? ext.max + '°C' : '--';

         /* Rimuovi eventuali righe duplicate collocate fuori dal content wrapper */
         popupEl.querySelectorAll('.popup-data.temp-minmax').forEach(el=>{
            if(!contentEl.contains(el)) el.remove();
         });

         /* Trova riga esistente all'interno del contenuto */
         let row = contentEl.querySelector('.popup-data.temp-minmax');
         if(!row){
           /* Se presente una riga con Min: / Max: la aggiorniamo */
           row = Array.from(contentEl.querySelectorAll('.popup-data'))
                      .find(el=>/Min:/i.test(el.textContent) && /Max:/i.test(el.textContent));
         }
         if(!row){
           row = document.createElement('div');
           row.className = 'popup-data temp-minmax';
           contentEl.appendChild(row);
         }
         row.innerHTML = '<span class="bold">Min:</span> ' + minTxt + ' / <span class="bold">Max:</span> ' + maxTxt;
      });
  }
  patchPopup();
})();
</script>



<!-- *** Patch ChatGPT 2025-07-04: recupero Tmin/Tmax via Open‑Meteo per stazioni con valori mancanti *** -->
<script id="patch-estremi-openmeteo-0704">
(function(){
  const MISSING = v => v==null || v==="--" || (typeof v==="number" && !isFinite(v));

  async function fetchDailyMinMax(lat, lon){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
        const res = await fetch(url);
        const data = await res.json();
        const min = data.daily?.temperature_2m_min?.[0] ?? null;
        const max = data.daily?.temperature_2m_max?.[0] ?? null;
        return {min, max};
      }catch(e){
        console.warn("Open‑Meteo extremi error", e);
        return {min:null,max:null};
      }
  }

  const stazioniById = (window.stazioni || []).reduce((acc,s)=>{acc[s.stationId]=s;return acc;}, {});

  async function fillMissing(){
     if(!Array.isArray(window.datiTabella)) return;
     // gather promises per station
     const promises = [];
     window.datiTabella.forEach(r=>{
        if(MISSING(r.tMin) || MISSING(r.tMax)){
           promises.push((async()=>{
             const staz = stazioniById[r.stationId];
             if(!staz) return;
             const {min,max} = await fetchDailyMinMax(staz.lat, staz.lon);
             if(!MISSING(min) && !MISSING(max)){
                // aggiorna strutture
                r.tMin = min;
                r.tMax = max;
                window.extremiGiornalieri = window.extremiGiornalieri || {};
                window.extremiGiornalieri[r.stationId] = {min,max};
             }
           })());
        }
     });
     await Promise.all(promises);
  }

  // esegui subito, poi ripeti ogni 10 minuti per sicurezza
  document.addEventListener('DOMContentLoaded', fillMissing);
  setInterval(fillMissing, 600000);
})();
</script>


<!-- *** Patch ChatGPT 2025-07-04b: mostra Tmin/Tmax nella riga originale del popup *** -->
<script id="patch-estremi-popup-0704b">
(function(){
  function formatVal(v){ return (v!=null && v!=="--") ? v + "°C" : "--"; }

  function updatePopup(popup){
     const popupEl = popup && popup.getElement && popup.getElement();
     if(!popupEl) return;
     const stationId = popup._source && popup._source.stationId;
     if(!stationId) return;
     const ext = window.extremiGiornalieri && window.extremiGiornalieri[stationId];
     if(!ext) return;
     // trova la riga già esistente "Min:"
     const rows = popupEl.querySelectorAll('.popup-data');
     rows.forEach(row=>{
        if(/Min:/i.test(row.textContent)){
            row.innerHTML = '<span class="bold">Min:</span> ' + formatVal(ext.min) +
                            ' / <span class="bold">Max:</span> ' + formatVal(ext.max);
        }
     });
  }

  function attach(){
     const m = window.map || window.mymap || window.leafletMap;
     if(!m){ setTimeout(attach,500); return; }
     m.on('popupopen', e=> updatePopup(e.popup));
     // esposizione pubblica cosí caricaEstremiDaFirebase può richiamarlo
     window.aggiornaPopup = function(){
        if(!m._popup) return;
        updatePopup(m._popup);
     };
  }
  attach();
})();
</script>


<script>
/* ===== Screenshot & Share Feature added by ChatGPT ===== */
let ultimoModo = 'attuali';

/* Preserve originals, extend to track display mode */
if (typeof visualizzaAttuali === 'function'){
  const _visualizzaAttuali = visualizzaAttuali;
  visualizzaAttuali = function(){ _visualizzaAttuali(); ultimoModo='attuali'; };
}
if (typeof visualizzaUmidita === 'function'){
  const _visualizzaUmidita = visualizzaUmidita;
  visualizzaUmidita = function(){ _visualizzaUmidita(); ultimoModo='umidita'; };
}
if (typeof visualizzaPercepita === 'function'){
  const _visualizzaPercepita = visualizzaPercepita;
  visualizzaPercepita = function(){ _visualizzaPercepita(); ultimoModo='percepita'; };
}
if (typeof visualizzaRaffiche === 'function'){
  const _visualizzaRaffiche = visualizzaRaffiche;
  visualizzaRaffiche = function(){ _visualizzaRaffiche(); ultimoModo='raffica'; };
}
if (typeof visualizzaEstremi === 'function'){
  const _visualizzaEstremi = visualizzaEstremi;
  visualizzaEstremi = function(tipo){ _visualizzaEstremi(tipo); ultimoModo = (tipo === 'max' ? 'max' : 'min'); };
}

// Main generator
function generaScreenshot(){
  const mapEl = document.getElementById('map');
  if(!mapEl){ alert('Mappa non trovata'); return; }

  // Build overlay card
  const overlay = document.createElement('div');
  overlay.id = 'screenshotOverlay';
  overlay.style.position = 'absolute';
  overlay.style.top = '10px';
  overlay.style.left = '10px';
  overlay.style.zIndex = '9999';
  overlay.style.background = 'rgba(255,255,255,0.94)';
  overlay.style.border = '2px solid #1a3a9b';
  overlay.style.borderRadius = '10px';
  overlay.style.padding = '12px 16px';
  overlay.style.fontFamily = 'Arial, sans-serif';
  overlay.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  overlay.innerHTML = buildOverlayHTML();
  mapEl.appendChild(overlay);

  html2canvas(mapEl, {useCORS:true, backgroundColor:null}).then(canvas=>{
      overlay.remove();
      // Trigger download
      const link = document.createElement('a');
      link.download = 'CalabriaWeather_'+ new Date().toISOString().slice(0,10)+'.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
  }).catch(e=>{
      console.error('html2canvas error', e);
      overlay.remove();
      alert('Errore nella generazione dello screenshot');
  });
}

// Build overlay inner HTML
function buildOverlayHTML(){
  const titles = {
    'attuali':'Temperature Attuali',
    'max':'Temperature Massime',
    'min':'Temperature Minime',
    'umidita':'Umidità Relativa',
    'raffica':'Raffiche di Vento',
    'percepita':'Temperatura Percepita'
  };
  const header = titles[ultimoModo] || 'Dati Meteo';
  const now = new Date();
  let html = '<div style="font-size:17px;font-weight:bold;text-align:center;margin-bottom:8px;">'+header+'</div>';
  html += '<div style="font-size:13px;text-align:center;margin-bottom:8px;">'+ now.toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long' }) +'</div>';
  const top = calcolaTop10();
  top.forEach((r,i)=>{
     html += '<div style="display:flex;justify-content:space-between;font-size:14px;margin:2px 0;">'
          + '<span>'+ (i+1) +'. '+ r.nome +'</span>'
          + '<span style="font-weight:bold;">'+ r.valore +'</span></div>';
  });
  return html;
}

// Compute top 10 for current display mode
function calcolaTop10(){
   const list = [];
   if(!window.datiTabella) return list;
   datiTabella.forEach(d=>{
        let val;
        if(ultimoModo === 'attuali'){ val = d.tempVal; }
        else if(ultimoModo === 'max'){ val = getEstremoGiornaliero(d.stationId,'max'); }
        else if(ultimoModo === 'min'){ val = getEstremoGiornaliero(d.stationId,'min'); }
        else if(ultimoModo === 'umidita'){ val = d.umidita; }
        else if(ultimoModo === 'raffica'){ val = d.raffica; }
        else if(ultimoModo === 'percepita'){ val = d.percepitaVal; }
        if(val !== undefined && !isNaN(val)){
            list.push({ nome: d.stationId, valore: val });
        }
   });
   // Sort based on mode
   if(ultimoModo === 'min'){ list.sort((a,b)=> a.valore - b.valore); }
   else{ list.sort((a,b)=> b.valore - a.valore); }

   // Format values with unit
   const unit = (ultimoModo === 'umidita') ? '%' : (ultimoModo === 'raffica' ? ' km/h' : '°C');
   return list.slice(0,10).map(o=>({ nome:o.nome, valore: o.valore.toFixed(1) + unit }));
}
</script>


<!-- ChatGPT quick‑fix patch 2025‑07‑07 -->
<style id="top10-overlay-css">
.top10-overlay{
  position:absolute;
  top:10px;
  right:10px;
  z-index:9999;
  background:rgba(255,255,255,0.95);
  border:2px solid #1a3a9b;
  border-radius:10px;
  padding:12px 16px;
  font-family:Arial,sans-serif;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  max-height:80vh;
  overflow-y:auto;
}
@media(max-width:600px){
 .top10-overlay{
   top:auto;
   bottom:10px;
   left:50%%;
   right:auto;
   transform:translateX(-50%%);
   width:90vw;
   max-height:60vh;
 }
}
</style>
<script id="top10-overlay-patch">
(function(){
  if(window._overlayPatched) return;
  window._overlayPatched = true;

  // patch calcolaTop10 to use station name where available
  const origCalc = window.calcolaTop10;
  
  // mapping stationId -> nome dai metadati globali (se esistono)
  const idNameMap = (() => {
    const m = {};
    if (window.stazioni && Array.isArray(window.stazioni)) {
      window.stazioni.forEach(s => {
        if (s && s.stationId && s.nome) m[s.stationId] = s.nome;
      });
    }
    return m;
  })();

  // funzione per ricavare un nome leggibile in ogni caso
  function getDisplayName(d){
    if(d.nome && d.nome.trim()!=='') return d.nome;
    if(idNameMap[d.stationId]) return idNameMap[d.stationId];
    return d.stationId;
  }

window.calcolaTop10 = function(){
     const res = origCalc?origCalc():[];
     return res.map(r=>{
        const st = (window.stazioni||[]).find(s=>s.stationId===r.nome);
        return { nome: (st && st.nome) ? st.nome : r.nome, valore:r.valore };
     });
  };

  // patch buildOverlayHTML to add info line
  const origBuild = window.buildOverlayHTML;
  window.buildOverlayHTML = function(){
     let html = origBuild?origBuild():'<div>Top 10</div>';
     html += '<div style="font-size:11px;text-align:center;margin-top:8px;"><em>Top 10 valori più importanti per questa condizione.<br>Per i dati completi consulta la MLG Map su meteologullo.com</em></div>';
     return html;
  };

  // after screenshot created, adjust overlay style class
  const observer = new MutationObserver(muts=>{
       muts.forEach(m=>{
          m.addedNodes.forEach(node=>{
             if(node.id==='screenshotOverlay' && node.style){
                node.classList.add('top10-overlay');
                node.style.position='absolute';
                node.style.left='auto';
             }
          });
       });
  });
  observer.observe(document.body,{childList:true,subtree:true});
})();
</script>


<!-- ChatGPT name-fix v9 -->
<script id="namefix-v9">
(function(){
  if(window.__namefix_v9) return;
  window.__namefix_v9 = true;
  const originalCalc = window.calcolaTop10;
  if(typeof originalCalc !== 'function') return;

  window.calcolaTop10 = function(){
     const res = originalCalc();
     let meta;
     try{ meta = stazioni; }catch(e){ meta = undefined; }
     return res.map(r=>{
        let nice = r.nome;
        if(meta && Array.isArray(meta)){
          const match = meta.find(s=>s && s.stationId===r.nome && s.nome);
          if(match && match.nome) nice = match.nome;
        }
        return { nome: nice, valore: r.valore };
     });
  };
})();
</script>


<!-- === WU FASTLOAD VIEWPORT PATCH 2025-07-07 === -->
<script id="wu_fastload_viewport_20250707">
(() => {
  if (!window.map || !Array.isArray(window.stazioni)) return;
  if (window.__wuFastViewportPatch) return;
  window.__wuFastViewportPatch = true;

  /* === Config === */
  const CACHE_PREFIX   = 'WUvp_';
  const CACHE_MS       = 5 * 60 * 1e3;        // 5 minuti
  const MAX_CONCURRENT = 6;                   // richieste simultanee
  const TIMEOUT_MS     = 8000;                // timeout fetch 8 s
  const PAD_FACTOR     = 0.15;                // 15 % padding bbox

  const key = s => CACHE_PREFIX + s.stationId;
  const now = () => Date.now();
  const load = s => {
    try {
      const raw = localStorage.getItem(key(s));
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return (now() - obj.t < CACHE_MS) ? obj.v : null;
    } catch (_) { return null; }
  };
  const save = (s, v) => {
    try { localStorage.setItem(key(s), JSON.stringify({ t: now(), v })); } catch (_) {}
  };

  /* === Native fetch via XHR, bypassa altre patch === */
  function nativeFetch(url, opts = {}) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open(opts.method || 'GET', url, true);
      xhr.responseType = 'json';
      if (opts.headers) Object.entries(opts.headers).forEach(([k, v]) => xhr.setRequestHeader(k, v));
      const timer = setTimeout(() => { xhr.abort(); reject(new Error('timeout')); }, TIMEOUT_MS);
      xhr.onload  = () => { clearTimeout(timer);
        resolve(new Response(JSON.stringify(xhr.response), { status: xhr.status, headers: {'Content-Type':'application/json'} }));
      };
      xhr.onerror = () => { clearTimeout(timer); reject(new Error('network')); };
      xhr.send(opts.body || null);
    });
  }

  /* === Coda concorrente === */
  const queue = [];
  const scheduled = new Set();
  let running = 0;

  function worker() {
    if (running >= MAX_CONCURRENT || queue.length === 0) return;
    running++;
    const s = queue.shift();
    fetchStazione(s)
      .catch(err => console.error('WU', s.stationId, err))
      .finally(() => { running--; worker(); });
  }

  function enqueue(list) {
    list.forEach(s => {
      if (!s.apiKey || scheduled.has(s.stationId)) return;
      scheduled.add(s.stationId);
      queue.unshift(s);   // priorità alle visibili
    });
    while (running < MAX_CONCURRENT && queue.length) worker();
  }

  function fetchStazione(s) {
    const cached = load(s);
    if (cached) return Promise.resolve(cached);
    const url = `https://api.weather.com/v2/pws/observations/current?stationId=${s.stationId}&format=json&units=m&apiKey=${s.apiKey}`;
    return nativeFetch(url).then(r => r.json()).then(data => { save(s, data); return data; });
  }

  /* === Stazioni dentro bbox (con padding) === */
  function visibili() {
     const b = map.getBounds();
     const padLat = (b.getNorth() - b.getSouth()) * PAD_FACTOR;
     const padLon = (b.getEast() - b.getWest()) * PAD_FACTOR;
     const south = b.getSouth() - padLat,
           north = b.getNorth() + padLat,
           west  = b.getWest()  - padLon,
           east  = b.getEast()  + padLon;
     return window.stazioni.filter(s => s.lat>=south && s.lat<=north && s.lon>=west && s.lon<=east);
  }

  /* === Hook mappa === */
  map.whenReady(() => enqueue(visibili()));
  map.on('moveend zoomend', () => enqueue(visibili()));

  /* === Override fetch SOLO per endpoint WU, con cache/queue === */
  const origFetch = window.fetch;
  window.fetch = function(url, opts) {
    if (typeof url === 'string' && url.includes('/v2/pws/observations/current')) {
      const stationIdMatch = /stationId=([A-Z0-9]+)/i.exec(url);
      const st = stationIdMatch && window.stazioni.find(x => x.stationId === stationIdMatch[1]);
      if (st) {
        const c = load(st);
        if (c) return Promise.resolve(new Response(JSON.stringify(c), {status:200, headers:{'Content-Type':'application/json'}}));
        if (!scheduled.has(st.stationId)) {
          scheduled.add(st.stationId);
          queue.push(st);     // bassa priorità
          worker();
        }
      }
      return nativeFetch(url, opts);
    }
    return origFetch.call(this, url, opts);
  };
})();
</script>
<!-- === /WU FASTLOAD VIEWPORT PATCH === -->

<!-- ChatGPT overlay mobile v3 2025-07-07 -->
<style id="overlay-mobile-v3-css">
#screenshotOverlay{
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(6px);
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.1);
  padding:14px 16px 18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.2);
  font-family:"Helvetica Neue",Arial,sans-serif;
  z-index:9999;
  max-width:420px;
}
#screenshotOverlay .close-btn{
  position:absolute;
  top:6px;
  right:10px;
  font-size:20px;
  font-weight:bold;
  cursor:pointer;
  color:#333;
}
@media(max-width:600px){
  #screenshotOverlay{
    width:auto;
    max-height:40vh;
  }
  #screenshotOverlay div{font-size:15px;}
}
</style>
<script id="overlay-mobile-v3">
(function(){
  if(window.__overlayV3) return;
  window.__overlayV3 = true;
  const MOBILE_MAX = 650; // px
  const OFFSET_BANNER = 56; // spazio sopra toolbar Safari

  window.generaScreenshot = function(){
    const mapEl = document.getElementById('map');
    if(!mapEl) return;

    let overlay = document.getElementById('screenshotOverlay');
    if(overlay){
        overlay.remove();
        return;
    }

    overlay = document.createElement('div');
    overlay.id = 'screenshotOverlay';
    overlay.className = 'top10-overlay';

    const close = document.createElement('div');
    close.className = 'close-btn';
    close.textContent = '\u00D7';
    close.onclick = ()=>overlay.remove();
    overlay.appendChild(close);

    // contenuto
    overlay.insertAdjacentHTML('beforeend',
      (typeof buildOverlayHTML==='function' ? buildOverlayHTML() : '<div>Overlay</div>')
    );

    // calcola offset sinistro dopo sidebar
    const sidebar = document.getElementById('sidebar');
    const rect = sidebar ? sidebar.getBoundingClientRect() : {width:0,left:0};
    const leftStart = rect.width + 12;

    if(window.innerWidth <= MOBILE_MAX){
        Object.assign(overlay.style,{
           position:'fixed',
           left: leftStart+'px',
           right:'10px',
           bottom:`calc(env(safe-area-inset-bottom) + ${OFFSET_BANNER}px)`
        });
    }else{
        Object.assign(overlay.style,{
           position:'absolute',
           top:'10px',
           right:'10px'
        });
    }

    overlay.style.overflowY = 'auto';

    mapEl.appendChild(overlay);
  };
})();
</script>
<!-- /overlay mobile v3 -->


<!-- ChatGPT overlay mobile v4 2025-07-07 -->
<style id="overlay-mobile-v4-css">
#screenshotOverlay{
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(6px);
  border-radius:12px;
  border:1px solid rgba(0,0,0,0.12);
  padding:14px 16px 18px;
  box-shadow:0 8px 18px rgba(0,0,0,0.25);
  overflow-y:auto;
  z-index:9999;
}
#screenshotOverlay .close-btn{
  position:absolute;
  top:6px;
  right:10px;
  font-size:22px;
  font-weight:bold;
  cursor:pointer;
  color:#333;
}
@media (max-width:650px){
    #screenshotOverlay{
        max-height:40vh;
        max-width:420px;
        width:auto;
    }
    #screenshotOverlay div{font-size:15px;}
}
</style>

<script id="overlay-mobile-v4-js">
(function(){
  if(window.__overlayMobileV4) return;
  window.__overlayMobileV4 = true;

  const MOBILE_MAX = 650; // px
  const OFFSET_BOTTOM = 72; // spazio sopra toolbar Safari

  window.generaScreenshot = function(){
      const mapEl = document.getElementById('map');
      if(!mapEl) return;

      let overlay = document.getElementById('screenshotOverlay');
      if(overlay){
          overlay.remove();
          return;
      }

      overlay = document.createElement('div');
      overlay.id = 'screenshotOverlay';
      overlay.className = 'top10-overlay';

      // pulsante chiusura
      const close = document.createElement('div');
      close.className = 'close-btn';
      close.textContent = '\u00D7';
      close.onclick = ()=>overlay.remove();
      overlay.appendChild(close);

      // contenuto dinamico
      overlay.insertAdjacentHTML('beforeend',
          (typeof buildOverlayHTML==='function' ? buildOverlayHTML() : '<div>Overlay</div>')
      );

      // Calcolo posizionamento mobile
      if(window.innerWidth <= MOBILE_MAX){
          const sidebar = document.getElementById('sidebar');
          const rect = sidebar ? sidebar.getBoundingClientRect() : {width:0,left:0};
          const leftStart = rect.width + 12;

          // larghezza massima disponibile
          const availW = window.innerWidth - leftStart - 12;
          const cardW = Math.min(420, availW);
          Object.assign(overlay.style,{
              position:'fixed',
              left:leftStart+'px',
              width: cardW+'px',
              bottom:`calc(env(safe-area-inset-bottom) + ${OFFSET_BOTTOM}px)`
          });
      }else{
          // desktop
          Object.assign(overlay.style,{
              position:'absolute',
              top:'10px',
              right:'10px',
              maxWidth:'420px'
          });
      }

      mapEl.appendChild(overlay);
  };
})();
</script>
<!-- /overlay mobile v4 -->

<!-- ChatGPT overlay mobile v5 – 08 lug 2025 -->
<style id="overlay-mobile-v5-css">
/* eventuale ritocco cosmetic (facoltativo) */
@media (max-width:650px){
  #screenshotOverlay{
    max-width:420px !important;   /* limite hard */
  }
}
</style>

<script id="overlay-mobile-v5-js">
(() => {
  if (window.__overlayMobileV5) return;      /* patch singola */
  window.__overlayMobileV5 = true;

  const MOBILE_MAX   = 650;  /* breakpoint */
  const OFFSET_BOTTOM= 72;   /* spazio sopra la toolbar di Safari/iOS */
  const SIDE_MARGIN  = 10;   /* margine destro fisso */
  const EXTRA_MARGIN = 24;   /* margine dopo la sidebar */
  const MAX_WIDTH    = 420;  /* larghezza massima card */

  /* larghezza sidebar + margine extra */
  const leftStart = () => {
    const sb = document.getElementById('sidebar');
    return (sb ? sb.getBoundingClientRect().width : 0) + EXTRA_MARGIN;
  };

  /* **sovrascrive** la funzione già esistente */
  window.generaScreenshot = function () {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;

    /* se l’overlay è già aperto lo chiude */
    let ov = document.getElementById('screenshotOverlay');
    if (ov) { ov.remove(); return; }

    /* crea l’overlay */
    ov = document.createElement('div');
    ov.id        = 'screenshotOverlay';
    ov.className = 'top10-overlay';

    /* pulsante chiusura */
    const close = document.createElement('div');
    close.className = 'close-btn';
    close.textContent = '×';
    close.onclick = () => ov.remove();
    ov.appendChild(close);

    /* contenuto dinamico */
    ov.insertAdjacentHTML(
      'beforeend',
      typeof buildOverlayHTML === 'function' ? buildOverlayHTML() : '<div>Overlay</div>'
    );

    /* — Layout mobile — */
    if (window.innerWidth <= MOBILE_MAX) {
      const avail = window.innerWidth - leftStart() - SIDE_MARGIN;
      const w = Math.min(MAX_WIDTH, avail);

      /* posizionamento e dimensioni con !important */
      ov.style.setProperty('position', 'fixed');
      ov.style.setProperty('left',  leftStart() + 'px');
      ov.style.setProperty('right', SIDE_MARGIN + 'px');
      ov.style.setProperty('width', w + 'px', 'important');
      ov.style.setProperty('bottom',
        `calc(env(safe-area-inset-bottom) + ${OFFSET_BOTTOM}px)`
      );
    }
    /* — Layout desktop — */
    else {
      Object.assign(ov.style, {
        position : 'absolute',
        top      : '10px',
        right    : '10px',
        maxWidth : MAX_WIDTH + 'px'
      });
    }

    ov.style.overflowY = 'auto';
    mapEl.appendChild(ov);
  };
})();
</script>



<!-- === Overlay width fix with JS injection === -->
<script id="overlay-width-fix-js">
document.addEventListener('DOMContentLoaded', function() {
    var style = document.createElement('style');
    style.textContent = `
        #screenshotOverlay {
            max-width: 280px !important;
            width: auto !important;
            overflow-wrap: anywhere !important;
        }
    `;
    document.head.appendChild(style);
});
</script>

<!-- === Rain reconcile patch 2025‑07‑11 v11 (no auto‑switch, instant marker) === -->
<script id="rain_reconcile_20250711_v11">
(function(){
  if(globalThis.__rainReconcile) return;
  globalThis.__rainReconcile = true;

  const MAX_DIST_KM=7, WEIGHT=0.5, FAST=2000, SAFE=60000;
  const toRad=d=>d*Math.PI/180;
  const dist=(a,b,c,d)=>{const R=6371,dl=toRad(c-a),dn=toRad(d-b);const A=Math.sin(dl/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dn/2)**2;return 2*R*Math.asin(Math.sqrt(A));};

  const getG=()=>{try{if(typeof datiTabella==='undefined'||typeof stazioni==='undefined'||typeof markersById==='undefined')return null;return{datiTabella,stazioni,markersById};}catch(_){return null;}};

  const blend=(om,wu)=>+((om+WEIGHT*(wu-om)).toFixed(1));

  /* ---- Popup helpers ---- */
  const updatePopupRow=(popup,val)=>{
    const el=popup.getElement(); if(!el) return;
    el.querySelectorAll('.popup-data').forEach(n=>{
      if(/Pioggia:/i.test(n.textContent)){
        n.innerHTML='<span class="bold">Pioggia:</span> '+val+' mm';
      }
    });
  };
  const patchPopup=popup=>{
    const src=popup._source, sid=src&&src.stationId, g=getG(); if(!sid||!g) return;
    const r=g.datiTabella.find(x=>x.stationId===sid); if(!r) return;
    const val=Number.isFinite(+r.pioggia)?(+r.pioggia).toFixed(1):'0.0';
    updatePopupRow(popup,val);
  };

  /* ---- Reconcile ---- */
  let firstFix=false;
  const reconcile=()=>{
    const g=getG(); if(!g) return;
    const {datiTabella,stazioni,markersById}=g;

    const meta=Object.create(null);
    stazioni.forEach(s=>meta[s.stationId]=s);

    const wuRows=datiTabella.filter(r=>{const m=meta[r.stationId];return m&&!m.openMeteo&&Number.isFinite(+r.pioggia);});

    let changed=false;
    datiTabella.forEach(r=>{
      const m=meta[r.stationId]; if(!m||!m.openMeteo) return;
      if(r.__pioggiaOrig==null) r.__pioggiaOrig=Number.isFinite(+r.pioggia)?+r.pioggia:0;
      const om=r.__pioggiaOrig;

      let near=null,best=1e9;
      for(const w of wuRows){
        const wm=meta[w.stationId]; if(!wm) continue;
        const d=dist(m.lat,m.lon,wm.lat,wm.lon);
        if(d<best){best=d;near=w;}
      }
      if(!near||best>MAX_DIST_KM) return;

      const newVal=blend(om,+near.pioggia||0);
      if(newVal!==r.pioggia){r.pioggia=newVal; changed=true;}
      const mk=markersById[r.stationId];
      if(mk&&mk.options) mk.options.pioggiaFix=newVal;
    });

    if(!changed) return;
    firstFix=true;

    if(typeof aggiornaTabella==='function') aggiornaTabella();

    // if rain view is currently active, refresh markers without toggling views
    if(isRainActive() && typeof window.__rain_refreshMarkers==='function') window.__rain_refreshMarkers();

    if(typeof map!=='undefined'){
      map.eachLayer(l=>{ if(l&&l.isPopupOpen&&l.isPopupOpen()) patchPopup(l.getPopup()); });
    }
  };

  /* ---- Detect if rain view active and refresh markers ---- */
  const isRainActive = ()=> !!document.querySelector('.sidebar-btn.attivo[onclick*="visualizzaPioggia"]');

  // We'll inject a light wrapper around the original visualizzaPioggia once it's defined
  const wrapVis = ()=>{
    const fn=window.visualizzaPioggia;
    if(typeof fn!=='function' || fn.__rainWrapped) return;
    window.visualizzaPioggia=function(...a){
      reconcile();           // ensure latest numbers BEFORE drawing
      return fn.apply(this,a);
    };
    window.visualizzaPioggia.__rainWrapped=true;
    // Expose a helper to refresh markers without changing state
    window.__rain_refreshMarkers = fn.bind(window);
  };

  /* ---- Hook push only once ---- */
  const hookPush=arr=>{
    if(!Array.isArray(arr)||arr.__rainHooked) return;
    const orig=arr.push.bind(arr);
    arr.push=function(...it){const res=orig(...it);setTimeout(reconcile,0);return res;};
    arr.__rainHooked=true;
  };

  /* ---- Boot ---- */
  const boot=()=>{
    const g=getG(); if(!g){setTimeout(boot,300);return;}
    hookPush(g.datiTabella);
    reconcile();

    // wrap vis function once ready
    if(typeof window.visualizzaPioggia==='function') wrapVis();
    else{
      const tm=setInterval(()=>{
        if(typeof window.visualizzaPioggia==='function'){ clearInterval(tm); wrapVis(); }
      },200);
    }

    if(typeof map!=='undefined'){
      map.off('popupopen',globalThis.__rainPopupHook);
      globalThis.__rainPopupHook=e=>patchPopup(e.popup);
      map.on('popupopen',globalThis.__rainPopupHook);
    }

    const retry=setInterval(()=>{
      reconcile();
      if(firstFix){ clearInterval(retry); setInterval(reconcile,SAFE); }
    },FAST);
  };

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',boot);
  else boot();
})();
</script>
<!-- ===== Micro‑task booster: carica migliaia di marker a piccoli lotti ===== -->
<script>
(function () {
  if (!window.stazioni || !Array.isArray(stazioni)) return;   // sicurezza robusta

  const CHUNK_SIZE = 250;           // numero di marker per lotto
  let index = 0;

  function processBatch(deadline) {
    while (index < stazioni.length &&
          (deadline.timeRemaining() > 2 || deadline.didTimeout)) {

      const s = stazioni[index++];
      try {
        if (typeof creaMarker === 'function') {
          creaMarker(s);            // tua utility originale
        } else if (window.L && L.marker) {
          L.marker([s.lat, s.lon]).addTo(window.mymap || window.map);
        }
      } catch (e) {
        console.error('Errore marker', e);
      }
    }
    if (index < stazioni.length) {
      requestIdleCallback(processBatch, { timeout: 50 });
    } else {
      console.log('⚡ Tutti i marker creati');
      if (typeof postMarkerInit === 'function') postMarkerInit();
    }
  }

  window.addEventListener('load', function () {
    requestIdleCallback(processBatch, { timeout: 100 });
  });
})();
</script>
<!-- ======================================================================= -->
<!-- === WU CONCURRENCY PATCH 2025‑07‑13 === -->
<script id="wu_concurrency_20250713">
(function () {
  if (!window.fetch) return;
  const orig = window.fetch;
  const MAX = 4;                   // fetch in parallelo
  const q   = [];
  let run = 0;

  function next() {
    if (run >= MAX || q.length === 0) return;
    const { url, args, resolve, reject } = q.shift();
    run++;
    orig(url, ...args)
      .then(r => resolve(r))
      .catch(e => reject(e))
      .finally(() => { run--; next(); });
  }

  window.fetch = function (url, ...args) {
    if (typeof url === "string" && url.includes("/v2/pws/observations/current")) {
      return new Promise((resolve, reject) => {
        q.push({ url, args, resolve, reject });
        next();
      });
    }
    return orig(url, ...args);
  };
})();
</script>
<!-- === /WU CONCURRENCY PATCH === -->

<script id="map-loader-script">
  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('map-loader-banner');
    const mapDiv = document.getElementById('map');
    const MIN_MS = 5000;
    const start = Date.now();

    function finalizeLoad() {
      const elapsed = Date.now() - start;
      const wait = Math.max(0, MIN_MS - elapsed);
      setTimeout(() => {
        banner.classList.add('hide');
        mapDiv.classList.remove('loading');
      }, wait);
    }

    if (window.map && typeof map.whenReady === 'function') {
      map.whenReady(finalizeLoad);
    } else {
      setTimeo
<script>
window.addEventListener('load', function(){
  try{ applyOffsetsAll(); }catch(e){}
  setTimeout(applyOffsetsAll, 800);
});
</script>
ut(finalizeLoad, MIN_MS);
    }
  });
</script>


<!-- === OFFSET CORE (CHATGPT) === -->
<script>
(function(){
  if(window.__offsetCore) return; window.__offsetCore=true;

  window.stationOffsets = window.stationOffsets || {};

  const clean = s => (s||'').toString().toLowerCase().replace(/[^a-z0-9]/g,'');
  const isNum = v => typeof v==='number' && !isNaN(v);

  window.__findOff = function(row){
    const cand=[row&&row.stationId,row&&row.id,row&&row.nome].map(clean);
    const OFF = window.stationOffsets;
    for(const k in OFF){
      const lk=clean(k);
      if(cand.some(c=>c===lk || (c&&lk&&(c.includes(lk)||lk.includes(c))))) return OFF[k];
    }
    return null;
  };

  window.applyOffsetRow = function(r){
    if(!r) return;
    const of = __findOff(r);
    if(!of) return;
    function add(list,key){
      if(typeof of[key]!=='number') return;
      list.forEach(f=>{
        if(r[f]!=null && isNum(+r[f])){
          const nv = +( (+r[f]) + of[key]).toFixed(1);
          if(nv !== r[f]){ r[f]=nv; window.__changedFlag = true; }
        }
      });
    }
    add(['tempVal','temp'],'temp');
    add(['tMax','tmax'],'tmax');
    add(['tMin','tmin'],'tmin');
    add(['umidita'],'umidita');
    add(['pioggia'],'pioggia');
    add(['percepitaVal','percepita'],'percepita');
    add(['raffica'],'raffica');

    if(isNum(+r.tempVal)) r.temp = r.tempVal.toFixed(1);
    if(isNum(+r.percepitaVal)) r.percepita = r.percepitaVal.toFixed(1);

    if(window.extremiGiornalieri){
      const ext = window.extremiGiornalieri[r.stationId] = window.extremiGiornalieri[r.stationId] || {};
      if(isNum(+r.tMin)) ext.min = +r.tMin;
      if(isNum(+r.tMax)) ext.max = +r.tMax;
    }
  };

  window.applyOffsetObs = function(staz,obs){
    const of = __findOff({stationId:staz?.stationId||staz?.id, nome:staz?.nome});
    if(!of) return;
    if(isNum(+obs.temp)     && typeof of.temp ==='number') obs.temp     = +( (+obs.temp)    + of.temp ).toFixed(1);
    if(isNum(+obs.temp_max) && typeof of.tmax ==='number') obs.temp_max = +( (+obs.temp_max)+ of.tmax ).toFixed(1);
    if(isNum(+obs.temp_min) && typeof of.tmin ==='number') obs.temp_min = +( (+obs.temp_min)+ of.tmin ).toFixed(1);
  };

  window.applyOffsetsAll = function(){
    try{
      const g = window.getG && getG();
      const arr = g? g.datiTabella : window.datiTabella;
      if(Array.isArray(arr)) arr.forEach(applyOffsetRow);
    }catch(e){console.warn('applyOffsetsAll',e);}
  };

})();
</script>
<!-- === END OFFSET CORE === -->

<script>
/* force-hide loader if anything hangs */
window.addEventListener('load', function(){
  setTimeout(function(){
    var el=document.getElementById('map-loader-banner');
    if(el) el.classList.add('hide');
  }, 2000);
});
</script>

<!-- === FIX LOADER/BLUR === -->
<script>
(function(){
  function killLoader(){
    try{
      var ids=['map-loader-banner','mapLoader','loader','loading','loadingOverlay'];
      ids.forEach(function(id){ var el=document.getElementById(id); if(el) el.remove(); });
      // rimuovi classi che sfocano/disabilitano
      document.querySelectorAll('.blur,.blurred,.loading,.loading-mask').forEach(function(el){
        el.classList.remove('blur','blurred','loading','loading-mask');
        el.style.filter='';
        el.style.pointerEvents='';
        el.style.opacity='';
      });
    }catch(e){console.warn('killLoader err',e);}
  }
  window.addEventListener('load', function(){ setTimeout(killLoader, 6000); setTimeout(killLoader, 6500); });
})();
</script>
<!-- === END FIX LOADER/BLUR === -->

<!-- ===== FINAL PERF PATCH by ChatGPT (override-safe) ===== -->
<script type="module" id="perf-final">
/**
 * Obiettivo: UI fluida senza blocchi.
 * Metodo: lasciamo il codice originale, ma forniamo versioni ottimizzate delle funzioni pesanti.
 * Se qualcosa fallisce, facciamo fallback automatico all'originale.
 */

(function(){
  if(window.__perfFinalApplied__) return;
  window.__perfFinalApplied__ = true;

  // ---------- Helpers ----------
  async function chunkLoop(arr, size, fn){
    for(let i=0;i<arr.length;i++){
      fn(arr[i], i);
      if(i % size === 0){
        await new Promise(r=>requestAnimationFrame(r));
      }
    }
  }
  const queue=[]; let sch=false;
  function batchDOM(cb){
    queue.push(cb);
    if(!sch){
      sch=true;
      requestAnimationFrame(()=>{
        sch=false;
        const list = queue.splice(0);
        for(const f of list){ try{f();}catch(e){console.error(e);} }
      });
    }
  }

  function safeOverride(name, impl){
    const orig = window[name];
    if(typeof orig !== 'function'){ return; }
    window[name] = async function(...args){
      try{
        return await impl.apply(this, args);
      }catch(err){
        console.error('[perf-final] errore in', name, err);
        // fallback
        try{ return orig.apply(this, args);}catch(e){}
      }
    };
    window[name].__original = orig;
  }

  // textColor helper if missing
  if(typeof window.getTextColorForBackground !== 'function'){
    window.getTextColorForBackground = function(bg){
      if(!bg) return '#000';
      const c = bg.replace('#','');
      const r = parseInt(c.slice(0,2),16),
            g = parseInt(c.slice(2,4),16),
            b = parseInt(c.slice(4,6),16);
      const yiq = ((r*299)+(g*587)+(b*114))/1000;
      return yiq >= 128 ? '#000' : '#fff';
    };
  }

  // ---------- Overrides delle visualizzazioni ----------
  safeOverride('visualizzaAttuali', async function(){
    await chunkLoop(datiTabella, 200, (d)=>{
      const marker = markersById?.[d.stationId];
      if(!marker || isNaN(d.tempVal)) return;
      const colore = getColor(d.tempVal);
      const textColor = getTextColorForBackground(colore);
      batchDOM(()=>{
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.innerHTML = `<span style="color:${textColor};">${d.temp}°</span>`;
        el.style.backgroundColor = colore;
      });
    });
  });

  safeOverride('visualizzaPercepita', async function(){
    await chunkLoop(datiTabella, 200, (d)=>{
      const marker = markersById?.[d.stationId];
      if(!marker || isNaN(d.percepitaVal)) return;
      const colore = getColor(d.percepitaVal);
      const textColor = getTextColorForBackground(colore);
      batchDOM(()=>{
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.innerHTML = `<span style="color:${textColor};">${d.percepita}</span>`;
        el.style.backgroundColor = colore;
      });
    });
  });

  safeOverride('visualizzaUmidita', async function(){
    await chunkLoop(datiTabella, 200, (d)=>{
      const marker = markersById?.[d.stationId];
      if(!marker || isNaN(d.umidita)) return;
      const colore = getColorUmidita(d.umidita);
      const textColor = getTextColorForBackground(colore);
      batchDOM(()=>{
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.innerHTML = `<span style="color:${textColor};">${d.umidita}%</span>`;
        el.style.backgroundColor = colore;
      });
    });
  });

  safeOverride('visualizzaRaffiche', async function(){
    await chunkLoop(datiTabella, 200, (d)=>{
      const marker = markersById?.[d.stationId];
      if(!marker || isNaN(d.raffica)) return;
      const colore = getColorVento(d.raffica);
      const textColor = getTextColorForBackground(colore);
      batchDOM(()=>{
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.innerHTML = `<span style="color:${textColor};">${d.raffica}</span>`;
        el.style.backgroundColor = colore;
        el.style.width = '48px';
        el.style.height = '48px';
      });
    });
  });

  safeOverride('visualizzaEstremi', async function(tipo='max'){
    await chunkLoop(datiTabella, 200, (d)=>{
      const marker = markersById?.[d.stationId];
      if(!marker) return;
      const val = typeof getEstremoGiornaliero === 'function' ? getEstremoGiornaliero(d.stationId, tipo) : null;
      if(val==null || isNaN(val)) return;
      const colore = getColor(val);
      const textColor = getTextColorForBackground(colore);
      batchDOM(()=>{
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.innerHTML = `<span style="color:${textColor};">${val}°</span>`;
        el.style.backgroundColor = colore;
      });
    });
  });

  // ---------- caricaDatiOpenMeteo ottimizzata ----------
  safeOverride('caricaDatiOpenMeteo', async function(){
    const orig = arguments.callee.__original;
    try{
      const src = stazioni.filter(s=>s.openMeteo);
      const risultati = [];
      const maxParallel = 8;
      let idx = 0;
      async function worker(){
        while(idx < src.length){
          const st = src[idx++];
          try{
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${st.lat}&longitude=${st.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`;
            const data = await fetch(url).then(r=>r.json());
            const t = data?.current?.temperature_2m;
            const rh = data?.current?.relativehumidity_2m;
            const ws = data?.current?.wind_speed_10m;
            const perc = typeof calcolaPercepita === 'function' ? calcolaPercepita(t,rh,ws) : null;
            risultati.push({
              stationId: st.stationId,
              temp: t,
              tempVal: t,
              pioggia: data?.current?.precipitation,
              umidita: rh,
              raffica: data?.current?.wind_gusts_10m,
              percepita: (perc!=null && isFinite(perc)) ? perc.toFixed(1) : '--',
              percepitaVal: perc
            });
          }catch(e){ console.warn('OpenMeteo error', e); }
          await new Promise(r=>requestAnimationFrame(r));
        }
      }
      await Promise.all(Array.from({length: Math.min(maxParallel, src.length)}, worker));
      datiTabella.push(...risultati);
    }catch(e){
      console.error('Fallback caricaDatiOpenMeteo -> originale', e);
      return orig && orig.apply(this, arguments);
    }
  });

  console.log('[perf-final] patch attivata');
})();
</script>


<!-- === ChatGPT initial alignment patch 2025‑07‑24 === -->
<script>
(function(){
  function renderAttuali(){
     try{
       if(typeof applyOffsetsAll==='function') applyOffsetsAll();
       if(typeof visualizzaAttuali==='function') visualizzaAttuali();
     }catch(e){ console.warn('initAlign',e); }
  }
  window.addEventListener('load', function(){
     const btn = document.querySelector(".sidebar-btn[onclick*='visualizzaAttuali']");
     if(btn) btn.classList.add('attivo');

     renderAttuali();                  // prima passata

     // altri tentativi nei primi 5 secondi per catturare le stazioni che arrivano in ritardo
     let tentativi = 0;
     const timer = setInterval(function(){
        renderAttuali();
        if(++tentativi >= 5) clearInterval(timer);
     }, 1000);
  });
})();
</script>
<!-- === /ChatGPT patch === -->


<!-- === Metric popup fix 2025‑07‑24 === -->
<script id="metric_popup_fix_20250724">
(function(){
  if(globalThis.__metricPopupFix) return;
  globalThis.__metricPopupFix = true;

  function getG(){
      try{ return { datiTabella, markersById }; }catch(_){ return null; }
  }

  function fmt(v, unit){
      var n = parseFloat(v);
      return Number.isFinite(n) ? n.toFixed(1) + unit : '--';
  }

  function patchPopup(popup){
      if(!popup || typeof popup.getElement !== 'function') return;
      const g = getG(); if(!g) return;
      const sid = popup._source && popup._source.stationId;
      if(!sid) return;
      const row = g.datiTabella && g.datiTabella.find(r => r.stationId === sid);
      if(!row) return;

      const el = popup.getElement();
      el.querySelectorAll('.popup-data').forEach(n=>{
          var txt = n.textContent || '';
          if(/Temp:\s*/i.test(txt)){
              n.innerHTML = '<span class="bold">Temp:</span> ' + fmt(row.temp, '°C');
          }else if(/Umidità:/i.test(txt)){
              n.innerHTML = '<span class="bold">Umidità:</span> ' + fmt(row.umidita, '%');
          }else if(/Temp\.\s*percepita:/i.test(txt)){
              n.innerHTML = '<span class="bold">Temp. percepita:</span> ' + fmt(row.percepita, '°C');
          }
      });
  }

  function boot(){
      const m = window.map || window.mymap;
      if(!m){ setTimeout(boot, 300); return; }

      m.on('popupopen', e => patchPopup(e.popup));

      // Hook reconcile (se esiste) per aggiornare popup aperto
      const rec = window.reconcile;
      if(typeof rec === 'function' && !rec.__popupHooked){
          window.reconcile = function(...a){
              const res = rec.apply(this, a);
              if((window.map || window.mymap)?._popup) patchPopup((window.map || window.mymap)._popup);
              return res;
          };
          window.reconcile.__popupHooked = true;
      }
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
<!-- === /Metric popup fix === -->

<!-- ===== PATCH MARKER DECIMALS & OFFSET CLEAN v1 (non invasiva) ===== -->
<script>
(function(){
  const fnList = [
    'aggiungiMarker','visualizzaAttuali','visualizzaUmidita','visualizzaPercepita',
    'visualizzaRaffiche','visualizzaEstremi','visualizzaPioggia','aggiornaTabella'
  ];

  function oneDec(num){
    const v = parseFloat(String(num).replace(',', '.'));
    return Number.isFinite(v) ? v.toFixed(1) : num;
  }

  function cleanMarkerEl(el){
    if(!el) return;
    const span = el.querySelector('span');
    if(!span) return;
    const hasDegree = /°/.test(span.textContent);
    const m = span.textContent.replace(',', '.').match(/-?\d+(?:\.\d+)?/);
    if(m){
      span.textContent = oneDec(m[0]) + (hasDegree ? '°' : '');
    }
  }

  function cleanAllMarkers(){
    document.querySelectorAll('.leaflet-marker-icon').forEach(cleanMarkerEl);
  }

  // sanitize color helpers that erroneously returned "</div>" in the string
  function safeBg(el, color){
    if(!el) return;
    if(typeof color === 'string'){
      const c = color.replace(/<\/div>/gi,'').trim();
      el.style.backgroundColor = c;
    }
  }

  // hook commonly used functions to re‑clean after they run
  function wrap(name){
    const orig = window[name];
    if(typeof orig !== 'function' || orig.__oneDecWrapped) return;
    window[name] = function(){
      const res = orig.apply(this, arguments);
      // After the underlying function rendered, re‑enforce one decimal on markers
      try{ cleanAllMarkers(); }catch(e){}
      return res;
    };
    window[name].__oneDecWrapped = true;
  }

  fnList.forEach(wrap);

  // First run on DOM ready and a little later (in case markers arrive async)
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(cleanAllMarkers, 800);
    setInterval(cleanAllMarkers, 4000); // keep it clean without being heavy
  });

  // Export small utility if you want to call it manually
  window.__fixMarkersOneDecimal = cleanAllMarkers;

  // Format also the open‑meteo push so it NEVER introduces 2 decimals
  const origCarica = window.caricaDatiOpenMeteo;
  if (typeof origCarica === 'function' && !origCarica.__oneDecWrappedOM) {
    window.caricaDatiOpenMeteo = async function(){
      const res = await origCarica.apply(this, arguments);
      try {
        if(Array.isArray(window.datiTabella)){
          window.datiTabella.forEach(d=>{
            if(d && d.tempVal != null){
              const tv = parseFloat(d.tempVal);
              if(Number.isFinite(tv)){
                d.tempVal = parseFloat(tv.toFixed(1));
                d.temp = d.tempVal.toFixed(1);
              }
            }
          });
        }
        cleanAllMarkers();
      } catch(e){}
      return res;
    };
    window.caricaDatiOpenMeteo.__oneDecWrappedOM = true;
  }
})();
</script>

<!-- === ClampTemp Patch v6 – 25 Jul 2025 === -->
<script>
(function(){
  if(window.__clampTempPatchV6) return;
  window.__clampTempPatchV6 = true;

  function num(x){
    if(x==null) return NaN;
    if(typeof x==='number') return x;
    if(typeof x==='string'){
      return parseFloat(x.replace(',','.'));
    }
    return NaN;
  }

  function clampTemp(val,sid){
    let v=num(val);
    let max=num(getEstremoGiornaliero?.(sid,'max'));
    let min=num(getEstremoGiornaliero?.(sid,'min'));
    if(Number.isFinite(max) && v>max) v=max;
    if(Number.isFinite(min) && v<min) v=min;
    return v;
  }

  function clampRow(r){
    if(!r || !r.stationId) return;
    const cv=clampTemp(r.temp??r.tempVal, r.stationId);
    r.temp=cv;
    r.tempVal=cv;
  }

  function clampData(){
    if(!window.datiTabella) return;
    datiTabella.forEach(clampRow);
  }

  function syncUI(){
    if(!window.datiTabella||!window.markersById) return;
    datiTabella.forEach(r=>{
      const v=num(r.temp);
      const mk=markersById[r.stationId];
      if(mk){
        const el=mk.getElement();
        if(el){
          const span=el.querySelector('span');
          if(span) span.textContent=v.toFixed(1)+'°';
          if(window.getColor) el.style.backgroundColor=getColor(v);
        }
        const popup=mk.getPopup && mk.getPopup();
        if(popup && popup.isOpen && popup.isOpen()){
          const n=popup.getElement();
          if(n){
            [...n.querySelectorAll('.popup-data')].forEach(node=>{
              if(/Temp:/i.test(node.textContent)){
                 node.innerHTML='<span class="bold">Temp:</span> '+v.toFixed(1)+'°C';
              }else if(/Temp\. percepita:/i.test(node.textContent)){
                 // leave percepita alone
              }
            });
          }
        }
      }
      // Tabella
      const cell=document.querySelector(`[data-station-id='${r.stationId}'][data-field='temp']`);
      if(cell) cell.textContent=v.toFixed(1);
    });
  }

  function enforce(){
    clampData();
    syncUI();
  }

  function wrap(name){
    const orig=window[name];
    if(typeof orig!=='function' || orig.__clampWrapped) return;
    window[name]=function(){
      clampData();
      const res=orig.apply(this,arguments);
      syncUI();
      return res;
    };
    window[name].__clampWrapped=true;
  }

  ['visualizzaAttuali','aggiornaTabella','reconcile','applyOffsetsAll','aggiornaPopupConEstremiFinale','creaTabella'].forEach(wrap);

  document.addEventListener('DOMContentLoaded',()=>setTimeout(enforce,1000));
  setInterval(enforce,3000);
})();
</script>

<script id="block-page-pinch">
  /* Versione migliorata:
     - Intercetta qualsiasi gesto pinch (2+ dita) sull'intera pagina e
       ne blocca lo zoom di default, così la pagina non scala più.
     - Leaflet continua comunque a ricevere gli eventi touch e gestisce
       internamente lo zoom mappa, anche quando il pinch parte da un popup.
     - Copre sia Safari/iOS (gesture*) che Chrome/Android (touchmove).
  */
  (function () {
    // Per Safari / iOS
    ['gesturestart', 'gesturechange', 'gestureend'].forEach(function(ev) {
      document.addEventListener(ev, function (e) {
        e.preventDefault();
      }, { passive: false });
    });

    // Per Chrome / Android & altri: blocca default del pinch
    var cancelPinch = function (e) {
      if (e.touches && e.touches.length > 1) {
        e.preventDefault();
      }
    };
    document.addEventListener('touchmove', cancelPinch, { passive: false });

    /* Nota: Leaflet, che utilizza internamente touchstart/touchmove
       sul contenitore mappa, continua a funzionare perché riceve gli
       stessi eventi (la propagazione non viene bloccata). */
  })();
</script>

<!-- === ChatGPT precipitation & humidity offset patch 2025‑08‑05 === -->
<script id="precip_humidity_offset_patch">
(function(){
  if(window.__precipHumPatch) return;
  window.__precipHumPatch = true;

  function isNum(v){ return typeof v==='number' && !isNaN(v); }

  const origApply = window.applyOffsetRow;
  if(typeof origApply!=='function') return;

  window.applyOffsetRow = function patchedApply(r){
      if(!r) return origApply && origApply.call(this, r);

      const beforeRain = isNum(r.pioggia) ? +r.pioggia : null;
      const beforeHum  = isNum(r.umidita) ? +r.umidita : null;

      /* run original logic */
      origApply && origApply.call(this, r);

      /* --- Rain rules -------------------------------------------------- */
      if(beforeRain!=null){
         if(beforeRain <= 0.1){
            /* do NOT apply any offset if raw rain ≤0.1 mm */
            r.pioggia = parseFloat(beforeRain.toFixed(1));
         }else if(isNum(r.pioggia)){
            /* never show negative after offsets */
            if(r.pioggia < 0) r.pioggia = 0;
         }
      }

      /* --- Humidity rules --------------------------------------------- */
      if(isNum(r.umidita)){
         if(r.umidita > 100) r.umidita = 100;
         if(r.umidita < 4)   r.umidita = 4;     /* clamp lower bound */
      }
  };
})();
</script>
<!-- === /patch === -->


<!-- === ChatGPT precipitation & humidity offset patch v2 2025‑08‑05 === -->
<script id="precip_humidity_offset_patch_v2">
(function(){
  if(window.__precipHumPatchV2) return;
  window.__precipHumPatchV2 = true;

  function isNum(v){ return typeof v==='number' && !isNaN(v); }

  /* ---------- patch applyOffsetRow (if present) ------------ */
  const origApply = window.applyOffsetRow;
  if(typeof origApply==='function'){
    window.applyOffsetRow = function patchedApply(r){
        if(!r) return origApply.call(this, r);

        const rawRain = isNum(r.pioggia) ? +r.pioggia : null;
        const rawHum  = isNum(r.umidita) ? +r.umidita : null;

        /* let original code run first (offsets applied) */
        origApply.call(this, r);

        /* ------- Rain rules -------- */
        if(rawRain!=null){
           if(rawRain <= 0.1){
              r.pioggia = parseFloat(rawRain.toFixed(1));
           }else if(isNum(r.pioggia) && r.pioggia < 0){
              r.pioggia = 0;
           }
        }

        /* ------- Humidity rules ---- */
        if(isNum(r.umidita)){
           if(r.umidita > 100) r.umidita = 100;
           if(r.umidita < 4)   r.umidita = 4;
        }
    };
  }

  /* ------ Clamp existing data (already offset) ------------- */
  function clampExisting(){
     const visited = new WeakSet();
     function traverse(obj){
        if(obj===null || typeof obj!=='object' || visited.has(obj)) return;
        visited.add(obj);

        if('pioggia' in obj){
           const v = parseFloat(obj.pioggia);
           if(!isNaN(v) && v < 0) obj.pioggia = 0;
        }
        if('umidita' in obj){
           let h = parseFloat(obj.umidita);
           if(!isNaN(h)){
              if(h > 100) h = 100;
              if(h < 4)   h = 4;
              obj.umidita = h;
           }
        }

        for(const key in obj){
          traverse(obj[key]);
        }
     }

     for(const key in window){
        try{
           traverse(window[key]);
        }catch(e){}
     }
  }

  if(document.readyState === 'complete'){
     clampExisting();
  }else{
     window.addEventListener('load', clampExisting);
  }
})();
</script>
<!-- === /patch v2 === -->


<!-- MarkerCluster patch injected by ChatGPT -->
<script>
(function(){
  if (typeof L === 'undefined') return;
  function initCluster(){
    if(!window.map || typeof window.map.eachLayer!=='function') return;
    const clusterGroup = L.markerClusterGroup();
    let hasMarkers=false;
    if(Array.isArray(window.markers)){
        window.markers.forEach(m=>{clusterGroup.addLayer(m); hasMarkers=true;});
    }
    window.map.eachLayer(function(l){
        if(l instanceof L.Marker){
            clusterGroup.addLayer(l);
            hasMarkers=true;
        }
    });
    if(hasMarkers){
        window.map.addLayer(clusterGroup);
    }
  }
  if(document.readyState==='complete'){
     initCluster();
  }else{
     window.addEventListener('load', initCluster);
  }
})();
</script>

</body>







<!-- === Metric reconcile patch 2025‑07‑11 v4 === -->
<script id="metric_reconcile_20250711_v4">
(function(){
  if(globalThis.__metricReconcileV4) return;
  globalThis.__metricReconcileV4=true;

  /* ------------------ Parametri regolabili -------------------------------- */
  const MAX_DIST_KM      = 6;     // raggio max per considerare la WU
  const MAX_WU_WEIGHT    = 0.6;   // contributo massimo della WU (0‑1)
  const THR_TEMP         = 1.5;   // soglia minima di scarto per intervenire (°C)
  const THR_HUM          = 6;     // soglia umidità (%)
  const THR_EXTREMI      = 0.8;   // soglia estremi (°C)

  /* ------------------ Funzioni d'aiuto ------------------------------------ */
  const toRad=d=>d*Math.PI/180;
  const distKm=(la1,lo1,la2,lo2)=>{const R=6371,dLat=toRad(la2-la1),dLon=toRad(lo2-lo1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(la1))*Math.cos(toRad(la2))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(a));};
  const isNum=v=>Number.isFinite(v);
  const lerp=(a,b,w)=>a+w*(b-a);

  /* Jitter deterministico in base all'id stazione: restituisce -delta..+delta */
  function jitter(id, delta){
     const h=Array.from(id).reduce((s,c)=>((s<<5)-s)+c.charCodeAt(0),0);
     return ((h%100)/100 - 0.5)*2*delta;   // range [-delta, +delta]
  }

  const getG=()=>{try{return{datiTabella,stazioni}}catch(_){return null;}};

  function reconcile(){
     const g=getG(); if(!g) return;
     const {datiTabella,stazioni}=g;
     const meta=Object.create(null);
     stazioni.forEach(s=>meta[s.stationId]=s);

     const wuRows=datiTabella.filter(r=>{const m=meta[r.stationId];return m&&!m.openMeteo&&isNum(+r.tempVal);});

     let changed=false;

     datiTabella.forEach(r=>{
        const m=meta[r.stationId]; if(!m||!m.openMeteo) return;

        /* Trova WU più vicina */
        let near=null,best=Infinity;
        for(const w of wuRows){
          const wm=meta[w.stationId]; if(!wm) continue;
          const d=distKm(m.lat,m.lon,wm.lat,wm.lon);
          if(d<best){best=d;near=w;}
        }
        if(!near||best>MAX_DIST_KM) return;

        const W = MAX_WU_WEIGHT * (1 - best / MAX_DIST_KM);   // peso dinamico 0..MAX_WU_WEIGHT

        /* ---------------- Temperatura ------------------------------------ */
        const omT = +r.tempVal, wuT = +near.tempVal;
        if(isNum(omT)&&isNum(wuT)){
           if(Math.abs(omT-wuT)>=THR_TEMP){
              const newT=+lerp(omT,wuT,W).toFixed(1) + jitter(r.stationId,0.15);
              const adjT=+newT.toFixed(1);
              if(adjT!==r.tempVal){r.tempVal=adjT;r.temp=adjT.toFixed(1);changed=true;}
           }
        }else if(!isNum(omT)&&isNum(wuT)){
           /* Fallback: OM mancante -> adotta WU + jitter */
           const adj=+((wuT + jitter(r.stationId,0.25)).toFixed(1));
           if(adj!==r.tempVal){r.tempVal=adj;r.temp=adj.toFixed(1);changed=true;}
        }

        /* ---------------- Umidità ---------------------------------------- */
        const omH=+r.umidita, wuH=+near.umidita;
        if(isNum(omH)&&isNum(wuH)){
           if(Math.abs(omH-wuH)>=THR_HUM){
              const newH=Math.round(lerp(omH,wuH,W) + jitter(r.stationId,2));
              if(newH!==r.umidita){r.umidita=newH;changed=true;}
           }
        }else if(!isNum(omH)&&isNum(wuH)){
           const adj=Math.round(wuH + jitter(r.stationId,3));
           if(adj!==r.umidita){r.umidita=adj;changed=true;}
        }

        /* ---------------- Estremi giornalieri ---------------------------- */
        function adjExt(keyOM,keyWU,thr,delta){
           const om=isNum(+r[keyOM])?+r[keyOM]:null;
           const wu=isNum(+near[keyWU])?+near[keyWU]:null;
           if(wu==null) return;

           if(om!=null){
              if(Math.abs(om-wu)>=thr){
                 const val=+lerp(om,wu,W).toFixed(1)+jitter(r.stationId,delta);
                 const adj=+val.toFixed(1);
                 if(adj!==r[keyOM]){r[keyOM]=adj;changed=true;}
              }
           }else{
              const adj=+((wu + jitter(r.stationId,delta)).toFixed(1));
              if(adj!==r[keyOM]){r[keyOM]=adj;changed=true;}
           }
        }
        adjExt('tMin','tMin',THR_EXTREMI,0.15);
        adjExt('tMax','tMax',THR_EXTREMI,0.15);

        if(window.extremiGiornalieri){
           const ext=window.extremiGiornalieri[r.stationId]=window.extremiGiornalieri[r.stationId]||{};
           if(isNum(+r.tMin))ext.min=+r.tMin;
           if(isNum(+r.tMax))ext.max=+r.tMax;
        }
     
        /* === APPLY OFFSET AFTER ALIGNMENT === */
        if(window.stationOffsets){
          (function(){
            function norm(s){return (s||'').toString().trim().toLowerCase();}
            const OFF = window.stationOffsets||{};
            function isNum(v){return typeof v==='number' && !isNaN(v);}
            function findOff(r){
              const keys=[r.stationId,r.nome,(meta[r.stationId] && meta[r.stationId].nome)];
              for(const k in OFF){
                const lk=norm(k);
                for(const ky of keys){
                  if(!ky) continue;
                  const nk=norm(ky);
                  if(nk===lk || nk.includes(lk) || lk.includes(nk)) return OFF[k];
                }
              }
              return null;
            }
            const of = findOff(r);
            if(of && !r.__chatgptOff){
               function add(field,key,mirror){
                  if(r[field]!=null && isNum(+r[field]) && typeof of[key]==='number'){
                    const v = +( (+r[field]) + of[key] ).toFixed(1);
                    if(v!==r[field]){ r[field]=v; changed=true; }
                    if(mirror){ r[mirror]=typeof r[mirror]==='number'? v : v.toFixed ? v.toFixed(1):v; }
                  }
               }
               add('tempVal','temp','temp');
               add('tMax','tmax',null);
               add('tMin','tmin',null);
               add('umidita','umidita',null);
               add('pioggia','pioggia',null);
               add('percepitaVal','percepita','percepita');
               add('raffica','raffica',null);
               r.__chatgptOff=true;
               if(window.extremiGiornalieri){
                  const ext=window.extremiGiornalieri[r.stationId]=window.extremiGiornalieri[r.stationId]||{};
                  if(isNum(+r.tMin))ext.min=+r.tMin;
                  if(isNum(+r.tMax))ext.max=+r.tMax;
               }
            }
          })();
        }
        /* === END OFFSET AFTER ALIGNMENT === */

        // OFFSET finale
        applyOffsetRow(r);
});

     if(changed){
        if(typeof aggiornaTabella==='function') aggiornaTabella();
        const active=sel=>!!document.querySelector('.sidebar-btn.attivo[onclick*="'+sel+'"]');
        if(active('visualizzaAttuali')&&typeof visualizzaAttuali==='function')visualizzaAttuali();
        if(active('visualizzaUmidita')&&typeof visualizzaUmidita==='function')visualizzaUmidita();
        if(active('visualizzaEstremi')&&typeof visualizzaEstremi==='function')visualizzaEstremi();
     }
  }

  /* Hook push & render ---------------------------------------------------- */
  (function boot(){
     const g=getG(); if(!g){setTimeout(boot,300);return;}
     const {datiTabella}=g;
     if(Array.isArray(datiTabella)&&!datiTabella.__metricHooked){
        const push=datiTabella.push.bind(datiTabella);
        datiTabella.push=function(...a){const res=push(...a);setTimeout(reconcile,0);return res;};
        datiTabella.__metricHooked=true;
     }
     ['visualizzaAttuali','visualizzaUmidita','visualizzaEstremi'].forEach(fn=>{
        const f=window[fn]; if(typeof f!=='function'||f.__metricWrap) return;
        window[fn]=function(...a){reconcile();return f.apply(this,a);};
        window[fn].__metricWrap=true;
     });
     reconcile();
  })();
})();
</script>
<!-- === /Metric reconcile patch === -->

<!-- === Auto‑Repeat Display Patch – 26 Jul 2025 (incl. MM) === -->
<script id="auto-repeat-display">
(function(){
  let activeFn=null, activeArgs=[], rafId=null;

  function loop(){
    if(typeof activeFn==='function'){
      try{ activeFn.apply(window, activeArgs); }catch(e){}
      rafId = requestAnimationFrame(loop);
    }
  }

  function start(fn, args){
    activeFn = fn;
    activeArgs = args;
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(loop);
  }

  function wrap(name){
    const orig = window[name];
    if(typeof orig!=='function' || orig.__autoRepeatWrapped) return;
    window[name] = function(...args){
      const res = orig.apply(this, args);
      if(name !== 'visualizzaAttuali'){
        start(orig, args);
      } else {
        activeFn = null;
        if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
      }
      return res;
    };
    window[name].__autoRepeatWrapped = true;
  }

  function boot(){
    ['visualizzaAttuali',
     'visualizzaUmidita',
     'visualizzaPercepita',
     'visualizzaRaffiche',
     'visualizzaEstremi',
     'visualizzaPioggia'].forEach(wrap);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>

</html>
<script>
function aggiornaPopupConEstremi(marker, stazione) {
  marker.on('click', async () => {
    const stationId = stazione.stationId;
    const popup = L.popup().setLatLng([stazione.lat, stazione.lon]);
    let contenuto = `<div class='popup-title'>${stazione.nome}</div>`;

    try {
      const q = firebase.firestore().collection("osservazioni").where("stationId", "==", stationId);
      const snapshot = await q.get();
      let min = Infinity, max = -Infinity;
      let count = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        const temp = data.temperatura;
        if (typeof temp === 'number') {
          if (temp < min) min = temp;
          if (temp > max) max = temp;
          count++;
        }
      });

      contenuto += `<div class='popup-sub'>Estremi giornalieri</div>`;
      contenuto += `<div class='popup-data'>Min: <span class='bold'>${min !== Infinity ? min.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class='popup-data'>Max: <span class='bold'>${max !== -Infinity ? max.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class='popup-data'><em>Debug: ${count} valori trovati</em></div>`;
    } catch (e) {
      contenuto += `<div class='popup-data'>Errore: ${e.message}</div>`;
    }

    popup.setContent(contenuto);
    popup.openOn(mymap);
  });
}

function getColorPioggia(mm) {
  mm = parseFloat(mm);
  if (isNaN(mm) || mm === 0) return "#d5e8ff";   // very light blue
  if (mm <= 0.9)  return "#b9dbff";
  if (mm <= 2.9)  return "#9dceff";
  if (mm <= 4.9)  return "#8ac7ff";
  if (mm <= 9.9)  return "#5aa9ff";
  if (mm <= 19.9) return "#2a8cff";
  if (mm <= 29.9) return "#116dff";
  if (mm <= 49.9) return "#006fd6";
  if (mm <= 99.9) return "#004c8c";
  return "#003060"; // 100 mm +
}


function visualizzaRaffiche() {
  datiTabella.forEach((d) => {
    const marker = markersById[d.stationId];
    if (!marker) return;

    const val = parseFloat(d.raffica);
    if (!Number.isFinite(val)) return;

    const colore = (typeof getColorVento === "function")
      ? getColorVento(val)
      : val > 80 ? "#8B0000"
      : val > 60 ? "#B22222"
      : val > 40 ? "#DC143C"
      : val > 20 ? "#FF4500"
      : "#FF8C00";

    const el = marker.getElement();
    if (el) {
      el.innerHTML = `<span style='color:${getTextColorForBackground(colore)}; font-size:11px; font-weight:bold;'>${val.toFixed(0)}</span>`;
      el.style.backgroundColor = colore;
      el.style.width = "48px";
      el.style.height = "48px";
      el.style.display = "flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
    }
  });
}

</script>
(marker, stazione) {
  marker.on('click', async () =&gt; {
    const stationId = stazione.stationId;
    const popup = L.popup().setLatLng([stazione.lat, stazione.lon]);
    let contenuto = `<div class="popup-title">${stazione.nome}</div>`;

    try {
      const { min, max } = await getExtremesFromFirebase(stationId);
      contenuto += `<div class="popup-sub">Estremi giornalieri</div>`;
      contenuto += `<div class="popup-data">Min: <span class="bold">${min !== null ? min.toFixed(1) : '-' }°C</span></div>`;
      contenuto += `<div class="popup-data">Max: <span class="bold">${max !== null ? max.toFixed(1) : '-' }°C</span></div>`;
    } catch (e) {
      contenuto += `<div class="popup-data">Errore nel recupero estremi</div>`;
    }

    popup.setContent(contenuto);
    popup.openOn(mymap);
  });
}


<!-- ========= FASTLOAD PATCH 2025‑07‑24 v8.1 (fix overlay & first-zoom freeze) ========= -->
<script id="fastload_20250724_v81">
(function(){
  if (window.__fastload20250724_v81) return;
  window.__fastload20250724_v81 = true;

  const IS_MOBILE = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  const CPU = Math.max(1, navigator.hardwareConcurrency || 2);

  // Priorità WU
  const WU_MAX = Math.min(8, Math.max(2, CPU * (IS_MOBILE ? 1 : 2)));
  const OM_MAX = Math.min(6, Math.max(1, CPU - 1));

  const VISUALIZZA_DEBOUNCE = 100;
  const FETCH_TIMEOUT_MS    = 9000;

  // --- nuovo: fase di “grazia” iniziale per NON bloccare lo zoom/pan ---
  const GRACE_MS                 = 1500;     // entro questa finestra limitiamo al massimo gli aggiornamenti
  const MARKERS_PER_FRAME_GRACE  = 2;
  const MARKERS_PER_FRAME_NORMAL = IS_MOBILE ? 6 : 20;
  const MAX_VISIBLE_MOBILE       = 400;
  const MAX_VISIBLE_DESKTOP      = 1200;

  let currentGeneration = 0;
  let started = false;
  let inGrace = true;
  let graceTimer = null;
  let PAUSE_UI = false;

  // 0) Togli SUBITO l'overlay (e anche pointer-events)
  requestAnimationFrame(()=>{
    const ov = document.getElementById('overlay') || document.querySelector('#loading,.overlay,[data-overlay]');
    if (ov){
      ov.style.opacity = '0';
      ov.style.pointerEvents = 'none';
      ov.style.display = 'none';
    }
    document.documentElement.classList.add('fastload-ready');
  });

  function debounce(fn, wait, leading=false){
    let t, pendingArgs=null, pendingThis=null, invoked=false;
    const fire = ()=>{
      t=null;
      if (!leading || invoked){
        if (pendingArgs){
          fn.apply(pendingThis, pendingArgs);
          pendingArgs=pendingThis=null;
        }
        invoked=false;
      }
    };
    return function(...args){
      pendingArgs=args; pendingThis=this;
      if (!t){
        t=setTimeout(fire, wait);
        if (leading && !invoked){
          invoked=true;
          fn.apply(this, args);
        }
      }else{
        clearTimeout(t);
        t=setTimeout(fire, wait);
      }
    };
  }

  if (typeof window.visualizzaAttuali === 'function' && !window.visualizzaAttuali.__debounced_v81){
    const _orig = window.visualizzaAttuali;
    const deb = debounce(()=>{
      if (PAUSE_UI) return;
      requestAnimationFrame(_orig);
    }, VISUALIZZA_DEBOUNCE, true);
    deb.__orig = _orig;
    window.visualizzaAttuali = deb;
    window.visualizzaAttuali.__debounced_v81 = true;
  }

  // scheduler
  const MarkerScheduler = (function(){
    let queue = [];
    let running = false;
    function loop(gen){
      running = true;
      const start = performance.now();
      let count = 0;
      const BATCH = inGrace ? MARKERS_PER_FRAME_GRACE : MARKERS_PER_FRAME_NORMAL;
      while(queue.length && count < BATCH){
        if (gen !== currentGeneration){ queue = []; break; }
        const job = queue.shift();
        try{ job.fn(); }catch(e){ console.error('[v8.1] job err', e); }
        count++;
        if (performance.now() - start > 6) break;
      }
      if (queue.length && gen === currentGeneration){
        requestAnimationFrame(()=>loop(gen));
      } else {
        running = false;
      }
    }
    return {
      push(fn){
        queue.push({ fn, gen: currentGeneration });
        if (!running) requestAnimationFrame(()=>loop(currentGeneration));
      },
      clearAndBump(){
        currentGeneration++;
        queue = [];
      }
    };
  })();

  if (typeof window.aggiungiMarker === 'function' && !window.aggiungiMarker.__fastload_v81){
    const _orig = window.aggiungiMarker;
    window.aggiungiMarker = function(){
      const args = arguments;
      const gen = currentGeneration;
      MarkerScheduler.push(()=>{ if(gen === currentGeneration) _orig.apply(window, args); });
    };
    window.aggiungiMarker.__fastload_v81 = true;
  }

  function getMap(){
    return window.mymap || window.map || window.leafletMap || (window.L && window.L.map && window.L.mapInstance);
  }
  function inBounds(st, bounds){
    return st.lat >= bounds.getSouth() && st.lat <= bounds.getNorth() &&
           st.lon >= bounds.getWest()  && st.lon <= bounds.getEast();
  }
  function gridSizeForZoom(z){
    return Math.max(0.02, 1.5 * Math.pow(0.5, (z - 3) / 2));
  }
  function thinByGrid(stations, map){
    const z = map.getZoom ? map.getZoom() : 6;
    const grid = gridSizeForZoom(z);
    const buckets = new Map();
    for (const st of stations){
      const key = `${Math.round(st.lat/grid)}:${Math.round(st.lon/grid)}`;
      if (!buckets.has(key)) buckets.set(key, st);
    }
    let reduced = Array.from(buckets.values());
    const cap = IS_MOBILE ? MAX_VISIBLE_MOBILE : MAX_VISIBLE_DESKTOP;
    if (reduced.length > cap) reduced = reduced.slice(0, cap);
    return reduced;
  }

  // Worker (WU first)
  const workerCode = `
    const FETCH_TIMEOUT_MS = ${FETCH_TIMEOUT_MS};
    function withTimeout(p, ms){
      return new Promise((resolve, reject)=>{
        const t = setTimeout(()=>reject(new Error('timeout')), ms);
        p.then(v=>{ clearTimeout(t); resolve(v); },
               e=>{ clearTimeout(t); reject(e); });
      });
    }
    async function fetchJSON(url){
      const r = await withTimeout(fetch(url), FETCH_TIMEOUT_MS);
      return r.json();
    }
    async function pool(list, max, tag, makeUrl){
      const q = list.slice();
      async function worker(){
        while(q.length){
          const st = q.shift();
          try{
            const url = makeUrl(st);
            const d = await fetchJSON(url);
            postMessage({type: tag, data: { st, d }});
          }catch(e){}
          await new Promise(r=>setTimeout(r,0));
        }
      }
      await Promise.all(Array.from({length: Math.min(max, q.length)}, worker).map(f=>f()));
    }
    async function run(payload){
      const { stazioni, wuMax, omMax } = payload;
      const wu = stazioni.filter(s=>s.apiKey);
      const om = stazioni.filter(s=>s.openMeteo);

      await pool(wu, wuMax, 'wu', st =>
        \`https://api.weather.com/v2/pws/observations/current?stationId=\${st.stationId}&format=json&units=m&apiKey=\${st.apiKey}\`
      );
      await pool(om, omMax, 'om', st =>
        \`https://api.open-meteo.com/v1/forecast?latitude=\${st.lat}&longitude=\${st.lon}&current=temperature_2m,relativehumidity_2m,precipitation,wind_gusts_10m,wind_speed_10m&timezone=auto\`
      );

      postMessage({type:'done'});
    }
    onmessage = (e)=>{ if (e.data?.type==='start') run(e.data.payload); };
  `;
  const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type:'application/javascript'})));

  worker.onmessage = (e)=>{
    const { type, data } = e.data || {};
    if (type === 'wu'){
      if (typeof window.processWU === 'function'){
        const st = data.st, d = data.d;
        MarkerScheduler.push(()=>window.processWU(st, d));
      }
      if (typeof window.visualizzaAttuali === 'function') window.visualizzaAttuali();
    } else if (type === 'om'){
      const st = data.st, d = data.d;
      const t2 = d?.current?.temperature_2m;
      const rh = d?.current?.relativehumidity_2m;
      const ws = d?.current?.wind_speed_10m;
      let perc = null;
      try{ if (typeof calcolaPercepita === 'function') perc = calcolaPercepita(t2, rh, ws); }catch(_){}
      const entry = {
        stationId   : st.stationId,
        temp        : t2,
        tempVal     : t2,
        pioggia     : d?.current?.precipitation,
        umidita     : rh,
        raffica     : d?.current?.wind_gusts_10m,
        percepita   : (perc!=null && isFinite(perc)) ? perc.toFixed(1) : '--',
        percepitaVal: perc
      };
      window.datiTabella = window.datiTabella || [];
      window.datiTabella.push(entry);
      if (typeof window.visualizzaAttuali === 'function') window.visualizzaAttuali();
    } else if (type === 'done'){
      if (typeof window.visualizzaAttuali === 'function') window.visualizzaAttuali();
      console.log('[FASTLOAD v8.1] done');
    }
  };

  function bootstrap(){
    const map = getMap();
    if (!Array.isArray(window.stazioni) || !window.stazioni.length || !map || !map.getBounds){
      setTimeout(bootstrap, 100);
      return;
    }
    if (started) return;
    started = true;

    // disabilita OM legacy
    if (window.caricaDatiOpenMeteo && !window.caricaDatiOpenMeteo.__disabledBy_v81){
      const _orig = window.caricaDatiOpenMeteo;
      window.caricaDatiOpenMeteo = function(){ console.warn('[v8.1] caricaDatiOpenMeteo disabilitata (gestita dal worker)'); };
      window.caricaDatiOpenMeteo.__disabledBy_v81 = true;
      window.caricaDatiOpenMeteo.__orig = _orig;
    }

    // inizia GRACE WINDOW
    graceTimer = setTimeout(()=>{ inGrace = false; }, GRACE_MS);

    // Primo render (solo per togliere overlay e mostrare UI)
    if (typeof window.visualizzaAttuali === 'function') window.visualizzaAttuali();

    // Lancia il worker SUBITO ma con rendering ultra throttled (inGrace)
    worker.postMessage({
      type: 'start',
      payload: { stazioni: window.stazioni.slice(), wuMax: WU_MAX, omMax: OM_MAX }
    });

    // Evita il blocco iniziale allo zoom: durante lo zoom/pan metti in pausa la UI
    if (!map.__fastload_v81_bound){
      const reRender = debounce(()=>{
        MarkerScheduler.clearAndBump();
        if (typeof window.visualizzaAttuali === 'function') window.visualizzaAttuali();
      }, 80);

      map.on('movestart', ()=>{
        PAUSE_UI = true;
        MarkerScheduler.clearAndBump();
      });
      map.on('zoomstart', ()=>{
        PAUSE_UI = true;
        MarkerScheduler.clearAndBump();
      });
      map.on('moveend', ()=>{
        PAUSE_UI = false;
        reRender();
      });
      map.on('zoomend', ()=>{
        PAUSE_UI = false;
        reRender();
      });

      // Se l’utente interagisce per primo (zoom/pan), usciamo subito dalla fase grace
      const stopGraceNow = ()=>{
        if (inGrace){
          inGrace = false;
          if (graceTimer) clearTimeout(graceTimer);
        }
      };
      map.on('zoomstart', stopGraceNow);
      map.on('movestart', stopGraceNow);

      map.__fastload_v81_bound = true;
    }
  }

  function getMap(){
    return window.mymap || window.map || window.leafletMap || (window.L && window.L.map && window.L.mapInstance);
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(bootstrap, 0);
  } else {
    document.addEventListener('DOMContentLoaded', bootstrap, { once: true });
  }
})();
</script>
<!-- ========= /FASTLOAD PATCH 2025‑07‑24 v8.1 ========= -->
